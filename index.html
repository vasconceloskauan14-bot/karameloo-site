<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="icon" href="favicon.ico?v=2">
<link rel="icon" type="image/png" sizes="96x96" href="favicon.png?v=2">
<link rel="apple-touch-icon" sizes="180x180" href="favicon.png?v=2">
<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karameloo | Edição Profissional</title>
  <!-- preload handled via JS -->
<style>
    :root{
      --bg:#070b18;
      --panel:#0b1226;
      --text:#e5e7eb;
      --muted:#9ca3af;

      --accent1:#7c3aed; /* roxo */
      --accent2:#2563eb; /* azul */
      --accent3:#38bdf8; /* ciano */

      --border:rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      overflow-x:hidden;
      color-scheme: dark;
      background: #000;
      position:relative;
    }


/* ===== Fundo global do site (mesma imagem do login) ===== */
#siteBg{
  position:fixed;
  inset:0;
  z-index:-1;
  background-color:#000;
  background-image: var(--site-bg, none);
  background-size: cover;
  background-position: center;
  background-repeat:no-repeat;
  transform: scale(1.02);
  will-change: transform;
  filter: brightness(1.06) contrast(1.03) saturate(1.02);
}
#siteBg::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(1200px 700px at 30% 30%, rgba(0,0,0,.14) 0%, rgba(0,0,0,.42) 62%, rgba(0,0,0,.55) 100%),
    linear-gradient(90deg, rgba(0,0,0,.34) 0%, rgba(0,0,0,.18) 52%, rgba(0,0,0,.38) 100%);
  pointer-events:none;
}

    /* ✅ Entrada */
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      opacity:0;
      transform: translateY(8px);
      animation: pageIn .55s ease forwards;
    }
    @keyframes pageIn{to{opacity:1; transform:translateY(0)}}

    #siteHeader{
      padding:44px 18px 28px;
      background: linear-gradient(90deg,
        rgba(124,58,237,.55),
        rgba(37,99,235,.50),
        rgba(56,189,248,.25)
      );
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .wrap{max-width:1100px;margin:0 auto}
    h1{
      margin:0;
      font-size: clamp(2rem, 3.4vw, 3rem);
      letter-spacing:.3px;
    }
    .subtitle{
      margin-top:10px;
      color: rgba(229,231,235,.9);
      font-size:1.05rem;
    }

    main{padding:26px 18px 60px; position:relative;}
main > .wrap{position:relative; z-index:1;}

    .screen{display:none;opacity:0;transform: translateY(10px);}
    .screen.show{display:block;animation: screenIn .35s ease forwards;}
    @keyframes screenIn{to{opacity:1;transform:translateY(0)}}

    .hero{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 860px){ .hero{grid-template-columns:1fr} }

    /* ✅ CARD OTIMIZADO */
    .card{
      background: linear-gradient(180deg, rgba(11,18,38,.92), rgba(10,16,34,.88));
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      content-visibility: auto;
      contain-intrinsic-size: 320px 220px;
      contain: layout paint style;
    }
    .card h3{margin:0 0 8px;font-size:1.15rem;color:#c7d2fe;}
    .card p{margin:0;color:var(--muted);line-height:1.35}

    .btn{
      margin-top:14px;
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:12px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color:white;
      font-weight:700;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.04);}
    .btn:active{transform: translateY(0px); filter: brightness(.98);}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
    }
    .btn.small{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      margin-top:0;
      font-size:.95rem;
    }

    .section-title{margin:26px 0 12px; color:#c7d2fe; font-size:1.25rem;}
    .pill{display:inline-block;margin-top:6px;color:var(--muted);font-size:.95rem;}

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 620px){ .grid{grid-template-columns: 1fr;} }
    .grid .full{grid-column: 1 / -1;}

    .price{margin:10px 0 10px;font-weight:900;font-size:1.25rem;color: var(--accent3);}
    ul{margin:10px 0 0; padding-left:18px; color:#cbd5e1}
    li{margin:6px 0}

    .card.highlight{
      border:1px solid rgba(56,189,248,.35);
      box-shadow:0 12px 28px rgba(0,0,0,.38), 0 0 0 4px rgba(56,189,248,.05);
    }

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.50);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .overlay.show{display:flex; animation: fadeIn .2s ease forwards;}
    .overlay.closing{animation: fadeOut .22s ease forwards;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}

    /* ===== BETA TAB MODE (confirmação/pagamento em nova aba) ===== */
    body.betaTabMode .topbar,
    body.betaTabMode header,
    body.betaTabMode nav,
    body.betaTabMode .screen{
      display:none !important;
    }
    body.betaTabMode #betaTabRoot{
      position:fixed;
      inset:0;
      z-index:6000;
    }


    .modal{
      width:min(520px, 100%);
      background: linear-gradient(180deg, rgba(11,18,38,.95), rgba(10,16,34,.92));
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      box-shadow: 0 30px 80px rgba(0,0,0,.60);
      overflow:hidden;
      transform: translateY(10px) scale(.98);
      opacity:0;
      animation: modalIn .25s ease forwards;
    }
    .modal.closing{animation: modalOut .22s ease forwards;}
    @keyframes modalIn{to{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes modalOut{to{opacity:0;transform:translateY(8px) scale(.98)}}

    .modalHead{
      padding:16px 18px;
      background: linear-gradient(90deg, rgba(124,58,237,.72), rgba(37,99,235,.72));
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modalHead strong{font-size:1.05rem}
    .close{
      width:36px;height:36px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      background: rgba(255,255,255,.14);
      color:white;
      font-size:18px;
    }
    .modalBody{padding:18px}

    /* ===== AUTH (tela inteira) — sem scrollbar interno ===== */
    #screenAuth{
      position:fixed;
      inset:0;
      z-index:1200;
      overflow:auto;
      background: rgba(0,0,0,.35);
    }
    .authFull{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 34px 18px 70px;
    }
    .authFullCard{
      width: min(560px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(13,16,22,.94), rgba(10,12,18,.92));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .authTopBar{
      padding:16px 18px;
      background: linear-gradient(90deg, rgba(245,180,0,.85), rgba(255,204,51,.70));
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .authFullBody{ padding:18px; }
    @media (max-width: 560px){
      .authFull{ padding: 18px 12px 54px; }
      .authFullBody{ padding:16px; }
    }

    /* ✅ Mobile: evita cortar o formulário (sem mudar o visual, só permite rolagem) */
    @media (max-width: 560px){
      .modal{
        max-height: calc(100vh - 24px);
        display:flex;
        flex-direction:column;
      }
      .modalBody{
        overflow:auto;
        -webkit-overflow-scrolling: touch;
        padding:16px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
      }
    }


    /* ===== Modal: Cadastro <-> Login (animação premium) ===== */
    .authWrap{
      position:relative;
      min-height:520px;
      overflow:hidden; /* evita “vazar” durante a transição */
    }

    .authView{
      position:absolute;
      inset:0;
      opacity:0;
      transform: translateX(28px) scale(.985);
      filter: none;
      pointer-events:none;
      will-change: transform, opacity, filter;
    }

    .authView.active{
      pointer-events:auto;
      /* evita “tela preta” no celular: view ativa precisa ficar visível */
      opacity: 1;
      transform: translateX(0) scale(1);
      filter: none;
      z-index:2;
    }

    /* animações com blur + easing (bem fluida) */
    @keyframes authInRight{
      from{ opacity:0; transform: translateX(40px) scale(.98); filter: none; }
      to  { opacity:1; transform: translateX(0) scale(1);     filter: none; }
    }
    @keyframes authInLeft{
      from{ opacity:0; transform: translateX(-40px) scale(.98); filter: none; }
      to  { opacity:1; transform: translateX(0) scale(1);       filter: none; }
    }
    @keyframes authOutLeft{
      from{ opacity:1; transform: translateX(0) scale(1);       filter: none; }
      to  { opacity:0; transform: translateX(-40px) scale(.98); filter: none; }
    }
    @keyframes authOutRight{
      from{ opacity:1; transform: translateX(0) scale(1);      filter: none; }
      to  { opacity:0; transform: translateX(40px) scale(.98); filter: none; }
    }

    .authView.enterRight{ animation: authInRight .34s cubic-bezier(.16,1,.2,1) both; }
    .authView.enterLeft { animation: authInLeft  .34s cubic-bezier(.16,1,.2,1) both; }
    .authView.leaveLeft { animation: authOutLeft .30s cubic-bezier(.4,0,.2,1) both; }
    .authView.leaveRight{ animation: authOutRight .30s cubic-bezier(.4,0,.2,1) both; }



    .linkBtn{
      background:none; border:none; padding:0;
      color: rgba(56,189,248,.95);
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
    }
    .linkBtn:hover{ text-decoration:underline; }

    /* ===== Personalizado: mostrar menos/mais ===== */
    .hidden{ display:none !important; }
    .collapsed{ display:none !important; }
    .field{margin-bottom:12px}
    .field label{display:block;font-size:.88rem;color:#cbd5e1;margin:0 0 6px}

    input, textarea, select{
      width:100%;
      padding:11px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      color-scheme: dark;
    }
    textarea{min-height:96px; resize:vertical;}
    input::placeholder, textarea::placeholder{color: rgba(229,231,235,.68)}
    input:focus, textarea:focus, select:focus{border-color: rgba(56,189,248,.55)}
    select option{background: var(--panel); color: var(--text);}
    input[type="date"]::-webkit-datetime-edit{ color: var(--text); }
    input[type="date"]::-webkit-calendar-picker-indicator{filter: invert(1);opacity:.85;cursor:pointer;}
    .hint{color:var(--muted); font-size:.9rem; margin-top:10px}

    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tier-toggle{display:flex; gap:8px; align-items:center; justify-content:flex-end; padding:6px; border-radius:14px;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08)}
    .tier-btn{appearance:none; border:1px solid rgba(255,255,255,.16); background:rgba(8,12,24,.38); color:rgba(255,255,255,.92);
      padding:10px 12px; border-radius:12px; font-weight:800; letter-spacing:.2px; cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
      min-width:110px; text-align:center}
    .tier-btn:hover{transform:translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.35); border-color:rgba(255,209,57,.35)}
    .tier-btn:active{transform:translateY(0px) scale(.99)}
    .tier-btn.is-active{background:linear-gradient(180deg, rgba(255,199,0,.98), rgba(255,167,0,.92));
      color:#141414; border-color:rgba(0,0,0,.25); box-shadow:0 14px 34px rgba(255,182,0,.18)}
    .tier-btn.is-active:hover{border-color:rgba(0,0,0,.25)}
    
    .mini label{display:block;font-size:.88rem;color:#cbd5e1;margin:0 0 6px}

    .checks{display:grid;gap:8px}
    .chk{display:flex;gap:10px;align-items:center;color:#cbd5e1;font-size:.95rem}
    .chk input{width:auto;margin:0}

    /* --- Personalizado: separar Vídeo / Foto (sem mostrar preços) --- */
    .customGroup{padding:8px 10px;border-radius:14px;border:1px solid rgba(255,215,0,.10);background:rgba(255,215,0,.03)}
    .customGroupTitle{font-weight:800;letter-spacing:.2px;color:#f8fafc;font-size:.95rem;margin:2px 0 8px;opacity:.95}
    .customGroupGrid{display:grid;gap:8px}
    @media (min-width: 860px){
      .customGroupGrid{grid-template-columns:1fr 1fr}
    }


    .total-box{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(56,189,248,.22);
      background: rgba(56,189,248,.06);
    }
    .total-line{display:flex;justify-content:space-between;align-items:center}
    .total-line strong{font-size:1.25rem;color:var(--accent3)}
    .total-sub{margin-top:6px;color:var(--muted);font-size:.95rem}

    footer{padding:18px;color:rgba(229,231,235,.7);text-align:center;}

    /* ✅ MODO LEVE AUTOMÁTICO */
    @media (prefers-reduced-motion: reduce){
      .orb, .sparkles{ animation: none !important; }
    }
    @media (max-width: 900px){
    }

    /* ===== Avatares + Estrelas ===== */
    .who{
      display:flex; align-items:center; gap:10px;
      margin-top:10px;
    }
    .avatar{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(circle at 30% 30%, rgba(56,189,248,.55), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(124,58,237,.55), transparent 55%),
        rgba(255,255,255,.06);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      overflow:hidden;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:rgba(229,231,235,.92);
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block;}
    .who .meta{display:flex;flex-direction:column;gap:2px}
    .stars{
      display:inline-flex; gap:3px; align-items:center;
      font-size:14px;
      letter-spacing:.2px;
      flex-wrap:wrap;
      max-width: 100%;
    }
    .star{
      color: rgba(56,189,248,.95);
      text-shadow: 0 0 10px rgba(56,189,248,.25);
    }
    .star.off{
      color: rgba(229,231,235,.28);
      text-shadow:none;
    }
    .stars small{
      color: rgba(229,231,235,.70);
      margin-left:8px;
      font-size:.9rem;
      font-weight:700;
    }

    /* ===== B: Seleção de Editores (Cliente) ===== */
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top:12px;
    }
    .toolbar .left, .toolbar .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      font-size:.92rem;
    }
    .editor-cards{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px;align-items:stretch}
@media (max-width:1200px){.editor-cards{grid-template-columns:repeat(4,minmax(160px,1fr));}}
@media (max-width:960px){.editor-cards{grid-template-columns:repeat(3,minmax(160px,1fr));}}
@media (max-width:720px){.editor-cards{grid-template-columns:repeat(2,minmax(160px,1fr));}}
@media (max-width:520px){.editor-cards{grid-template-columns:repeat(1,minmax(160px,1fr));}}

/* ===== Editor → Clientes (grid 4 por linha) ===== */
#exploreClientsGrid{grid-template-columns:repeat(4,minmax(160px,1fr));}
@media (max-width:960px){#exploreClientsGrid{grid-template-columns:repeat(3,minmax(160px,1fr));}}
@media (max-width:720px){#exploreClientsGrid{grid-template-columns:repeat(2,minmax(160px,1fr));}}
@media (max-width:520px){#exploreClientsGrid{grid-template-columns:repeat(1,minmax(160px,1fr));}}


    .eCard{display:flex;flex-direction:column;height:100%;
      background: linear-gradient(180deg, rgba(11,18,38,.92), rgba(10,16,34,.88));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      content-visibility:auto;
      contain-intrinsic-size: 320px 280px;
      contain: layout paint style;
    }
    .eTop{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .eName{font-weight:900; color:#e5e7eb; font-size:1.05rem}
    .eMeta{color:rgba(229,231,235,.70); font-size:.92rem; margin-top:4px}
    .eBio{margin-top:10px;color:rgba(156,163,175,.95);line-height:1.35;font-size:.95rem;}
    .eBadges{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      font-size:.9rem;
    }
    .badge.pillBlue{border-color: rgba(124,58,237,.30);background: rgba(124,58,237,.10);}
    .badge.you{border-color: rgba(56,189,248,.30);background: rgba(56,189,248,.10);}
    .badge.off{opacity:.6}

    /* ===== Editor Dashboard ===== */
    .editor-grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width: 860px){ .editor-grid{grid-template-columns:1fr;} }

    .kpi{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .kpi .k{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius:14px;
      padding:10px;
      min-height:66px;
    }
    .k .t{color:rgba(229,231,235,.72); font-size:.85rem}
    .k .v{font-weight:900; margin-top:6px; font-size:1.05rem; color:#c7d2fe}
    .k .v small{font-weight:700; color:rgba(229,231,235,.75); font-size:.9rem}

    .row-inline{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }

    .switch{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      user-select:none;
    }
    .switch input{ display:none; }
    .track{
      width:44px; height:24px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      position:relative;
      transition: .15s ease;
      flex:0 0 auto;
    }
    .thumb{
      width:18px; height:18px; border-radius:50%;
      position:absolute; top:50%; transform: translateY(-50%);
      left:3px;
      background: rgba(229,231,235,.85);
      transition: .15s ease;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }
    .switch input:checked + .track{
      background: rgba(56,189,248,.16);
      border-color: rgba(56,189,248,.35);
    }
    .switch input:checked + .track .thumb{
      left:23px;
      background: rgba(56,189,248,.95);
      box-shadow: 0 0 16px rgba(56,189,248,.35);
    }
    .switch .label{
      color:#e5e7eb; font-weight:800; font-size:.95rem;
    }
    .switch .sub{
      color:rgba(229,231,235,.72); font-size:.85rem; margin-top:2px;
    }

    .tags{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:8px;
    }
    .tag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      font-size:.88rem;
    }
    .tag.blue{
      border-color: rgba(56,189,248,.25);
      background: rgba(56,189,248,.08);
    }

    .pkg-list{display:grid; gap:10px; margin-top:10px;}

    /* ✅ THUMB (preenche o vazio) + layout */
    .pkg-item{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:14px;
      align-items:start;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .pkg-thumb{
      width:88px;
      height:88px;
      border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(56,189,248,.35), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(124,58,237,.35), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      flex-shrink:0;
    }
    .pkg-item input{ margin-top:4px; width:auto; }
    .pkg-title{ font-weight:900; color:#e5e7eb }
    .pkg-sub{ color:rgba(229,231,235,.72); font-size:.92rem; margin-top:2px }
    .pkg-meta{ color:rgba(156,163,175,.92); font-size:.9rem; margin-top:6px }

    .uploadRow{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      margin-top:10px;
    }
    .uploadRow .avatar{width:56px;height:56px}

    /* “Ver mais” centralizado */
    .moreRow{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }

    /* ====== ENTRADA (START) MAIS GRANDE / PREMIUM ====== */
    .wrap{ max-width: 1200px; }

    #siteHeader{
      padding: 78px 18px 56px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }

    h1{
      font-size: clamp(2.8rem, 5.2vw, 4.2rem);
      letter-spacing: .4px;
    }

    .subtitle{
      margin-top: 14px;
      font-size: 1.18rem;
      max-width: 760px;
      line-height: 1.35;
      color: rgba(229,231,235,.92);
    }

    #screenStart .hero{
      margin-top: 18px;
      position: relative;
    }
    #screenStart .hero::before{
      content:"";
      position:absolute;
      inset: -26px -18px -26px -18px;
      border-radius: 26px;
      background:
        radial-gradient(900px 420px at 20% 0%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 420px at 80% 0%, rgba(56,189,248,.14), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
      z-index:0;
    }
    #screenStart .hero > *{ position:relative; z-index:1; }

    .startCard{
      padding: 22px 22px 20px;
      border-radius: 22px;
      min-height: 220px;
    }
    .startCard h3{
      font-size: 1.35rem;
      margin-bottom: 10px;
    }
    .startCard p{
      font-size: 1.05rem;
      line-height: 1.45;
    }
    .startCard .btn{
      margin-top: 18px;
      padding: 14px 16px;
      border-radius: 18px;
      font-size: 1.05rem;
    }

    main{ padding: 34px 18px 70px; }

    @media (max-width: 860px){
      #siteHeader{ padding: 62px 16px 46px; }
      h1{ font-size: clamp(2.4rem, 9vw, 3.3rem); }
      .subtitle{ font-size: 1.06rem; }
      .startCard{ min-height: 210px; }
    }
  

    /* ====== START PRO (Entrada Premium) ====== */
    .startPro{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      align-items:start;
      margin-top:18px;
    }
    .startCopy{padding:6px 2px}
    .startBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(229,231,235,.92);
      font-weight:900;
      letter-spacing:.2px;
      width: fit-content;
    }
    .startTitle{
      margin:14px 0 0;
      font-size: clamp(1.9rem, 3.6vw, 2.7rem);
      line-height:1.08;
      letter-spacing:.2px;
    }
    .startDesc{
      margin:10px 0 0;
      color: rgba(229,231,235,.86);
      font-size:1.05rem;
      max-width:56ch;
      line-height:1.4;
    }
    .startChips{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .startChip{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(229,231,235,.9);
      font-size:.95rem;
    }
    .startChip strong{color:#e5e7eb;font-weight:900}

    .startMini{margin-top:16px;display:grid;gap:10px}
    .miniCard{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
    }
    .miniIco{
      width:38px;height:38px;
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg, rgba(124,58,237,.22), rgba(56,189,248,.14));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      flex:0 0 auto;
    }
    .miniT{font-weight:900;color:#c7d2fe}
    .miniP{margin-top:4px;color:rgba(156,163,175,.95);font-size:.95rem;line-height:1.35}

    .startNote{margin-top:14px;color:rgba(229,231,235,.65);font-size:.92rem}

    .startRoles{display:grid;gap:14px}
    .roleCardPro{
      background: linear-gradient(180deg, rgba(11,18,38,.92), rgba(10,16,34,.88));
      border:1px solid rgba(255,255,255,.12);
      border-radius:20px;
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.38);
    }
    .roleTop{display:flex;gap:12px;align-items:center}
    .roleIco{
      width:46px;height:46px;
      border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg, rgba(124,58,237,.25), rgba(37,99,235,.18));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 26px rgba(0,0,0,.32);
    }
    .roleT{font-weight:1000;font-size:1.15rem;color:#e5e7eb}
    .roleS{margin-top:4px;color:rgba(229,231,235,.72);font-size:.95rem}
    .roleList{margin:10px 0 0;padding-left:18px;color:#cbd5e1}
    .roleList li{margin:6px 0}

    .startActions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .startActions .btn{ padding:12px 14px; border-radius:14px; font-size:1rem; }

    .exploreBar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .exploreBar input{ flex:1; min-width:240px; }

    .chipsRow{display:flex; gap:8px; flex-wrap:wrap;}
    .chipBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      font-size:.92rem;
      font-weight:800;
      cursor:pointer;
      transition: .15s ease;
    }
    .chipBtn:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.22); }
    .chipBtn.active{
      border-color: rgba(56,189,248,.40);
      background: rgba(56,189,248,.14);
      color: rgba(229,231,235,.96);
    }



    @media (max-width: 860px){
      .startPro{grid-template-columns:1fr;margin-top:10px}
      .startCopy{padding:0}
    }

    /* ✅ Ajustes Mobile (entrada mais compacta e premium) */
    @media (max-width: 620px){
      #siteHeader{ padding: 54px 16px 36px; }
      h1{ font-size: clamp(2.2rem, 10vw, 3rem); }
      .subtitle{ font-size: 1.03rem; }
      main{ padding: 26px 16px 66px; }
      .startTitle{ font-size: clamp(1.85rem, 8.4vw, 2.45rem); }
      .startChip{ font-size:.92rem; padding:8px 10px; }
      .roleCardPro{ padding:14px; }
    }

  

    /* ===== FIX: Modal scroll no celular + botao Continuar grande ===== */
    .modal{ max-height: calc(100vh - 24px); }
    .modalBody{ max-height: calc(100vh - 110px); overflow:auto; -webkit-overflow-scrolling:touch; padding-bottom:22px; }
    #btnCadastrar, #btnLogin{ min-height:56px; font-size:1.05rem; }
    .authLinks{ margin-bottom:10px; }
    @media (max-width: 620px){
      .authWrap{ min-height:unset; }
    }

    /* ===== Portfólio do Editor (até 30 fotos / 10 vídeos) ===== */
    .work-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px; }
    @media (max-width: 620px){ .work-grid{ grid-template-columns: repeat(2, 1fr);} }
    .work-item{ aspect-ratio: 1 / 1; border-radius:14px; overflow:hidden; border:1px solid var(--border); background: rgba(0,0,0,.03); }
    .work-item img, .work-item video{ width:100%; height:100%; object-fit:cover; display:block; }

    

    /* ===== TEMA DARK (tons de amarelo + bordas com detalhes) ===== */
    :root{
      --bg:#07070a;
      --panel:#0d1016;
      --text:#f7f8fb;
      --muted:#a6afbd;

      /* amarelo vivo (sem brilho estourado) */
      --accent1:#f5b400;
      --accent2:#ffcc33;
      --accent3:#ffe08a;

      --border:rgba(255,255,255,.16);
      --edge:rgba(245,180,0,.28);
    }
    body{ color-scheme: dark; background: var(--bg); }

    /* fundo dark com detalhes dourados (sem brilho) */
    #siteHeader{
      background: linear-gradient(90deg, rgba(245,180,0,.34), rgba(255,204,51,.22), rgba(255,224,138,.16));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    header .subtitle{ color: rgba(247,248,251,.78); }
    header h1{ color: rgba(247,248,251,.98); }
/* cards/painéis */
    .card, .eCard{
      position:relative;
      background: linear-gradient(180deg, rgba(13,16,22,.88), rgba(10,12,18,.86));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
    }
    /* detalhe de borda (amarelo discreto) */
    .card::before, .eCard::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: inherit;
      pointer-events:none;
      background: linear-gradient(135deg, rgba(245,180,0,.22), rgba(255,204,51,.10), rgba(255,224,138,.06));
      opacity:.42;
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding:1px;
    }

    .card.highlight{
      background: linear-gradient(180deg, rgba(16,18,26,.92), rgba(10,12,18,.88));
      border-color: rgba(245,180,0,.22);
      box-shadow: 0 18px 42px rgba(0,0,0,.32);
    }
    .total-box{ border-color: rgba(245,180,0,.22); background: rgba(245,180,0,.06); }

    .card h3{ color: rgba(255,224,138,.92); }
    .section-title{ color: rgba(255,224,138,.92); }
    .pill{ color: rgba(247,248,251,.82); }
    .price{ color: rgba(255,204,51,.98); }

    /* entrada */
    .startBadge{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.90);
    }
    .startBadge::after{ content:none; }
    .startNote{ color: rgba(247,248,251,.74); }
    .miniP{ color: rgba(247,248,251,.76); }

    .subtitle{ color: rgba(247,248,251,.84); }
    .startTitle{ color: var(--text); }
    .startDesc{ color: rgba(247,248,251,.78); }
    .startChip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.90);
    }
    .startChip strong{ color: rgba(255,224,138,.95); }
    .miniCard{ border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.02); }
    .miniT{ color: rgba(255,224,138,.92); }
    .miniS{ color: rgba(247,248,251,.74); }

    /* textos internos */
    .chk{ color: rgba(247,248,251,.82); }
    .card ul, .card li{ color: rgba(247,248,251,.80); }
    .k .t{ color: rgba(247,248,251,.70); }
    .k .v{ color: rgba(255,224,138,.92); }
    .k .v small{ color: rgba(247,248,251,.65); }
    .eName{ color: rgba(247,248,251,.96); }
    .eMeta{ color: rgba(247,248,251,.72); }
    .eBio{ color: rgba(247,248,251,.76); }
    .pkg-sub{ color: rgba(247,248,251,.74); }
    .pkg-meta{ color: rgba(247,248,251,.66); }

    input, textarea, select{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      color-scheme: dark;
    }
    input::placeholder, textarea::placeholder{ color: rgba(247,248,251,.48); }
    input:focus, textarea:focus, select:focus{ border-color: rgba(245,180,0,.55); }
    select option{ background: #0b0e14; color: var(--text); }
    input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1); opacity:.72; }

    .btn{
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color:#0b0e14;
      box-shadow: 0 12px 26px rgba(245,180,0,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
    }

    .modal{
      background: linear-gradient(180deg, rgba(13,16,22,.94), rgba(10,12,18,.92));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
    }
    .modalHead{ background: linear-gradient(90deg, rgba(245,180,0,.85), rgba(255,204,51,.70)); }
    .close{ background: rgba(255,255,255,.06); color: rgba(247,248,251,.92); }
    .overlay{ background: rgba(0,0,0,.55); }

    .avatar{
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,224,138,.20), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(245,180,0,.16), transparent 55%),
        rgba(255,255,255,.02);
      box-shadow: 0 12px 30px rgba(0,0,0,.32);
      color: rgba(247,248,251,.92);
    }
    .star{ color: rgba(255,204,51,.98); text-shadow: none; }
    .star.off{ color: rgba(247,248,251,.22); text-shadow:none; }

    .badge.pillBlue{ border-color: rgba(245,180,0,.30); background: rgba(245,180,0,.10); }
    .badge.you{ border-color: rgba(255,224,138,.28); background: rgba(255,224,138,.10); }

    .chip{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); color: rgba(247,248,251,.90); }
    .switch{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); }
    .track{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); }
    .switch input:checked + .track{ background: rgba(245,180,0,.18); border-color: rgba(245,180,0,.35); }
    .switch input:checked + .track .thumb{ background: rgba(245,180,0,.95); box-shadow: none; }

    footer{ color: rgba(247,248,251,.55); }

    /* ===== EXPLORAR (estilo marketplace tipo Fiverr) ===== */
    .marketTop{
      display:flex; align-items:center; gap:12px;
      padding: 6px 2px 10px;
      position:sticky; top:0;
      backdrop-filter: none;
      background: rgba(7,7,10,.70);
      border-bottom:1px solid rgba(255,255,255,.08);
      z-index:5;
    }
    .marketLogo{
      font-weight:1000; letter-spacing:.2px;
      font-size: 1.1rem;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      color: var(--text);
      user-select:none;
    }
    .marketLogo b{ color: var(--accent2); }

    .marketSearch{
      flex:1;
      display:flex; align-items:center; gap:10px;
      min-width: 260px;
    }
    .marketSearch input{
      flex:1;
      padding:12px 14px;
      border-radius: 999px;
    }
    .marketSearchBtn{
      height:44px; min-width:44px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.92);
      cursor:pointer;
      font-size: 1.05rem;
    }

    .marketActions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .marketSort{
      height:44px;
      border-radius: 999px;
      padding: 10px 12px;
      min-width: 190px;
    }
    .iconBtn{
      height:44px; min-width:44px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.92);
      cursor:pointer;
      font-weight:900;
    }

    .marketCats{
      display:flex; gap:10px;
      overflow:auto;
      padding: 10px 2px 2px;
      scrollbar-width: none;
    }
    .marketCats::-webkit-scrollbar{ display:none; }
    .catBtn{
      white-space: nowrap;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.88);
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:.95rem;
    }
    .catBtn.active{ border-color: rgba(245,180,0,.35); background: rgba(245,180,0,.10); color: rgba(255,224,138,.95); }

    .marketWelcome{ margin-top:14px; }
    .marketWelcomeTitle{ font-size: clamp(1.6rem, 4.2vw, 2.25rem); font-weight:1000; }
    .marketWelcomeSub{ margin-top:6px; color: rgba(247,248,251,.78); }

    .marketPromo{
      margin-top:14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
      padding:14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }
    .promoLeft{ display:flex; gap:12px; align-items:center; }
    .promoIcon{
      width:44px; height:44px; border-radius:14px;
      display:grid; place-items:center;
      background: rgba(245,180,0,.12);
      border:1px solid rgba(245,180,0,.22);
      color: rgba(255,224,138,.98);
      font-size: 1.1rem;
      font-weight:1000;
    }
    .promoTitle{ font-weight:1000; }
    .promoSub{ color: rgba(247,248,251,.72); margin-top:2px; font-size:.95rem; }

    .marketSection{ margin-top:18px; }
    .secHead{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .secTitle{ font-weight:1000; font-size:1.15rem; }
    .secBtn{
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.92);
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
    }

    .hScroll{
      margin-top:12px;
      display:flex; gap:12px;
      overflow:auto;
      padding-bottom: 4px;
      scrollbar-width:none;
    }
    .hScroll::-webkit-scrollbar{ display:none; }

    .miniGig{
      width: min(280px, 72vw);
      flex: 0 0 auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(13,16,22,.90);
      overflow:hidden;
      cursor:pointer;
      position:relative;
    }
    .miniGig::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, transparent 38%, rgba(0,0,0,.55));
      pointer-events:none;
    }
    .miniGig .thumb{
      height: 138px;
      background:
        radial-gradient(120px 90px at 30% 30%, rgba(245,180,0,.22), transparent 60%),
        radial-gradient(120px 90px at 70% 60%, rgba(255,224,138,.14), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .miniGig .info{
      position:absolute; left:12px; right:12px; bottom:12px;
      z-index:1;
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
    }
    .miniGig .whoMini{ display:flex; gap:10px; align-items:center; }
    .miniGig .avMini{ width:38px; height:38px; border-radius: 18px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); display:grid; place-items:center; font-weight:1000; }
    .miniGig .nm{ font-weight:1000; }
    .miniGig .mt{ font-size:.9rem; color: rgba(247,248,251,.74); margin-top:2px; }

    .marketChips{ margin-top:12px; }

    /* ===== IA Karameloo (Cliente + Editor) ===== */
    .aiFab{
      position:fixed;
      right:18px;
      bottom:18px;
      z-index:1400;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border:none;
      border-radius:999px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color:#0b0e14;
      font-weight:1000;
      box-shadow: 0 16px 36px rgba(245,180,0,.20);
    }
    .aiFab .dot{ width:10px;height:10px;border-radius:50%; background: rgba(0,0,0,.75); box-shadow:none; }
    .aiPanel{
      position:fixed;
      right:18px;
      bottom:78px;
      width:min(420px, calc(100vw - 36px));
      max-height: min(70vh, 620px);
      display:none;
      flex-direction:column;
      background: linear-gradient(180deg, rgba(13,16,22,.96), rgba(10,12,18,.94));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
      z-index:1400;
    }
    .aiPanel.show{ display:flex; }
    .aiHead{
      padding:14px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: linear-gradient(90deg, rgba(245,180,0,.80), rgba(255,204,51,.62));
      border-bottom:1px solid rgba(255,255,255,.16);
    }
    .aiTitle{ font-weight:1000; color:#0b0e14; }
    .aiSub{ font-size:.9rem; color: rgba(0,0,0,.70); margin-top:2px; }
    .aiClose{
      width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(0,0,0,.20);
      background: rgba(255,255,255,.18);
      cursor:pointer;
      font-weight:900;
      color:#0b0e14;
    }
    .aiChips{ padding:10px 14px; display:flex; flex-wrap:wrap; gap:8px; }
    .aiChips button{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.92);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      font-size:.92rem;
    }
    .aiMsgs{ padding: 4px 14px 12px; overflow:auto; flex:1; display:grid; gap:10px; }
    .aiMsg{ padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.03); color: rgba(247,248,251,.92); line-height:1.35; }
    .aiMsg.me{ background: rgba(245,180,0,.10); border-color: rgba(245,180,0,.22); }
    .aiForm{ display:flex; gap:10px; padding: 12px 14px 14px; border-top:1px solid rgba(255,255,255,.16); }
    .aiInput{ flex:1; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); }
    .aiSend{ padding:12px 14px; border:none; border-radius:12px; font-weight:1000; cursor:pointer; background: linear-gradient(90deg, var(--accent1), var(--accent2)); color:#0b0e14; }
    @media (max-width: 620px){
      .aiFab{ right:12px; bottom:12px; }
      .aiPanel{ left:12px; right:12px; width:auto; }
      .marketSort{ min-width: 160px; }
    }


    /* ===== KARAMELoo MENU + CAPAS + THUMBS ===== */
    .profileCover{
      height:120px;
      border-radius:18px;
      margin:-2px -2px 14px;
      border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(1200px 220px at 20% 0%, rgba(255,224,138,.20), transparent 60%),
                  radial-gradient(900px 240px at 80% 20%, rgba(255,193,61,.18), transparent 55%),
                  linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      background-size: cover;
      background-position:center;
      overflow:hidden;
    }
    .profileCover::after{
      content:'';
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.42));
      opacity:.85;
    }
    .profileCover{ position:relative; }

    .eThumb{
      height:110px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(255,224,138,.18), transparent 60%),
        radial-gradient(800px 240px at 80% 20%, rgba(255,193,61,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      background-size: cover;
      background-position:center;
      margin-bottom:12px;
      overflow:hidden;
    }

    .pkgThumb{
  height:86px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.16);
  background-image:
    var(--pkgthumb, radial-gradient(900px 240px at 20% 0%, rgba(255,224,138,.14), transparent 55%),
      radial-gradient(800px 240px at 80% 20%, rgba(255,193,61,.12), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02))),
    var(--pkgpattern, none);
  background-size: cover, auto;
  background-position: center, center;
  margin-bottom:10px;
}

    #menuBody .menuList{ display:grid; gap:10px; }
    .menuBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
    transition: transform .18s cubic-bezier(.16,1,.2,1), background .18s ease, border-color .18s ease, box-shadow .18s ease, filter .18s ease;
    will-change: transform;
  
  }
    .menuBtn:hover{ filter: brightness(1.05); }
    .menuBtn small{ opacity:.75; font-weight:800; }
    .menuDanger{ border-color: rgba(255,120,120,.32); background: rgba(255,120,120,.08); }
    .menuBack{
      display:inline-flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .noteWarn{
      border:1px solid rgba(255,193,61,.26);
      background: rgba(255,193,61,.08);
      border-radius:14px;
      padding:10px 12px;
      color: rgba(255,255,255,.90);
      margin-top:10px;
    }

    @media (max-width:520px){
      .profileCover{ height:100px; }
      .eThumb{ height:96px; }
    }



    /* Preview grande (Editor) */
    .previewLarge{display:block;}
    .previewLarge .previewCard{max-width:100%; width:100%; content-visibility:visible; contain:none;}
    #edPublicPreview{min-height:210px;}

    /* Animação de troca no menu */
    #menuBody.swap{ animation: menuSwap .28s ease; }
    @keyframes menuSwap{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform: translateY(0);} }

    /* IA: clique + abrir */
    .aiFab.kick{ animation: aiKick .38s ease; }
    @keyframes aiKick{ 0%{ transform: translateY(0) scale(1);} 40%{ transform: translateY(-6px) scale(1.02);} 100%{ transform: translateY(0) scale(1);} }
    .aiPanel.pop{ animation: aiPop .22s ease; }
    @keyframes aiPop{ from{ opacity:0; transform: translateY(10px) scale(.98);} to{ opacity:1; transform: translateY(0) scale(1);} }

  

    .eActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:auto;padding-top:12px}

    /* ===== LOGIN HERO (novo START igual ao modelo) ===== */
#siteHeader{ display:none !important; }

#screenStart.show{
  position:fixed;
  inset:0;
  z-index:1500;
  padding:0 !important;
  margin:0 !important;
  transform:none;
  opacity:1;
  animation:none;
}


/* ===== START (Login) — trava scroll e esconde widgets ===== */
body.startActive{
  overflow:hidden !important;
}
body.startActive #app > footer{
  display:none !important;
}
body.startActive .aiFab,
body.startActive .aiPanel,
body.startActive .chatFab,
body.startActive #chatModal{
  display:none !important;
}


.loginScene{
  position:absolute;
  inset:0;
  background-color:#000; /* evita flash/transparência antes da imagem carregar */
  background-image: var(--login-bg, none);
  background-size: cover;
  background-position: center;
  display:flex;
  align-items:stretch;
  justify-content:center;
}
.loginScene::before{
  content:"";
  position:absolute;
  inset:0;
  z-index:0;
  background:
    linear-gradient(90deg, rgba(0,0,0,.50) 0%, rgba(0,0,0,.32) 52%, rgba(0,0,0,.55) 100%);
}
.loginInner{
  position:relative;
  z-index:1;
  width:min(1120px, 100%);
  margin:auto;
  display:grid;
  grid-template-columns: 1.1fr .9fr;
  gap: 34px;
  padding: 54px 22px;
  align-items:center;
}

.loginCredit{
  position:absolute;
  left:0; right:0;
  bottom:18px;
  text-align:center;
  font-size: 12px;
  color: rgba(255,255,255,.55);
  letter-spacing:.2px;
  text-shadow: 0 10px 24px rgba(0,0,0,.70);
  z-index:2;
  pointer-events:none;
}

@media (max-width: 920px){
  .loginInner{ grid-template-columns:1fr; gap:18px; padding: 26px 16px; }
  .loginLeft{ padding: 10px 4px; }
}

.loginLeft{ color:#fff; max-width: 520px; }
.loginTitle{
  font-weight: 900;
  font-size: clamp(2.6rem, 5.2vw, 4rem);
  line-height: .95;
  letter-spacing: .4px;
  text-shadow: 0 18px 40px rgba(0,0,0,.45);
}
.loginText{
  margin-top: 14px;
  color: rgba(255,255,255,.78);
  font-size: 1.02rem;
  line-height: 1.45;
}
.loginSocial{
  margin-top: 18px;
  display:flex;
  gap: 12px;
}
.sIco{
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 1px solid rgba(255,255,255,.45);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  text-decoration:none;
  font-weight: 900;
  background: rgba(0,0,0,.18);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
  user-select:none;
}
.sIco:hover{ filter: brightness(1.06); transform: translateY(-1px); }
.sIco:active{ transform: translateY(0); }

.loginRight{
    position: relative;
width: min(440px, 100%);
  margin-left:auto;
  color:#fff;
}
.loginRightTitle{
  font-weight: 900;
  font-size: 1.55rem;
  margin-bottom: 14px;
  letter-spacing: .2px;
}

.loginField{ margin-top: 12px; }
.loginField label{
  display:block;
  font-size: .9rem;
  opacity: .88;
  margin-bottom: 6px;
}
.loginField input{
  width:100%;
  height: 36px;
  padding: 8px 10px;
  border-radius: 2px;
  border: 1px solid rgba(255,255,255,.55);
  background: rgba(255,255,255,.96);
  color: #111827;
  outline:none;
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
}
.loginField input:focus{ border-color: rgba(255,255,255,.95); }

.loginRow{
  margin-top: 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
}

.startRoleToggle{
  margin-top: 10px;
  display:flex;
  gap:10px;
  width:100%;
}
.startRoleBtn{
  flex:1;
  height:34px;
  border-radius: 2px;
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.92);
  font-weight: 800;
  cursor:pointer;
  transition: background .2s ease, border-color .2s ease, transform .2s ease, filter .2s ease;
}
.startRoleBtn:hover{ background: rgba(255,255,255,.12); }
.startRoleBtn.active{
  background: rgba(255,255,255,.22);
  border-color: rgba(255,255,255,.45);
  color: #fff;
}
.startRoleBtn:active{ transform: translateY(1px); }

.themeToggle{
  margin-top: 10px;
  display:flex;
  gap:10px;
  width:100%;
}
.themeBtn{
  flex:1;
  height:34px;
  border-radius: 2px;
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  font-weight: 800;
  cursor:pointer;
  transition: background .2s ease, border-color .2s ease, transform .2s ease, filter .2s ease;
}
.themeBtn:hover{ background: rgba(255,255,255,.16); }
.themeBtn.active{
  background: rgba(255,255,255,.18);
  border-color: rgba(255,255,255,.42);
  color:#fff;
}
.themeBtn:active{ transform: translateY(1px); }

.loginCheck{
  display:flex;
  align-items:center;
  gap:8px;
  font-size: .92rem;
  color: rgba(255,255,255,.92);
  user-select:none;
}
.loginCheck input{ width:auto; height:auto; }

.loginBtn{
  margin-top: 14px;
  width: 100%;
  height: 36px;
  border: 0;
  border-radius: 2px;
  cursor:pointer;
  font-weight: 900;
  color: #fff;
  background: linear-gradient(90deg, rgba(245,180,0,.95), rgba(255,204,51,.90));
  box-shadow: 0 14px 34px rgba(0,0,0,.32);
}
.loginBtn:hover{ filter: brightness(1.03); transform: translateY(-1px); }
.loginBtn:active{ transform: translateY(0); filter: brightness(.98); }

/* Aproxima o texto abaixo do switch */
.themeSwitchRowUnderBtn + .loginLost{ margin-top: 0px !important; }

.loginLost{
  margin-top: 6px;
  background:none;
  border:none;
  color: rgba(255,255,255,.92);
  cursor:pointer;
  text-align:left;
  padding: 0;
  font-size: .92rem;
  opacity:.92;
}
.loginLost:hover{ text-decoration: underline; }

.loginTerms{
  margin-top: 8px;
  font-size: .78rem;
  color: rgba(255,255,255,.72);
  line-height: 1.35;
}
.loginLink{
  background:none;
  border:none;
  color: rgba(255,255,255,.92);
  cursor:pointer;
  padding:0;
  font-weight: 800;
  text-decoration: underline;
}
.loginCreate{
  margin-top: 8px;
  font-size: .9rem;
  color: rgba(255,255,255,.84);
}

/* ===== AUTH LANDING (Login minimalista) ===== */
    .authLanding{
      min-height: calc(100vh - 200px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 56px 16px 72px;
    }
    .authCard{
      width: min(760px, 100%);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.09);
      background: linear-gradient(180deg, rgba(11,18,38,.88), rgba(5,8,18,.74));
      box-shadow: 0 22px 90px rgba(0,0,0,.55);
      padding: 34px;
      position: relative;
      overflow:hidden;
    }
    .authCard:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 220px at 20% 0%, rgba(255,204,0,.14), transparent 55%),
                  radial-gradient(520px 220px at 80% 0%, rgba(109,99,255,.16), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .authCard > *{ position:relative; z-index:1; }
    .authBrand{
      display:flex;
      align-items:center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .brandMark{
      width: 56px; height: 56px;
      border-radius: 18px;
      display:grid; place-items:center;
      font-weight: 900;
      letter-spacing: .5px;
      color: #0b1226;
      background: linear-gradient(135deg, rgba(255,204,0,1), rgba(255,153,0,1));
      box-shadow: 0 12px 35px rgba(255,204,0,.20);
    }
    .authName{
      font-size: 30px;
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.05;
    }
    .authSub{
      margin-top: 2px;
      font-size: 14px;
      color: rgba(229,231,235,.70);
    }
    .authMainBtn{
      width: 100%;
      padding: 16px 16px;
      border-radius: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      margin-top: 14px;
    }

    .authActions{
      display:flex;
      gap: 12px;
      margin-top: 14px;
    }
    .authActions .btn{
      margin-top: 0;
      width: auto;
      flex: 1;
      padding: 16px 16px;
      border-radius: 18px;
      font-weight: 900;
    }
    .authAltBtn{
      font-weight: 800;
    }
    .authNote{
      margin-top: 14px;
      font-size: 12px;
      color: rgba(229,231,235,.62);
      line-height: 1.35;
    }


body.adm-open{ overflow:auto; }


    /* ===== Role picker (Cliente / Editor) - estilo do site ===== */
    .rolePicker{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px;
      margin:10px 0 14px;
      width: fit-content;
      border-radius:16px;
      background: rgba(255,255,255,.045);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
    }
    .rolePicker .roleBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(247,248,251,.92);
      font-weight:800;
      letter-spacing:.2px;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease, color .18s ease;
      user-select:none;
    }
    .rolePicker .roleBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,224,138,.28);
      box-shadow: 0 16px 34px rgba(0,0,0,.35);
    }
    .rolePicker .roleBtn:active{
      transform: translateY(0px) scale(.985);
    }
    .rolePicker .roleBtn.active{
      background: linear-gradient(180deg, rgba(245,180,0,.88), rgba(255,204,51,.68), rgba(255,224,138,.52));
      border-color: rgba(255,224,138,.55);
      color: rgba(10,12,18,.95);
      box-shadow: 0 18px 42px rgba(0,0,0,.35), 0 14px 40px rgba(245,180,0,.12);
    }

    @media (max-width: 520px){
      .rolePicker{ width:100%; justify-content:space-between; }
      .rolePicker .roleBtn{ flex:1; text-align:center; }
    }

    /* ===== Senha toggle (eye) ===== */
    .passWrap{ position:relative; width:100%; }
    .passWrap input{ padding-right:52px !important; }
    .passToggle{
      position:absolute;
      right:10px; top:50%;
      transform: translateY(-50%);
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .18s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .passToggle:hover{
      transform: translateY(-50%) scale(1.04);
      background: rgba(245,180,0,.10);
      border-color: rgba(245,180,0,.35);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
    }
    .passToggle:active{ transform: translateY(-50%) scale(.98); }
    .passToggle svg{ width:18px; height:18px; opacity:.95; }
    @media (prefers-reduced-motion: reduce){
      .passToggle{ transition:none; }
    }

/* ===== Global Loader (Karameloo) ===== */
.globalLoader{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  z-index:99999;
  background: radial-gradient(900px 500px at 20% 10%, rgba(245,180,0,.12), transparent 60%),
              radial-gradient(900px 500px at 80% 90%, rgba(245,180,0,.10), transparent 60%),
              rgba(0,0,0,.50);
}
.globalLoader.show{ display:flex; }
.globalLoader .glCard{
  width:min(420px, calc(100vw - 48px));
  padding:18px 18px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,14,28,.72);
  box-shadow: 0 18px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(245,180,0,.08);
  display:flex; align-items:center; gap:14px;
}
.globalLoader .glSpinner{
  width:34px; height:34px; border-radius:999px;
  border:3px solid rgba(255,255,255,.18);
  border-top-color: rgba(245,180,0,.95);
  border-right-color: rgba(245,180,0,.55);
  animation: glSpin .9s linear infinite;
  flex:0 0 auto;
}
@keyframes glSpin{ to{ transform: rotate(360deg); } }
.globalLoader .glText{
  font-weight:800;
  letter-spacing:.2px;
  color: rgba(255,255,255,.92);
}
.globalLoader .glSub{
  margin-top:2px;
  font-size:12px;
  color: rgba(255,255,255,.62);
  font-weight:600;
}
@media (prefers-reduced-motion: reduce){
  .globalLoader .glSpinner{ animation:none; }
}
body.no-scroll{ overflow:hidden !important; }


  /* === Novo Fundo (Floresta Amanhecer) === */
  #bg-parallax{
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
    overflow: hidden;
  }
  #bg-parallax .bgfx-wrap,
  #bg-parallax .bgfx-scene-wrap,
  #bg-parallax .bgfx-scene{
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
  }
  #bg-parallax .bgfx-scene{
    border-radius: 0 !important;
    box-shadow: none !important;
  }
  /* garante que o site fique por cima */
  .page{ position: relative; z-index: 1; }

#bg-parallax .bgfx-wrap{max-width:none !important; max-height:none !important;
    width:100vw !important;
    height:100vh !important;
    padding:0 !important;
    margin:0 !important;
    max-width:none !important;
    max-height:none !important;
  }
#bg-parallax .bgfx-scene{
    width:100vw !important;
    height:100vh !important;
    border-radius:0 !important;
    box-shadow:none !important;
    margin:0 !important;
    overflow:hidden !important;
  }
#bg-parallax .bgfx-wrap{
    position: fixed !important;
    inset: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
  }
#bg-parallax .bgfx-scene{
    position: absolute !important;
    inset: 0 !important;
    width: 100% !important;
    height: 100% !important;
  }
#bg-parallax .bgfx-wrap{height:100vh;width:100vw;display:grid;place-items:center;padding:18px}
#bg-parallax .bgfx-scene-wrap{width:100vw;height:100vh;perspective:1400px;}
#bg-parallax .bgfx-scene{
    position:relative;
    width:100%;height:100%;
    transform-style:preserve-3d;
    border-radius:28px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 34px 140px rgba(0,0,0,.58);
    background: rgba(0,0,0,.18);
  }
#bg-parallax .bgfx-layer{position:absolute; inset:0; transform-style:preserve-3d}
#bg-parallax .bgfx-hud{
    position:absolute; left:16px; right:16px; top:16px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:12px 14px; border-radius:18px;
    background: rgba(255,255,255,.16);
    border:1px solid rgba(255,255,255,.16);
    backdrop-filter: none;
    pointer-events:auto;
    z-index: 50;
  }
#bg-parallax .brand{display:flex;align-items:center;gap:10px}
#bg-parallax .dot{width:38px;height:38px;border-radius:14px;background:linear-gradient(135deg, rgba(255,215,64,.98), rgba(255,150,60,.70));
        box-shadow:0 14px 44px rgba(255,200,60,.18)}
#bg-parallax .brand b{display:block;font-size:14px;letter-spacing:.2px}
#bg-parallax .brand span{display:block;font-size:12px;opacity:.72;margin-top:2px}
#bg-parallax .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
#bg-parallax .pill{
    font-size:12px; letter-spacing:.2px;
    padding:9px 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.92);
  }
#bg-parallax .pill[data-enable-gyro]{cursor:pointer;user-select:none}
#bg-parallax .pill.on{border-color: rgba(255,200,60,.45); background: rgba(255,200,60,.14)}
#bg-parallax .bgfx-footer{
    position:absolute; left:16px; right:16px; bottom:16px;
    display:flex; align-items:flex-end; justify-content:space-between; gap:14px;
    pointer-events:none;
    z-index: 50;
  }
#bg-parallax .note{
    max-width: 720px;
    padding:12px 14px; border-radius:18px;
    background: rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.12);
    backdrop-filter: none;
  }
#bg-parallax .note h1{margin:0 0 4px;font-size:18px}
#bg-parallax .note p{margin:0;opacity:.72;line-height:1.35;font-size:12.5px}
#bg-parallax .badge{
    padding:10px 12px; border-radius:16px;
    background: rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.12);
    font-size:12px; opacity:.86
  }
#bg-parallax .pixel{
    position:absolute; inset:0;
    width:100%; height:100%;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }
#bg-parallax .bgfx-haze{
    position:absolute; inset:-10%;
    /* Névoa lisa (sem bolhas/ovais) */
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(0,0,0,.10));
    filter: blur(14px);
    opacity:.38;
  }
#bg-parallax .constellation-layer .c-line{stroke: rgba(255,255,255,.22); stroke-width: 1.2; stroke-linecap: round; stroke-dasharray: 260; stroke-dashoffset: 260; transition: stroke .25s ease, opacity .25s ease;}
#bg-parallax .constellation-layer .c-star{fill: rgba(255,255,255,.75); opacity:.9; transition: transform .25s ease, opacity .25s ease, filter .25s ease;}
#bg-parallax .constellation-layer .c-star.tiny{opacity:.45}
#bg-parallax .constellation{cursor: pointer;}
#bg-parallax .constellation:hover .c-line{stroke: rgba(255,230,170,.70); opacity:1; animation: draw 1.05s ease forwards;}
#bg-parallax .constellation:hover .c-star{filter: drop-shadow(0 0 10px rgba(255,230,170,.55)); transform: scale(1.12); opacity:1;}
#bg-parallax .constellation:hover .c-star.tiny{opacity:.8; transform: scale(1.18);}
@keyframes draw{to{stroke-dashoffset:0}
#bg-parallax .bgfx-star-glow{position:absolute;inset:0; pointer-events:none; mix-blend-mode:screen; opacity:0; z-index: 25;
    background: radial-gradient(240px 240px at var(--gx, 50%) var(--gy, 20%),
      rgba(255,230,170,.16), rgba(255,230,170,0) 65%);
  }
#bg-parallax .grain{position:absolute; inset:0; pointer-events:none; opacity:.14; mix-blend-mode:overlay; z-index: 60;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='320'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.84' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='320' height='320' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
  }
@media (prefers-reduced-motion: reduce){
    .bgfx-scene, .bgfx-layer{transition:none!important;animation:none!important}
#bg-parallax .leaf{animation:none!important;opacity:.25}
#bg-parallax 12%{ opacity: .90; }
#bg-parallax 55%{
      transform: translate3d(calc((var(--startX) - 520)*1px), calc((var(--startY) + var(--midY))*1px), 0) rotate(180deg) scale(var(--s));
      opacity: .92;
    }
#bg-parallax 100%{
      transform: translate3d(calc((var(--startX) - 1080)*1px), calc((var(--startY) + var(--endY))*1px), 0) rotate(360deg) scale(var(--s));
      opacity: 0;
    }
#bg-parallax 10%{ opacity: .85; }
#bg-parallax 50%{
      transform: translate3d(55vw, calc((var(--y) + var(--dy))*1vh), 0) rotate(180deg) scale(var(--s));
      opacity: .9;
    }
#bg-parallax 100%{
      transform: translate3d(-20vw, calc((var(--y) + var(--dy2))*1vh), 0) rotate(360deg) scale(var(--s));
      opacity: 0;
    }
#bg-parallax 10%{ opacity: .85; }
#bg-parallax 50%{
      transform: translate3d(55%, calc(var(--dy)*1px), 0) rotate(180deg) scale(var(--s));
      opacity: .9;
    }
#bg-parallax 100%{
      transform: translate3d(-20%, calc(var(--dy2)*1px), 0) rotate(360deg) scale(var(--s));
      opacity: 0;
    }
#bg-parallax 10%{ opacity: .85; }
#bg-parallax 50%{
      transform: translate3d(55%, calc((var(--y) + var(--dy))*1%), 0) rotate(180deg) scale(var(--s));
      opacity: .9;
    }
#bg-parallax 100%{
      transform: translate3d(-20%, calc((var(--y) + var(--dy2))*1%), 0) rotate(360deg) scale(var(--s));
      opacity: 0;
    }


  /* === Ajuste: remover SOL do fundo (pedido do Kauan) === */
  /* ✅ Ajuste extra: tirar 'sol' no canto (estrela muito brilhante) */
  #bg-parallax .constellation-layer .c-star{ filter:none !important; opacity:.78 !important; }

  #pixelSun{ display:none !important; }
  #bg-parallax .bgfx-haze{ display:none !important; }


    /* ===== CHAT PREMIUM (Cliente ↔ Editor) ===== */
    .chatFab{
      position:fixed;
      right:18px; bottom:18px;
      z-index:9999;
      width:56px; height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(37,99,235,.75));
      color:#0b0e14;
      box-shadow: 0 20px 50px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .chatFab:hover{ filter:brightness(1.06); transform: translateY(-1px); }
    .chatFab:active{ transform: translateY(0); }
    .chatFab .badge{
      position:absolute;
      top:-7px; right:-7px;
      min-width:22px; height:22px;
      padding:0 6px;
      border-radius:999px;
      background: rgba(245,180,0,.95);
      color:#0b0e14;
      font-weight:1000;
      font-size:.8rem;
      display:none;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(0,0,0,.35);
    }

    /* overlay/modal re-skin */
    #chatModal{ overflow:hidden; }
    .chatShell{
      display:flex;
      flex-direction:column;
      height:min(72vh, 620px);
      gap:0;
      border-radius:18px;
    }
    .chatTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.16);
      background: linear-gradient(90deg, rgba(124,58,237,.24), rgba(37,99,235,.18), rgba(56,189,248,.10));
    }
    .chatPeer{
      display:flex; align-items:center; gap:12px; min-width:0;
    }
    .chatAvatar{
      width:42px; height:42px; border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: radial-gradient(120% 120% at 30% 20%, rgba(245,180,0,.25), transparent 55%),
                  linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.03));
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      color: rgba(247,248,251,.92);
    }
    .chatPeerMeta{ min-width:0; }
    .chatPeerName{
      font-weight:1000;
      letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chatPeerStatus{
      font-size:.86rem;
      color: rgba(229,231,235,.72);
      display:flex; align-items:center; gap:8px;
    }
    .dotOnline{
      width:8px; height:8px; border-radius:99px;
      background: rgba(34,197,94,.9);
      box-shadow: 0 0 0 4px rgba(34,197,94,.18);
    }
    .chatActions{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .chatIconBtn{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(247,248,251,.92);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
    }
    .chatIconBtn:hover{ background: rgba(255,255,255,.07); }
    .chatBody{
      flex:1;
      overflow:auto;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background: radial-gradient(900px 420px at 10% 0%, rgba(124,58,237,.12), transparent 55%),
                  radial-gradient(900px 420px at 90% 30%, rgba(56,189,248,.10), transparent 55%),
                  rgba(255,255,255,.02);
    }
    .chatDay{
      align-self:center;
      font-size:.82rem;
      color: rgba(229,231,235,.72);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      margin:4px 0 2px;
    }
    .chatRow{ display:flex; gap:10px; }
    .chatRow.me{ justify-content:flex-end; }
    .chatBubble{
      max-width: 78%;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(247,248,251,.94);
      line-height:1.35;
      position:relative;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .chatRow.me .chatBubble{
      background: rgba(245,180,0,.12);
      border-color: rgba(245,180,0,.22);
    }
    .chatText{ white-space:pre-wrap; word-break:break-word; }
    .chatMeta{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      font-size:.78rem;
      color: rgba(229,231,235,.65);
    }
    .chatTyping{
      display:flex; gap:6px; align-items:center;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      width: fit-content;
      color: rgba(229,231,235,.72);
    }
    .dots{
      display:inline-flex; gap:4px;
    }
    .dots i{
      width:6px; height:6px; border-radius:99px;
      background: rgba(229,231,235,.65);
      display:inline-block;
      animation: dotPulse 1.1s infinite ease-in-out;
    }
    .dots i:nth-child(2){ animation-delay:.15s; }
    .dots i:nth-child(3){ animation-delay:.30s; }
    @keyframes dotPulse{ 0%,100%{ opacity:.25; transform:translateY(0);} 50%{ opacity:1; transform:translateY(-3px);} }

    .chatQuick{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:10px 14px;
      border-top:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.10);
    }
    .chatQuick button{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.92);
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      font-size:.9rem;
    }
    .chatQuick button:hover{ background: rgba(255,255,255,.06); }
    .chatComposer{
      display:flex;
      gap:10px;
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
    }
    .chatInput{
      flex:1;
      min-height:44px;
      max-height:120px;
      resize:none;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(247,248,251,.92);
      outline:none;
    }
    .chatSend{
      width:54px; height:54px;
      border-radius:18px;
      border:none;
      cursor:pointer;
      font-weight:1000;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color:#0b0e14;
    }
    .chatSend:hover{ filter:brightness(1.05); }
    .chatHint{
      padding:10px 14px;
      font-size:.88rem;
      color: rgba(229,231,235,.72);
      border-top:1px dashed rgba(255,255,255,.16);
      background: rgba(0,0,0,.08);
    }
    @media (max-width: 620px){
      .chatFab{ right:12px; bottom:12px; border-radius:16px; }
      .chatShell{ height:min(78vh, 640px); }
      .chatBubble{ max-width: 86%; }
    }

  /* =========================
   Tema (login) + Switch igual ao vídeo
========================= */
.loginScene{
  position: relative;
  overflow: hidden;
}

/* Camadas de fundo (duas imagens) */
.loginBgWrap{
  position:absolute;
  inset:0;
  z-index:0;
  pointer-events:none;
}
.loginBg{
  position:absolute;
  inset:0;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transform: scale(1.03);
  will-change: opacity, filter;
  transition: opacity 900ms ease, filter 900ms ease;
}

/* Light por padrão */
.loginBg.bgLight{
  opacity: 1;
  filter: saturate(1) brightness(1) contrast(1.02);
}
.loginBg.bgDark{
  opacity: 0;
  filter: saturate(2.6) brightness(1.05) contrast(1.05);
}

/* Quando ativa o escuro: a primeira dessatura, a segunda aparece mais viva */
.loginScene.theme-dark .loginBg.bgLight{
  opacity: .18;
  filter: saturate(0) brightness(.72) contrast(1.02);
}
.loginScene.theme-dark .loginBg.bgDark{
  opacity: 1;
  filter: saturate(3.1) brightness(1.08) contrast(1.08);
}

/* Garante conteúdo acima do fundo */
.loginInner, .loginCredit{ position: relative; z-index: 1; }

/* Switch (estilo pill + bolinha) */
.themeSwitchRow{
  position: static;
  margin: 10px 0 0;
  display:flex;
  justify-content:flex-end;
  align-items:center;
  z-index: 5;
}

/* especificamente abaixo do botão Entrar agora */
.themeSwitchRowUnderBtn{
  margin-top: 4px;
  margin-right: 0;
  margin-bottom: -10px;
  display:flex;
  justify-content:flex-end;
}
.themeSwitchRowUnderBtn .themeSwitch{ margin-left:auto; }

@media (max-width: 620px){
  .themeSwitchRow{
    justify-content:flex-end;
    margin: 10px 0 0;
  }
}
.themeSwitchInput{
  position:absolute;
  opacity:0;
  pointer-events:none;
}

/* Switch no estilo Karameloo (premium, discreto e com o mesmo motion) */
.themeSwitch{
  --h: 16px;          /* menor */
  --w: 64px;
  --p: 2px;
  --knob: calc(var(--h) - (var(--p) * 2));

  width: var(--w);
  height: var(--h);
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 0 7px;

  cursor:pointer;
  user-select:none;
  position: relative;
  overflow:hidden;

  border: 1px solid var(--border);
  background:
    radial-gradient(110px 80px at 30% 40%, rgba(255,255,255,.12), rgba(255,255,255,0) 60%),
    linear-gradient(180deg, rgba(13,16,22,.60), rgba(13,16,22,.40));

  box-shadow:
    0 14px 30px rgba(0,0,0,.38),
    inset 0 0 0 1px rgba(0,0,0,.28),
    0 0 0 1px rgba(255,255,255,.06);
  transform: translateY(0);
  transition: transform 220ms ease, box-shadow 220ms ease, border-color 320ms ease, background 420ms ease;
}

/* “brilho” suave do lado Claro */
.themeSwitch::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(120px 90px at 22% 50%, rgba(245,180,0,.22), rgba(245,180,0,0) 60%),
    linear-gradient(90deg, rgba(245,180,0,.10), rgba(0,0,0,0) 58%);
  opacity:.75;
  transition: opacity 420ms ease, filter 520ms ease;
}

/* bolinha */
.themeSwitch::after{
  content:"";
  position:absolute;
  top: var(--p);
  left: var(--p);
  width: var(--knob);
  height: var(--knob);
  border-radius: 999px;

  background:
    radial-gradient(circle at 35% 30%, rgba(255,255,255,.92), rgba(255,255,255,.40) 55%, rgba(0,0,0,.12) 100%),
    linear-gradient(180deg, rgba(245,180,0,.45), rgba(245,180,0,.15));
  box-shadow:
    0 12px 22px rgba(0,0,0,.40),
    inset 0 0 0 1px rgba(0,0,0,.22);

  transform: translateX(0);
  transition: transform 620ms cubic-bezier(.2,.9,.2,1), background 420ms ease, box-shadow 420ms ease;
}

/* textos */
.themeSwitchText{
  position: relative;
  z-index: 1;
  font-weight: 900;
  font-size: 9px;
  letter-spacing: .2px;
  opacity: .82;
  transition: opacity 260ms ease, color 320ms ease;
}
.themeSwitchTextLight{ color: rgba(255,255,255,.92); }
.themeSwitchTextDark{ color: rgba(185,170,255,.95); }

/* estado marcado = Escuro (azul/roxo premium) */
.themeSwitchInput:checked + .themeSwitch{
  border-color: rgba(124,58,237,.34);
  background:
    radial-gradient(140px 90px at 75% 50%, rgba(37,99,235,.22), rgba(37,99,235,0) 60%),
    linear-gradient(180deg, rgba(10,12,20,.92), rgba(7,7,10,.92));
  box-shadow:
    0 16px 34px rgba(0,0,0,.45),
    inset 0 0 0 1px rgba(0,0,0,.35),
    0 0 0 1px rgba(124,58,237,.10);
}

/* brilho muda pro lado direito */
.themeSwitchInput:checked + .themeSwitch::before{
  background:
    radial-gradient(140px 90px at 78% 50%, rgba(124,58,237,.26), rgba(124,58,237,0) 62%),
    linear-gradient(90deg, rgba(0,0,0,0) 42%, rgba(124,58,237,.14));
  opacity: .90;
  filter: saturate(1.25);
}

.themeSwitchInput:checked + .themeSwitch::after{
  transform: translateX(calc(var(--w) - var(--knob) - (var(--p) * 2)));
  background:
    radial-gradient(circle at 35% 30%, rgba(210,205,255,.95), rgba(120,140,255,.50) 55%, rgba(40,60,170,.28) 100%),
    linear-gradient(180deg, rgba(124,58,237,.45), rgba(37,99,235,.14));
  box-shadow:
    0 12px 22px rgba(0,0,0,.46),
    inset 0 0 0 1px rgba(0,0,0,.28);
}

.themeSwitchInput:checked + .themeSwitch .themeSwitchTextDark{ opacity: 1; }
.themeSwitchInput:checked + .themeSwitch .themeSwitchTextLight{ opacity: .48; }

.themeSwitchInput:not(:checked) + .themeSwitch .themeSwitchTextLight{ opacity: 1; }
.themeSwitchInput:not(:checked) + .themeSwitch .themeSwitchTextDark{ opacity: .48; }

/* hover */
.themeSwitch:hover{
  transform: translateY(-1px);
  box-shadow:
    0 18px 38px rgba(0,0,0,.50),
    inset 0 0 0 1px rgba(0,0,0,.35),
    0 0 0 1px rgba(255,255,255,.08);
}

/* ===== Dark-mode intro overlay (video) ===== */
.themeIntro{
  position: fixed;
  inset: 0;
  z-index: 9999999;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 220ms ease, visibility 220ms ease;
  background: #000;
}
.themeIntro.is-on{
  opacity: 1;
  visibility: visible;
}
.themeIntro video{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  filter: contrast(1.05) saturate(1.05);
}
/* vinheta extra por cima (suave) */
.themeIntro::after{
  content:"";
  position:absolute;
  inset:0;
  background: radial-gradient(90% 70% at 50% 45%, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 100%);
}

</style>



<style id="admDashV1">
  /* Admin dashboard - inspired by modern dark dashboards */
  .admDash{display:none;min-height:calc(100vh - 120px);padding:18px 18px 90px}
  .admGrid{display:grid;grid-template-columns:260px 1fr;gap:16px;max-width:1280px;margin:0 auto}
  @media (max-width: 980px){.admGrid{grid-template-columns:1fr}.admSide{position:sticky;top:10px}}
  .admSide{
    border-radius:18px;
    background:linear-gradient(180deg, rgba(14,20,34,.86), rgba(9,12,22,.82));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 18px 60px rgba(0,0,0,.45);
    padding:14px;
    overflow:hidden;
  }
  .admBrand{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .admBrand .logoBox{
    width:44px;height:44px;border-radius:14px;
    background:linear-gradient(135deg, rgba(246,196,0,.22), rgba(246,196,0,.10));
    border:1px solid rgba(246,196,0,.45);
    display:grid;place-items:center;
    font-weight:900;color:#fff;
    box-shadow:0 10px 24px rgba(246,196,0,.12);
  }
  .admBrand .t1{font-weight:900}
  .admBrand .t2{font-size:12px;color:rgba(229,231,235,.72);margin-top:2px}
  .admNav{display:flex;flex-direction:column;gap:8px}
  .admNav .item{
    display:flex;gap:10px;align-items:center;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.08);
    color:#e5e7eb;font-weight:800;
    cursor:pointer;
    transition: transform .18s cubic-bezier(.16,1,.2,1), background .18s ease, border-color .18s ease, box-shadow .18s ease, filter .18s ease;
    will-change: transform;
  }
  .admNav .item .ic{
    width:34px;height:34px;border-radius:12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    display:grid;place-items:center;
    transition: transform .18s cubic-bezier(.16,1,.2,1), background .18s ease, border-color .18s ease, box-shadow .18s ease, filter .18s ease;
    will-change: transform;
    color:rgba(246,196,0,.95);
  }
  .admNav .item.active{
    background:rgba(246,196,0,.16);
    border-color:rgba(246,196,0,.45);
  }
  
  /* Hover interaction (não altera layout — só sensação premium) */
  .admNav .item:hover{
    transform: translateX(4px);
    background: rgba(255,255,255,.06);
    border-color: rgba(246,196,0,.22);
    box-shadow: 0 14px 30px rgba(0,0,0,.35);
    filter: brightness(1.02);
  }
  .admNav .item:hover .ic{
    transform: translateY(-1px) scale(1.03);
    background: rgba(246,196,0,.12);
    border-color: rgba(246,196,0,.30);
    box-shadow: 0 12px 22px rgba(246,196,0,.12);
  }
  .admNav .item:active{
    transform: translateX(2px) scale(.99);
    filter: brightness(.98);
  }
  .admNav .item.active:hover{
    background: rgba(246,196,0,.18);
    border-color: rgba(246,196,0,.55);
  }

  /* Charts (Analytics tab) */
  .admChartGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:10px}
  @media (max-width: 980px){.admChartGrid{grid-template-columns:1fr}}
  .admChartCard{
    padding:12px;border-radius:18px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18);
    box-shadow: 0 18px 40px rgba(0,0,0,.28);
  }
  .admChartHead{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:8px}
  .admChartMeta{color:rgba(229,231,235,.55);font-size:12px}
  .admChartCard canvas{width:100%;height:auto;display:block}

.admSide .mini{
    margin-top:14px;
    border-radius:16px;
    padding:12px;
    border:1px dashed rgba(255,255,255,.14);
    background:rgba(255,255,255,.03);
    color:rgba(229,231,235,.75);
    font-size:12px;
    line-height:1.35;
  }

  .admMain{
    border-radius:18px;
    background:linear-gradient(180deg, rgba(14,20,34,.72), rgba(9,12,22,.68));
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 18px 60px rgba(0,0,0,.45);
    padding:14px;
  }
  .admTop{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
  .admTop h2{margin:0;font-size:20px;letter-spacing:.2px}
  .admTop .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .admBadge{
    display:inline-flex;gap:8px;align-items:center;
    padding:8px 12px;border-radius:999px;
    border:1px solid rgba(246,196,0,.45);
    background:rgba(246,196,0,.14);
    color:#fff;font-weight:900;font-size:12px;
  }
  .admBtn{
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    color:#e5e7eb;font-weight:900;
  }
  .admBtn.primary{
    border-color:rgba(246,196,0,.45);
    background:rgba(246,196,0,.18);
  }

  .admBtn.danger{
    border-color: rgba(255,95,95,.40);
    background: rgba(255,95,95,.12);
  }
  .admBtn.danger:hover{
    filter: brightness(1.05);
    box-shadow: 0 14px 30px rgba(255,95,95,.14);
    border-color: rgba(255,95,95,.55);
  }

  .admCards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px}
  @media (max-width: 1100px){.admCards{grid-template-columns:repeat(2,1fr)}}
  @media (max-width: 560px){.admCards{grid-template-columns:1fr}}
  .admCard{
    border-radius:18px;padding:12px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.08);
    overflow:hidden;
    position:relative;
  }
  .admCard:after{
    content:"";
    position:absolute;inset:-80px -120px auto auto;
    width:260px;height:260px;border-radius:999px;
    background:radial-gradient(circle, rgba(246,196,0,.18), rgba(246,196,0,0) 60%);
    pointer-events:none;
  }
  .admCard .lab{font-size:12px;color:rgba(229,231,235,.72);display:flex;gap:8px;align-items:center}
  .admCard .val{font-size:22px;font-weight:1000;margin-top:6px}
  .admCard .sub{font-size:12px;color:rgba(229,231,235,.66);margin-top:6px}
  .admCard .pill{
    display:inline-flex;gap:6px;align-items:center;
    padding:6px 10px;border-radius:999px;font-size:12px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.05);
    margin-top:10px;
  }

  .admLayout{display:grid;grid-template-columns:1.5fr 1fr;gap:12px}
  @media (max-width: 1100px){.admLayout{grid-template-columns:1fr}}
  .admPanel{
    border-radius:18px;padding:12px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.08);
  }
  .admPanel h3{margin:0 0 10px 0;font-size:14px;letter-spacing:.2px}
  .admTable{width:100%;border-collapse:separate;border-spacing:0 10px}
  .admTable th{font-size:12px;color:rgba(229,231,235,.62);text-align:left;padding:0 10px}
  .admTable td{
    padding:12px 10px;
    background:rgba(255,255,255,.08);
    border-top:1px solid rgba(255,255,255,.08);
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .admTable tr td:first-child{
    border-left:1px solid rgba(255,255,255,.08);
    border-radius:14px 0 0 14px;
  }
  .admTable tr td:last-child{
    border-right:1px solid rgba(255,255,255,.08);
    border-radius:0 14px 14px 0;
  }
  .admStatus{
    display:inline-flex;gap:6px;align-items:center;
    padding:6px 10px;border-radius:999px;font-size:12px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
  }
  .admStatus.ok{border-color:rgba(64,210,120,.35);background:rgba(64,210,120,.10)}
  .admStatus.pending{border-color:rgba(246,196,0,.35);background:rgba(246,196,0,.12)}
  .admAct{display:flex;gap:8px;flex-wrap:wrap}
  .admAct button{
    padding:8px 10px;border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    color:#e5e7eb;font-weight:800;font-size:12px;
  }
  .admAct .danger{border-color:rgba(255,80,80,.35);background:rgba(255,80,80,.10)}
  .admAct .ok{border-color:rgba(64,210,120,.35);background:rgba(64,210,120,.10)}
  .admNote{font-size:12px;color:rgba(229,231,235,.65);margin-top:10px;line-height:1.4}

  /* === Micro-interações (ADM) — pedido do Kauan: animar cards/tabela/botões sem mexer nas animações existentes === */
  .admPanel, .admCard, .admKpi, .admTable tbody tr, .admAct button{
    will-change: transform;
    transition: transform .22s ease, box-shadow .22s ease, border-color .22s ease, background .22s ease, filter .22s ease;
  }

  /* Painéis e cards (Overview / Sales Analytics) */
  .admPanel:hover{
    transform: translateY(-2px);
    box-shadow: 0 18px 55px rgba(0,0,0,.55);
    border-color: rgba(246,196,0,.18);
  }
  .admCard:hover, .admKpi:hover{
    transform: translateY(-2px);
    box-shadow: 0 14px 40px rgba(0,0,0,.50);
    border-color: rgba(246,196,0,.18);
  }

  /* Linhas da tabela (Recent Orders) */
  .admTable tbody tr:hover{
    transform: translateY(-2px);
    filter: brightness(1.02);
  }
  .admTable tbody tr:hover td{
    background: rgba(255,255,255,.055);
    border-top-color: rgba(246,196,0,.18);
    border-bottom-color: rgba(246,196,0,.18);
  }

  /* Botões (ações) */
  .admAct button:hover{
    transform: translateY(-1px);
    border-color: rgba(246,196,0,.22);
    box-shadow: 0 10px 24px rgba(0,0,0,.45);
  }
  .admAct button:active{
    transform: translateY(0px) scale(.98);
    filter: brightness(.98);
  }


  /* Ações de Usuários (Banir/Desbanir/Verificar etc) — micro animações premium */
  .admAct button{
    position:relative;
    overflow:hidden;
    transform: translateZ(0);
  }
  .admAct button::after{
    content:"";
    position:absolute;
    inset:-60%;
    background: radial-gradient(circle at 30% 30%, rgba(246,196,0,.18), transparent 60%);
    opacity:0;
    transform: scale(.85);
    transition: opacity .22s ease, transform .22s ease;
    pointer-events:none;
  }
  .admAct button:hover::after{opacity:1; transform:scale(1);}

  .admAct .danger:hover{
    border-color:rgba(255,80,80,.55) !important;
    background:rgba(255,80,80,.18) !important;
    box-shadow: 0 12px 30px rgba(255,80,80,.14), 0 10px 24px rgba(0,0,0,.45);
  }
  .admAct .ok:hover{
    border-color:rgba(64,210,120,.55) !important;
    background:rgba(64,210,120,.18) !important;
    box-shadow: 0 12px 30px rgba(64,210,120,.14), 0 10px 24px rgba(0,0,0,.45);
  }

  /* Status pill também reage levemente quando o usuário passa o mouse na linha */
  .admStatus{
    transition: transform .22s ease, filter .22s ease, border-color .22s ease, background .22s ease;
    will-change: transform;
  }
  .admTable tbody tr:hover .admStatus{
    transform: translateY(-1px);
    filter: brightness(1.06);
  }
  /* Pequena animação de entrada para o conteúdo do ADM (leve) */
  @keyframes admFadeUp{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:translateY(0)}
  }
    body.adm-open .admDash,
  body.adm-open .admGrid{
    animation: admFadeUp .35s ease both;
  }

  /* Respeitar acessibilidade */
  @media (prefers-reduced-motion: reduce){
    .admPanel, .admCard, .admKpi, .admTable tbody tr, .admAct button{
      transition:none !important;
      animation:none !important;
    }
    .admPanel:hover, .admCard:hover, .admKpi:hover, .admTable tbody tr:hover, .admAct button:hover{
      transform:none !important;
      box-shadow:none !important;
      filter:none !important;
    }
  }

</style>


<style id="themeSwitchHotfix">
/* HOTFIX: garante que o toggle apareça (mesmo se algum CSS anterior falhar) */
#themeSwitch{
  position:absolute !important;
  opacity:0 !important;
  width:1px !important;
  height:1px !important;
  pointer-events:none !important;
}

/* linha do switch */
.themeSwitchRow{
  display:flex !important;
  align-items:center !important;
  gap:10px !important;
  margin: 8px 0 6px !important;
}

/* posição desejada: embaixo do botão, colado à direita */
.themeSwitchRowUnderBtn{
  justify-content:flex-end !important;
  margin-top: 8px !important;
  margin-bottom: 2px !important;
}

label.themeSwitch{
  display:flex !important;
  align-items:center !important;
  justify-content:space-between !important;
  width: 148px !important;
  height: 38px !important;
  padding: 0 12px !important;
  border-radius: 999px !important;
  cursor:pointer !important;
  user-select:none !important;
  border: 1px solid rgba(255,255,255,.28) !important;
  background: rgba(10,12,18,.46) !important;
  box-shadow: 0 12px 26px rgba(0,0,0,.35) !important;
  position: relative !important;
  overflow:hidden !important;
  transform: translateZ(0) !important;
}

label.themeSwitch::after{
  content:"" !important;
  position:absolute !important;
  top: 4px !important;
  left: 4px !important;
  width: 30px !important;
  height: 30px !important;
  border-radius: 999px !important;
  background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.95), rgba(255,255,255,.55) 60%, rgba(255,255,255,.22) 100%) !important;
  box-shadow: 0 10px 18px rgba(0,0,0,.32), inset 0 0 0 1px rgba(0,0,0,.18) !important;
  transition: transform 520ms cubic-bezier(.2,.9,.2,1), background 420ms ease !important;
  z-index: 2 !important;
}

label.themeSwitch .themeSwitchText{
  position:relative !important;
  z-index: 3 !important;
  font-weight:900 !important;
  font-size:12px !important;
  letter-spacing:.15px !important;
  opacity: .92 !important;
  line-height: 1 !important;
}
label.themeSwitch .themeSwitchTextDark{ opacity:.55 !important; }
label.themeSwitch .themeSwitchTextLight{ opacity:1 !important; }

/* checked = escuro (bolinha vai pra direita e muda “clima”) */
#themeSwitch:checked + label.themeSwitch{
  border-color: rgba(120,140,255,.35) !important;
  background: linear-gradient(180deg, rgba(12,16,44,.80), rgba(6,8,18,.86)) !important;
}
#themeSwitch:checked + label.themeSwitch::after{
  transform: translateX(110px) !important; /* 148 - 30 - 8 */
  background: radial-gradient(circle at 35% 30%, rgba(165,190,255,.98), rgba(110,130,255,.55) 60%, rgba(40,60,170,.28) 100%) !important;
}
#themeSwitch:checked + label.themeSwitch .themeSwitchTextDark{ opacity:1 !important; }
#themeSwitch:checked + label.themeSwitch .themeSwitchTextLight{ opacity:.55 !important; }
</style>
</head>

<body>
  <div id="siteBg" aria-hidden="true"></div>

  
  <div class="page">
<main>
      <div class="wrap">

        <!-- START -->
        <section id="screenStart" class="screen show">
  <div class="loginScene" data-bg-light="roberto-shumski-tDSTuUjv0DM-unsplash.jpg" data-bg-dark="bg-dark.jpg">

    <div class="loginBgWrap" aria-hidden="true">
      <div class="loginBg bgLight"></div>
      <div class="loginBg bgDark"></div>
    </div>
    <div class="loginInner">
      <div class="loginLeft">
        <div class="loginTitle">Bem-vindo<br/>de volta</div>
        <div class="loginText">
          Entre para continuar e encontrar o editor perfeito para o seu projeto.
        </div>
        <div class="loginSocial" aria-label="Social links">
          <a class="sIco" href="#" onclick="return false" aria-label="Facebook">f</a>
          <a class="sIco" href="#" onclick="return false" aria-label="Twitter">t</a>
          <a class="sIco" href="#" onclick="return false" aria-label="Instagram">⌁</a>
          <a class="sIco" href="#" onclick="return false" aria-label="YouTube">▶</a>
        </div>
      </div>

      <div class="loginRight">
        <div class="loginRightTitle">Entrar</div>
        <div class="loginField">
          <label for="startEmail">E-mail</label>
          <input id="startEmail" type="email" placeholder="" autocomplete="email" />
        </div>

        <div class="loginField">
          <label for="startSenha">Senha</label>
          <input id="startSenha" type="password" placeholder="" autocomplete="current-password" />
        </div>

        <div class="loginRow">
          <label class="loginCheck">
            <input id="startRemember" type="checkbox" />
            <span>Lembrar de mim</span>
          </label>

          <button class="loginLink" type="button" onclick="openAuth('login', getStartRole())">Login avançado</button>
        </div>

        
        <div class="startRoleToggle" role="group" aria-label="Escolher modo">
          <button class="startRoleBtn" type="button" data-role="cliente">Cliente</button>
          <button class="startRoleBtn" type="button" data-role="editor">Editor</button>
        </div>
<button class="loginBtn" type="button" onclick="startSignIn()">Entrar agora</button>

        <div class="themeSwitchRow themeSwitchRowUnderBtn" aria-label="Tema">
          <input id="themeSwitch" class="themeSwitchInput" type="checkbox" data-theme-toggle />
          <label class="themeSwitch" for="themeSwitch" title="Alternar tema">
            <span class="themeSwitchText themeSwitchTextLight">Claro</span>
            <span class="themeSwitchText themeSwitchTextDark">Escuro</span>
          </label>
        </div>


        <button class="loginLost" type="button" onclick="alert('Recuperação de senha: em breve (precisa backend).')">Esqueceu sua senha?</button>

        <div class="loginTerms">
          Ao clicar em "Entrar agora", você concorda com<br/>
          <button class="loginLink" type="button" onclick="alert('Termos: em breve.')">Termos de Serviço</button>
          |
          <button class="loginLink" type="button" onclick="alert('Privacidade: em breve.')">Política de Privacidade</button>
        </div>

        <div class="loginCreate">
          Não tem uma conta?
          <button class="loginLink" type="button" onclick="openAuth('register', getStartRole())">Criar conta</button>
        </div>
      </div>
    </div>
    <div class="loginCredit">© 2026 • Karameloo • Edição profissional</div>
  </div>
</section>

        <!-- ✅ EXPLORAR (Marketplace) -->
        
        <section id="screenProcurar" class="screen">
          <div class="marketTop">
            <div class="marketLogo" onclick="showScreen(screenProcurar,true)">Kara<b>meloo</b></div>

            <div class="marketSearch">
              <input id="exploreSearch" placeholder="Que serviço você está procurando hoje? (ex: reels, áudio, legenda)" maxlength="60" />
              <button class="marketSearchBtn" type="button" onclick="renderProcurarEditors()">🔎</button>
            </div>

            <div class="marketActions">
              <select id="exploreSort" class="marketSort" aria-label="Ordenar">
                <option value="best">Relevância</option>
                <option value="fast">Entrega rápida</option>
                <option value="pkgs">Mais pacotes</option>
                <option value="new">Novos</option>
              </select>
              <button class="iconBtn" type="button" onclick="openProcurarApiConfig()" title="Conectar backend">⛓</button>
              <button class="iconBtn" type="button" id="btnProcurarProfile" onclick="goClientProfileFromProcurar()" title="Meu perfil">👤</button>
              <button class="iconBtn" type="button" onclick="backToProcurarFromPackages()" title="Voltar">↩</button>
            </div>
          </div>

          <div class="marketCats" id="marketCats">
            <button class="catBtn active" type="button" data-filter="all">Tendência 🔥</button>
            <button class="catBtn" type="button" data-filter="pkgs">Pacotes</button>
            <button class="catBtn" type="button" data-filter="video">Edição de Vídeo</button>
            <button class="catBtn" type="button" data-filter="foto">Edição de Foto</button>
            <button class="catBtn" type="button" data-filter="audio">Música e Áudio</button>
            <button class="catBtn" type="button" data-filter="legenda">Legendas</button>
            <button class="catBtn" type="button" data-filter="motion">Motion</button>
            <button class="catBtn" type="button" data-filter="premium">Premium</button>
            <button class="catBtn" type="button" data-filter="fav">⭐ Salvos</button>
          </div>

          <div class="marketWelcome">
            <div class="marketWelcomeTitle">Boas-vindas de novo, <span id="exploreWelcomeName">Cliente</span></div>
            <div class="marketWelcomeSub" id="exploreSubtitle">Descubra perfis, compare estilos e salve seus favoritos.</div>
          </div>

          <div class="marketPromo" style="margin-top:14px">
            <div class="promoLeft">
              <div class="promoIcon">📝</div>
              <div>
                <div class="promoTitle">Publique um briefing de projeto</div>
                <div class="promoSub">Conte o que você precisa e encontre um editor perfeito pro seu estilo.</div>
              </div>
            </div>
            <button class="btn secondary" type="button" onclick="startBriefing()">Iniciar</button>
          </div>

          <div class="marketSection">
            <div class="secHead">
              <div class="secTitle">Com base no que você pode estar procurando</div>
              <button class="secBtn" type="button" onclick="scrollToProcurarGrid()">Continue explorando</button>
            </div>
            <div id="exploreEditorsCarousel" class="hScroll"></div>
          </div>

          <div class="marketSection" id="exploreGridAnchor">
            <div class="secHead">
              <div class="secTitle">Editores recomendados</div>
              <div class="hint" id="exploreBackendStatus" style="margin:0"></div>
            </div>

            <div class="chipsRow marketChips" style="margin-top:12px">
              <button class="chipBtn" type="button" data-filter="all">Todos</button>
              <button class="chipBtn" type="button" data-filter="video">Vídeo</button>
              <button class="chipBtn" type="button" data-filter="foto">Foto</button>
              <button class="chipBtn" type="button" data-filter="audio">Áudio</button>
              <button class="chipBtn" type="button" data-filter="legenda">Legendas</button>
              <button class="chipBtn" type="button" data-filter="motion">Motion</button>
              <button class="chipBtn" type="button" data-filter="premium">Premium</button>
              <button class="chipBtn" type="button" data-filter="fav">⭐ Favoritos</button>
            </div>

            <div class="hint" id="exploreHint" style="margin-top:10px">Dica: clique em um editor para ver o perfil completo.</div>

            <div id="exploreEditorsGrid" class="editor-cards" style="margin-top:12px"></div>
          </div>
        </section>

        <!-- ✅ EXPLORAR (Editor → clientes) -->
        <section id="screenProcurarEditor" class="screen">
          <div class="marketTop">
            <div class="marketLogo" onclick="showScreen(screenProcurarEditor,true)">Kara<b>meloo</b></div>

            <div class="marketSearch">
              <input id="exploreESearch" placeholder="Que tipo de cliente/pedido você quer? (ex: reels, foto, áudio)" maxlength="60" />
              <button class="marketSearchBtn" type="button" onclick="renderProcurarClients()">🔎</button>
            </div>

            <div class="marketActions">
              <select id="exploreESort" class="marketSort" aria-label="Ordenar">
                <option value="best">Relevância</option>
                <option value="new">Novos</option>
                <option value="urg">Urgentes</option>
                <option value="fit">Melhor encaixe</option>
              </select>
              <button class="iconBtn" type="button" onclick="goEditorDashboard()" title="Meu painel">👤</button>
              <button class="iconBtn" type="button" onclick="goEditorDashboard()" title="Voltar">↩</button>
            </div>
          </div>

          <div class="marketCats" id="marketCatsE">
            <button class="catBtn active" type="button" data-filter="all">Tendência 🔥</button>
            <button class="catBtn" type="button" data-filter="reels">Reels/TikTok</button>
            <button class="catBtn" type="button" data-filter="foto">Fotos</button>
            <button class="catBtn" type="button" data-filter="audio">Áudio</button>
            <button class="catBtn" type="button" data-filter="legenda">Legendas</button>
            <button class="catBtn" type="button" data-filter="motion">Motion</button>
            <button class="catBtn" type="button" data-filter="urg">Urgente</button>
            <button class="catBtn" type="button" data-filter="fav">⭐ Salvos</button>
          </div>

          <div class="marketWelcome">
            <div class="marketWelcomeTitle">Procurar clientes, <span id="exploreEWelcomeName">Editor</span></div>
            <div class="marketWelcomeSub" id="exploreESubtitle">Encontre pedidos compatíveis com seus pacotes e envie uma proposta (demo).</div>
          </div>

          <div class="marketPromo" style="margin-top:14px">
            <div class="promoLeft">
              <div class="promoIcon">📌</div>
              <div>
                <div class="promoTitle">Clientes procurando editores agora</div>
                <div class="promoSub">Escolha um pedido, veja o briefing e chame o cliente (demo).</div>
              </div>
            </div>
            <div class="promoRight">
              <button class="btn" type="button" onclick="scrollToProcurarClientsGrid()">Continue explorando</button>
            </div>
          </div>

          <div class="marketSection" style="margin-top:16px">
            <div class="marketSectionTitle">Com base no que você pode estar procurando</div>
            <div class="carousel" id="exploreClientsCarousel"></div>
          </div>

          <div id="exploreClientsGridAnchor" style="height:1px"></div>
          <div id="exploreClientsGrid" class="editor-cards" style="margin-top:12px"></div>

          <div class="hint" id="exploreEHint" style="margin-top:12px">Dica: clique no card para ver o briefing.</div>
        </section>


        <!-- Perfil do editor (modal) -->
        <div class="overlay" id="profileOverlay" aria-hidden="true">
          <div class="modal" id="profileModal" style="max-width:760px">
            <div class="modalHead">
              <div class="modalTitle" id="profileTitle">Perfil do editor</div>
              <button class="x" type="button" onclick="closeEditorProfile()">✕</button>
            </div>

            <div class="modalBody" id="profileBody"></div>
          </div>
        </div>

        <!-- Chat com o editor (premium) -->
        <div class="overlay" id="chatOverlay" aria-hidden="true">
          <div class="modal" id="chatModal" style="max-width:780px">
            <div class="modalHead">
              <div class="modalTitle" id="chatTitle">Conversar</div>
              <button class="x" type="button" onclick="closeChat()">✕</button>
            </div>

            <div class="modalBody" style="padding:0">
              <div class="chatShell">
                <div class="chatTop">
                  <div class="chatPeer">
                    <div class="chatAvatar" id="chatAvatar">K</div>
                    <div class="chatPeerMeta">
                      <div class="chatPeerName" id="chatPeerName">Editor</div>
                      <div class="chatPeerStatus"><span class="dotOnline"></span><span id="chatPeerStatusText">Online agora</span></div>
                    </div>
                  </div>

                  <div class="chatActions">
                    <button class="chatIconBtn" type="button" title="WhatsApp" onclick="openChatWhats()">WA</button>
                    <button class="chatIconBtn" type="button" title="Ir para o final" onclick="chatScrollToBottom()">↓</button>
                  </div>
                </div>

                <div class="chatBody" id="chatMsgs" aria-live="polite"></div>

                <div class="chatQuick" id="chatQuick">
                  <button type="button" onclick="chatQuick('Qual o prazo ideal pra você?')">⏱️ Prazo</button>
                  <button type="button" onclick="chatQuick('Qual plataforma? Reels, TikTok, Shorts?')">📱 Plataforma</button>
                  <button type="button" onclick="chatQuick('Me manda referências do estilo que você quer 🙂')">🎬 Referências</button>
                  <button type="button" onclick="chatQuick('Você prefere legenda, cortes rápidos ou estilo mais cinematográfico?')">✨ Estilo</button>
                </div>

                <div class="chatComposer">
                  <textarea id="chatInput" class="chatInput" placeholder="Escreva sua mensagem… (Enter envia / Shift+Enter quebra linha)" maxlength="900"></textarea>
                  <button class="chatSend" type="button" onclick="sendChat()" title="Enviar">➤</button>
                </div>

                <div class="chatHint" id="chatIntro">* Beta: mensagens ficam salvas no seu navegador. No backend a gente salva no Supabase.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ Confirmar pedido (BETA) -->
        <div class="overlay" id="orderOverlay" aria-hidden="true">
          <div class="modal" id="orderModal" style="max-width:760px">
            <div class="modalHead">
              <div>
                <div style="font-weight:900; font-size:1.15rem">Confirmar pedido</div>
                <div class="hint">Confira o editor + valor e continue para o pagamento.</div>
              </div>
              <button class="iconBtn" type="button" onclick="closeOrderConfirm()" title="Fechar">✕</button>
            </div>

            <div id="orderSummary" class="card" style="margin:10px 0 0">
              <!-- preenchido via JS -->
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px">
              <button class="btn secondary small" type="button" onclick="closeOrderConfirm()">Voltar</button>
              <button class="btn small" type="button" id="btnGoPay">Ir para pagamento</button>
            </div>
          </div>
        </div>

        <!-- Menu do usuário -->
        <div class="overlay" id="menuOverlay" aria-hidden="true">
          <div class="modal" id="menuModal" style="max-width:640px">
            <div class="modalHead">
              <div class="modalTitle" id="menuTitle">Menu</div>
              <button class="x" type="button" onclick="closeUserMenu()">✕</button>
            </div>
            <div class="modalBody" id="menuBody">
              <!-- preenchido via JS -->
            </div>
          </div>
        </div>


        <!-- CLIENTE: PERFIL (ANTES DOS PACOTES) -->

        <section id="screenClientProfile" class="screen">
          <div class="section-title">Seu perfil (Cliente)</div>
          <div class="pill">Complete seu perfil para uma experiência melhor (começa com 5 estrelas).</div>

          <div class="toolbar" style="margin-top:12px">
            <div class="left"><span class="chip">👤 Perfil</span></div>
            <div class="right">
              <button class="iconBtn" type="button" onclick="openUserMenu('cliente')" title="Menu">⋮</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="profileCover" id="clientCover"></div>
            <div class="who">
              <div class="avatar" id="clientAvatarBox"></div>
              <div class="meta">
                <div style="font-weight:900" id="clientProfileName">Cliente</div>
                <div class="stars" id="clientStars"></div>
              </div>
            </div>

            <div class="uploadRow">
              <label class="btn secondary small" style="cursor:pointer">
                Enviar foto
                <input id="clientPhoto" type="file" accept="image/*" style="display:none">
              </label>
              <button class="btn secondary small" type="button" onclick="removeClientPhoto()">Remover</button>
              <div class="hint" style="margin-top:0">* Foto opcional (salva no navegador).</div>
            </div>

            <div class="coverControls" style="margin-top:12px">
              <div class="mini-grid">
                <div class="mini">
                  <label>Plano de fundo (preset)</label>
                  <select id="clCoverPreset">
                    <option value="none">Sem fundo</option>
                    <option value="gold">Dourado suave</option>
                    <option value="amber">Âmbar</option>
                    <option value="graphite">Grafite</option>
                    <option value="sunset">Pôr do sol</option>
                  </select>
                </div>
                <div class="mini">
                  <label>Enviar imagem (capa)</label>
                  <input id="clCoverUpload" type="file" accept="image/*" />
                </div>
              </div>
              <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
                <button class="btn secondary small" type="button" onclick="removeClientCover()">Remover fundo</button>
                <div class="hint" style="margin-top:0">* Seu plano de fundo aparece no seu perfil e no marketplace.</div>
              </div>
            </div>

            <div class="mini-grid" style="margin-top:12px">
              <div class="mini">
                <label>WhatsApp</label>
                <input id="clWhats" placeholder="(DDD) 99999-9999" maxlength="15" inputmode="tel" />
              </div>
              <div class="mini">
                <label>Cidade</label>
                <input id="clCity" placeholder="Ex: São Paulo - SP" maxlength="40" />
              </div>
            </div>

            <div class="mini-grid" style="margin-top:10px">
              <div class="mini">
                <label>Nicho / Categoria</label>
                <input id="clNiche" placeholder="Ex: Moda, Gaming, Fitness, Loja, Influencer..." maxlength="40" />
              </div>
              <div class="mini">
                <label>Rede principal</label>
                <select id="clMainPlatform">
                  <option value="instagram">Instagram</option>
                  <option value="tiktok">TikTok</option>
                  <option value="youtube">YouTube</option>
                  <option value="facebook">Facebook</option>
                  <option value="kwai">Kwai</option>
                  <option value="pinterest">Pinterest</option>
                  <option value="linkedin">LinkedIn</option>
                  <option value="x">X (Twitter)</option>
                </select>
              </div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>Sobre você / Objetivo</label>
              <textarea id="clAbout" placeholder="Ex: Quero vídeos curtos para Reels/TikTok, estilo cinematográfico, cortes rápidos, legendas..." maxlength="420"></textarea>
            </div>

            <div class="mini-grid" style="margin-top:12px">
              <button class="btn" type="button" onclick="saveClientProfileAndGo()">Salvar e continuar</button>
              <button class="btn secondary" type="button" onclick="backToProcurarFromPackages()">Voltar</button>
            </div>
          </div>
        </section>

        <!-- CLIENTE: PACOTES -->
        <section id="screenClient" class="screen">
          <div class="who">
            <div class="avatar" id="clientAvatarTop"></div>
            <div class="meta">
              <div class="section-title" style="margin:0">Bem-vindo, <span id="clientName">Cliente</span> 👋</div>
              <div class="stars" id="clientStarsTop"></div>
            </div>
          </div>
          <div class="mini-grid" style="margin-top:12px">
            <button class="btn secondary" type="button" onclick="backToClientProfileFromPackages()">← Voltar</button>

            <div class="mini" style="justify-self:end; max-width:420px">
              <label style="margin-bottom:6px">Nível do editor</label>
              <div class="tier-toggle" id="tierTogglePackages" role="tablist" aria-label="Nível do editor">
                <button type="button" class="tier-btn" data-tier="iniciante" role="tab" aria-selected="false">Iniciante</button>
                <button type="button" class="tier-btn" data-tier="intermediario" role="tab" aria-selected="false">Intermediário</button>
                <button type="button" class="tier-btn" data-tier="avancado" role="tab" aria-selected="true">Avançado</button>
              </div>
            </div>
          </div>

          <div class="pill" style="margin-top:10px">Escolha um pacote pronto ou monte um pacote personalizado.</div>

          <div class="pill" id="clientEditorContext" style="margin-top:10px; display:none"></div>

          <div class="section-title" style="margin-top:18px">Pacotes prontos (15 opções)</div>
          <div id="packagesGrid" class="grid" style="margin-top:12px"></div>

          <div class="section-title" style="margin-top:26px">Pacote Personalizado ✨</div>
          <div class="grid" style="margin-top:12px">
            <div class="card highlight full">
              <h3>Monte seu pacote</h3>
              <p>Escolha quantas fotos/vídeos você quer, plataforma e tipo de vídeo. O site soma tudo por trás e mostra só o total.</p>

              <div class="mini-grid" style="margin-top:12px">
                <div class="mini">
                  <label>Fotos</label>
                  <input id="custFotos" type="number" min="0" value="0" max="999" inputmode="numeric" />
                </div>
                <div class="mini">
                  <label>Vídeos</label>
                  <input id="custVideos" type="number" min="0" value="0" max="999" inputmode="numeric" />
                </div>
              </div>

              <div class="mini-grid" style="margin-top:10px">
                <div class="mini">
                  <label>Plataforma / Rede</label>
                  <select id="custPlataforma">
                    <option value="reels">Instagram Reels</option>
                    <option value="tiktok">TikTok</option>
                    <option value="insta">Instagram Feed</option>
                    <option value="shorts">YouTube Shorts</option>
                    <option value="ytlong">YouTube (vídeo normal)</option>
                    <option value="facebookreels">Facebook Reels</option>
                    <option value="kwai">Kwai</option>
                    <option value="snap">Snapchat Spotlight</option>
                    <option value="pinterest">Pinterest Idea Pins</option>
                    <option value="linkedin">LinkedIn</option>
                    <option value="x">X (Twitter)</option>
                  </select>
                </div>
                <div class="mini">
                  <label>Tipo de vídeo</label>
                  <select id="custTipoVideo">
                    <option value="15">Curto (até 15s)</option>
                    <option value="45">Médio (30–45s)</option>
                    <option value="60">Longo (até 60s)</option>
                    <option value="90">+ 1min30</option>
                    <option value="120">+ 2 minutos</option>
                    <option value="180">+ 3 minutos</option>
                    <option value="300">+ 5 minutos</option>
                    <option value="600">+ 10 minutos</option>
                    <option value="1200">+ 20 minutos</option>
                    <option value="1800">+ 30 minutos</option>
                    <option value="3600">+ 1 hora</option>
                    <option value="7200">+ 2 horas</option>
                    <option value="10800">+ 3 horas</option>
</select>
                </div>
              </div>

              <div class="checks" style="margin-top:10px" id="customChecks">
                <!-- principais (5) -->
                                <div id="customOptsMain">
                  <div class="customGroup">
                    <div class="customGroupTitle">🎬 Extras para Vídeo</div>
                    <div class="customGroupGrid">
                      <label class="chk"><input data-custom-opt id="optCorCine" type="checkbox" /> Cor cinematográfica (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optLegenda" type="checkbox" /> Legendas (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optTransicoes" type="checkbox" /> Transições premium (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optAudio" type="checkbox" /> Melhorar áudio + reduzir ruído (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optMusicSync" type="checkbox" /> Sincronizar cortes com música (vídeos)</label>
                    </div>
                  </div>

                  <div class="customGroup">
                    <div class="customGroupTitle">📷 Extras para Foto</div>
                    <div class="customGroupGrid">
                      <label class="chk"><input data-custom-opt id="optRetoquePro" type="checkbox" /> Retoque avançado (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optHDR" type="checkbox" /> HDR / nitidez premium (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optFundo" type="checkbox" /> Remover/alterar fundo (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optObjeto" type="checkbox" /> Remover objetos (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optPele" type="checkbox" /> Suavizar pele (fotos)</label>
                    </div>
                  </div>
                </div>

                <!-- mais opções (colapsado) -->
                                <div id="customOptsMore" class="collapsed">
                  <div class="customGroup">
                    <div class="customGroupTitle">🎬 Mais extras de Vídeo</div>
                    <div class="customGroupGrid">
                      <label class="chk"><input data-custom-opt id="optMotion" type="checkbox" /> Motion graphics (títulos) (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optIntroOutro" type="checkbox" /> Intro/Outro + CTA (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optEstabilizar" type="checkbox" /> Estabilização (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optSpeedRamp" type="checkbox" /> Speed ramp / slow motion (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optSFX" type="checkbox" /> Efeitos sonoros (SFX) (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optVoiceClean" type="checkbox" /> Limpeza de voz / clareza (vídeos)</label>

                      <label class="chk"><input data-custom-opt id="optHook" type="checkbox" /> Hook inicial (0–3s) mais forte (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optCutsPro" type="checkbox" /> Cortes avançados + ritmo (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optColorMatch" type="checkbox" /> Match de cor entre cenas (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optVfxLite" type="checkbox" /> VFX leve (glow, shake, zoom) (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optReframe" type="checkbox" /> Reenquadrar para 9:16/1:1 (vídeos)</label>
                      <label class="chk"><input data-custom-opt id="optCapStyle" type="checkbox" /> Estilo premium de legenda (vídeos)</label>
                    </div>
                  </div>

                  <div class="customGroup">
                    <div class="customGroupTitle">📷 Mais extras de Foto</div>
                    <div class="customGroupGrid">
                      <label class="chk"><input data-custom-opt id="optCoresFoto" type="checkbox" /> Cor cinematográfica (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optTexto" type="checkbox" /> Texto/arte simples (fotos)</label>

                      <label class="chk"><input data-custom-opt id="optDodgeBurn" type="checkbox" /> Luz &amp; sombra (Dodge &amp; Burn) (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optNoisePhoto" type="checkbox" /> Redução de ruído + textura (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optBatchPreset" type="checkbox" /> Preset em lote (consistência) (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optBlurBG" type="checkbox" /> Desfoque/Profundidade no fundo (fotos)</label>
                      <label class="chk"><input data-custom-opt id="optLensFix" type="checkbox" /> Correções de lente + perspectiva (fotos)</label>
                    </div>
                  </div>

                  <div class="customGroup">
                    <div class="customGroupTitle">📌 Extras do Pedido</div>
                    <div class="customGroupGrid">
                      <label class="chk"><input data-custom-opt id="optThumbnail" type="checkbox" /> Thumbnail (capa) (1 unidade)</label>
                      <label class="chk"><input data-custom-opt id="optUrgente" type="checkbox" /> Prioridade (entrega mais rápida)</label>
                    </div>
                  </div>
                </div>
              </div>

              <div class="moreRow">
                <button class="btn secondary small" id="toggleCustomOpts" type="button" onclick="toggleCustomOptions()">Ver mais opções ↓</button>
              </div>

              <div class="field" style="margin-top:12px">
                <label>Categoria detalhada</label>
                <textarea id="custDetalhe" placeholder="Descreva exatamente como você quer: estilo, referência, cores, cortes, músicas, legendas, plataformas, etc..." maxlength="700"></textarea>
              </div>

              <div class="total-box">
                <div class="total-line"><span>Valor total</span><strong id="custTotal">R$ 0</strong></div>
                <div class="total-sub">Entrega estimada: <strong id="custEntrega">35min</strong> (mínimo)</div>
              </div>

              <button class="btn" type="button" onclick="confirmCustom()">Continuar com o personalizado</button>
              <div class="hint">* Os preços por item são internos e não aparecem.</div>
            </div>
          </div>
        </section>

        <!-- ✅ Seleção de Editor (Cliente) -->
        <section id="screenPickEditor" class="screen">
          <div class="section-title">Escolha seu Editor ⭐</div>
          <div class="pill">Você verá editores compatíveis com o seu pedido (avaliação começa em 5 estrelas).</div>

          <div class="toolbar">
            <div class="left">
              <span class="chip" id="pickInfo">Pedido: —</span>
              <span class="chip" id="pickRatingChip">Avaliação: 5/10 ⭐</span>
            </div>
            <div class="right">
              <select id="pickSort" style="min-width:240px">
                <option value="best">Melhores avaliados</option>
                <option value="fast">Mais rápidos (simulado)</option>
              </select>
            </div>
          </div>

          <div id="editorsGrid" class="editor-cards"></div>

          <button class="btn secondary" style="margin-top:18px" type="button" onclick="backToOrder()">Voltar</button>
        
        <!-- ✅ Checkout / Pagamento (BETA) -->
        <section id="screenCheckout" class="screen">
          <div class="section-title">Pagamento (BETA) 💳</div>
          <div class="pill">Confirme o pagamento para liberar o chat do pedido. (No beta, é simulado.)</div>

          <div class="card" style="margin-top:14px">
            <h3 style="margin-top:0">Resumo do pedido</h3>
            <div id="checkoutOrderTitle" style="font-weight:900; font-size:1.12rem">—</div>
            <div id="checkoutOrderMeta" class="pill" style="margin-top:8px">—</div>
            <div class="pill" style="margin-top:10px"><b>Status:</b> <span id="checkoutStatus">Aguardando pagamento</span></div>
          </div>

          <div class="grid" style="margin-top:14px">
            <div class="card">
              <h3 style="margin-top:0">PIX (BETA)</h3>
              <p>Copie o código abaixo e pague no seu banco. Depois clique em <b>“Já paguei (confirmar)”</b>.</p>
              <textarea id="checkoutPixCode" readonly style="width:100%; min-height:120px; resize:none; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:12px; color:var(--text); margin-top:10px"></textarea>
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
                <button class="btn secondary small" type="button" id="btnCopyPix">Copiar PIX</button>
                <button class="btn small" type="button" id="btnConfirmPaid">✅ Já paguei (confirmar)</button>
              </div>
              <div class="hint" style="margin-top:10px">* Beta: isso apenas muda o status do pedido para “Pago”.</div>
            </div>

            <div class="card">
              <h3 style="margin-top:0">Próximo passo</h3>
              <p>Quando o pagamento estiver confirmado, o chat será liberado automaticamente para você enviar arquivos e detalhes.</p>
              <button class="btn" type="button" id="btnOpenOrderChat" disabled>💬 Abrir chat do pedido</button>
              <button class="btn secondary" type="button" style="margin-top:10px" onclick="showScreen(screenClient, true)">Voltar aos pacotes</button>
            </div>
          </div>
        </section>

        <!-- ✅ EDITOR DASHBOARD -->
        <section id="screenEditor" class="screen">
          <div class="section-title">Bem-vindo, <span id="editorName">Editor</span> 👋</div>
          <div class="pill">Complete seu perfil, selecione pacotes e fique disponível para receber pedidos.</div>

          <div class="toolbar" style="margin-top:14px">
            <div class="left">
              <span class="chip">🔎 Marketplace</span>
              <span class="chip">Você também pode explorar clientes (demo)</span>
            </div>
            <div class="right">
<button class="iconBtn" type="button" onclick="openUserMenu('editor')" title="Menu">⋮</button>
<button class="iconBtn" type="button" onclick="openEditorOrders()" title="Pedidos">📦</button>
<button class="iconBtn" type="button" onclick="openEditorMessages()" title="Mensagens">💬</button>
              <button class="btn secondary" type="button" onclick="goProcurarEditor()">Procurar clientes</button>
</div>
          </div>

          <div class="editor-grid">
            <!-- Perfil -->
            <div class="card">
              <div class="profileCover" id="editorCover"></div>
              <div class="row-inline">
                <h3 style="margin:0;color:#c7d2fe">Seu perfil (Editor)</h3>

                <label class="switch" title="Aparecer para clientes">
                  <input id="edAvailable" type="checkbox" />
                  <span class="track"><span class="thumb"></span></span>
                  <span>
                    <div class="label">Disponível</div>
                    <div class="sub" id="edAvailText">Off</div>
                  </span>
                </label>
              </div>

              <div class="who" style="margin-top:12px">
                <div class="avatar" id="editorAvatarBox"></div>
                <div class="meta">
                  <div style="font-weight:900" id="editorFullName">Editor</div>
                  <div class="stars" id="editorStars"></div>
                </div>
              </div>

              <div class="uploadRow">
                <label class="btn secondary small" style="cursor:pointer">
                  Enviar foto
                  <input id="editorPhoto" type="file" accept="image/*" style="display:none">
                </label>
                <button class="btn secondary small" type="button" onclick="removeEditorPhoto()">Remover</button>
                <div class="hint" style="margin-top:0">* Foto opcional (salva no navegador).</div>
              </div>

              <div class="coverControls" style="margin-top:12px">
                <div class="mini-grid">
                  <div class="mini">
                    <label>Plano de fundo (preset)</label>
                    <select id="edCoverPreset">
                      <option value="none">Sem fundo</option>
                      <option value="gold">Dourado suave</option>
                      <option value="amber">Âmbar</option>
                      <option value="graphite">Grafite</option>
                      <option value="sunset">Pôr do sol</option>
                    </select>
                  </div>
                  <div class="mini">
                    <label>Enviar imagem (capa)</label>
                    <input id="edCoverUpload" type="file" accept="image/*" />
                  </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
                  <button class="btn secondary small" type="button" onclick="removeEditorCover()">Remover fundo</button>
                  <div class="hint" style="margin-top:0">* Sua capa aparece no marketplace (Procurar).</div>
                </div>
              </div>

              <div class="kpi">
                <div class="k">
                  <div class="t">Avaliação</div>
                  <div class="v"><span id="edRatingTxt">5.0</span><small>/10</small></div>
                  <div class="stars" id="edStarsRow" style="margin-top:6px"></div>
                </div>
                <div class="k">
                  <div class="t">Concluídos</div>
                  <div class="v"><span id="edDone">0</span><small> pedidos</small></div>
                </div>
                <div class="k">
                  <div class="t">Status</div>
                  <div class="v"><span id="edStatus">Novo</span></div>
                </div>
              </div>

              <div class="mini-grid" style="margin-top:12px">
                <div class="mini">
                  <label>Experiência</label>
                  <select id="edXp">
                    <option value="iniciante">Iniciante</option>
                    <option value="intermediario">Intermediário</option>
                    <option value="avancado">Avançado</option>
                  </select>
                </div>
                <div class="mini">
                  <label>WhatsApp (opcional)</label>
                  <input id="edWhats" placeholder="(DDD) 99999-9999" maxlength="15" inputmode="tel" />
                </div>
              </div>

              <div class="field" style="margin-top:10px">
                <label>Bio (curta e forte)</label>
                <textarea id="edBio" placeholder="Ex: cortes rápidos + cor cinematográfica + áudio limpo. Especialista em Reels e TikTok." maxlength="320"></textarea>
              </div>

              <div class="mini-grid" style="margin-top:10px">
                <div class="mini">
                  <label>Softwares</label>
                  <input id="edSoft" placeholder="CapCut, Premiere, Lightroom..." maxlength="80" />
                </div>
                <div class="mini">
                  <label>Portfólio (link)</label>
                  <input id="edPortfolio" placeholder="https://..." maxlength="120" inputmode="url" />
                </div>
              </div>

              <div class="field" style="margin-top:10px">
                <label>Tags (separe por vírgula)</label>
                <input id="edTags" placeholder="Reels, TikTok, Motion, Cor cine, Foto pro, Áudio..." maxlength="120" />
                <div id="edTagsPreview" class="tags"></div>
              </div>

              <div class="mini-grid" style="margin-top:12px">
                <button class="btn" type="button" onclick="saveEditorProfile()">Salvar perfil</button>
                <button class="btn secondary" type="button" onclick="resetEditor()">Reset (demo)</button>
              </div>

              <!-- Preview público (movido para cima) -->
              <div class="section-title" style="margin:18px 0 8px">Como você aparece para o cliente</div>
              <div class="pill" style="margin:0 0 10px">Esse é o card que vai aparecer na tela de escolha do editor.</div>
              <div class="previewLarge" style="margin-top:10px">
                <div class="eCard previewCard" id="edPublicPreview"></div>
              </div>

              <!-- Portfólio do Editor (demo) -->
              <div class="section-title" style="margin:18px 0 8px">Portfólio (trabalhos)</div>
              <div class="pill" style="margin:0 0 10px">Carregue até <strong>30 fotos</strong> e <strong>10 vídeos</strong> para mostrar aos clientes (demo: não salva no navegador).</div>

              <div class="mini-grid" style="margin-top:10px">
                <label class="btn secondary small" style="cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px">
                  Enviar fotos (até 30)
                  <input id="edWorkPhotos" type="file" accept="image/*" multiple style="display:none" />
                </label>
                <label class="btn secondary small" style="cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px">
                  Enviar vídeos (até 10)
                  <input id="edWorkVideos" type="file" accept="video/*" multiple style="display:none" />
                </label>
              </div>
              <div class="hint" id="edWorkCount" style="margin-top:10px">0/30 fotos • 0/10 vídeos</div>
              <div id="edWorkGrid" class="work-grid"></div>
              <button class="btn secondary small" type="button" style="margin-top:10px" onclick="clearEditorWorks()">Limpar portfólio</button>

              <div class="hint">
                * Comissão é fixa e só aparece no painel ADM no futuro (Karameloo 19% / Editor 81%).
              </div>
            </div>

            <!-- Pacotes -->
            <div class="card">
              <h3>Pacotes que você quer trabalhar</h3>
              <p>Marque os pacotes que você aceita. Assim você só aparece em pedidos compatíveis.</p>

              <div class="mini-grid" style="margin-top:10px">
                <div class="mini">
                  <label>Buscar pacote</label>
                  <input id="edSearchPkg" placeholder="Ex: Foto, Short, 45s..." maxlength="40" />
                </div>
                <div class="mini">
                  <label>Atalhos</label>
                  <select id="edQuick">
                    <option value="all">—</option>
                    <option value="video">Só Vídeo</option>
                    <option value="foto">Só Foto</option>
                    <option value="mix">Mix (Foto + Vídeo)</option>
                    <option value="audio">Áudio</option>
                  </select>
                </div>
              </div>

              <div id="editorPackages" class="pkg-list"></div>

              <!-- ✅ BOTÃO SETA: mostra só 5 e abre o resto -->
              <div class="moreRow">
                <button class="btn secondary small" id="toggleMorePkgs" type="button" onclick="toggleMorePackages()">
                  Ver mais pacotes ↓
                </button>
              </div>

              <div class="total-box" style="margin-top:12px">
                <div class="total-line">
                  <span>Selecionados</span>
                  <strong id="edPkgCount">0</strong>
                </div>
                <div class="total-sub" id="edPkgHint">Dica: selecione pelo menos 1 pacote para aparecer para clientes.</div>
              </div>

              <div class="mini-grid" style="margin-top:12px">
                <button class="btn" type="button" onclick="saveEditorPackages()">Salvar pacotes</button>
                <button class="btn secondary" type="button" onclick="selectAllEditorPackages(true)">Marcar todos</button>
              </div>
              <button class="btn secondary" type="button" onclick="selectAllEditorPackages(false)" style="margin-top:10px">Desmarcar todos</button>

              <div class="hint">* Sem backend: isso é salvo no seu navegador (LocalStorage).</div>
            </div>
          </div>
        </section>

      </div>
    </main>

    <footer>© 2026 • Karameloo • Edição profissional</footer>
  </div>

  <!-- AUTH (tela inteira: Registro / Login) -->
  <section id="screenAuth" class="screen">
    <div class="authFull">
      <div class="authFullCard" role="region" aria-label="Autenticação">
        <div class="authTopBar">
          <strong id="titleCadastro">Criar conta</strong>
          <button class="close" type="button" onclick="closeCadastro()" aria-label="Voltar">×</button>
        </div>
        <div class="authFullBody">
<div class="rolePicker" id="rolePicker" aria-label="Tipo de conta">
          <button class="roleBtn" type="button" data-role="cliente">Cliente</button>
          <button class="roleBtn" type="button" data-role="editor">Editor</button>
        </div>
        <div class="authWrap" id="authWrap">
          <!-- Cadastro -->
          <div class="authView active" data-view="register" id="viewRegister">
            <div class="field"><label>Nome</label><input id="inNome" placeholder="Seu nome" maxlength="30" autocomplete="given-name" /></div>
            <div class="field"><label>Sobrenome</label><input id="inSobrenome" placeholder="Seu sobrenome" maxlength="30" autocomplete="family-name" /></div>
            <div class="field"><label>Data de nascimento</label><input id="inData" type="date" /></div>
            <div class="field"><label>CPF</label><input id="inCPF" inputmode="numeric" placeholder="000.000.000-00" maxlength="14" autocomplete="off" /></div>
            <div class="field"><label>Email</label><input id="inEmail" type="email" placeholder="seuemail@gmail.com" maxlength="80" autocomplete="email" /></div>
                        <div class="field"><label>Senha</label>
              <div class="passWrap">
                <input id="inSenha" type="password" placeholder="••••••••" maxlength="32" autocomplete="new-password" />
                <button class="passToggle" type="button" aria-label="Mostrar senha" onclick="togglePass('inSenha', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/></svg></button>
              </div>
            </div>
            <div class="field"><label>Confirmar senha</label>
              <div class="passWrap">
                <input id="inSenha2" type="password" placeholder="••••••••" maxlength="32" autocomplete="new-password" />
                <button class="passToggle" type="button" aria-label="Mostrar senha" onclick="togglePass('inSenha2', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/></svg></button>
              </div>
            </div>

            <div class="authLinks">
              <button class="linkBtn" type="button" id="toLogin">Já tenho conta</button>
            </div>

            <button id="btnCadastrar" class="btn" type="button">Continuar</button>
            <button class="btn secondary" type="button" onclick="alert('Entrar com Google: em breve (precisa backend).')">Entrar com Google (em breve)</button>
            <div class="hint">* Login real com Google e segurança total entram na etapa futura (backend).</div>
          </div>

          <!-- Login -->
          <div class="authView" data-view="login" id="viewLogin">
            <div class="field"><label>Email</label><input id="loginEmail" type="email" placeholder="seuemail@gmail.com" maxlength="80" autocomplete="email" /></div>
                        <div class="field"><label>Senha</label>
              <div class="passWrap">
                <input id="loginSenha" type="password" placeholder="••••••••" maxlength="32" autocomplete="current-password" />
                <button class="passToggle" type="button" aria-label="Mostrar senha" onclick="togglePass('loginSenha', this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/></svg></button>
              </div>
            </div>

            <div class="authLinks" style="margin-top:6px">
              <button class="linkBtn" type="button" id="toRegister">Não tenho conta</button>
            </div>

            <button id="btnLogin" class="btn" type="button">Entrar</button>
            <div class="hint">* Demo sem backend: login valida os dados salvos neste navegador.</div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </section>

<!-- IA Karameloo (demo local) -->
  <button class="aiFab" id="aiFab" aria-label="Abrir IA Karameloo">
    <span class="dot" aria-hidden="true"></span>
    <span>IA</span>
  </button>

  <section class="aiPanel" id="aiPanel" aria-hidden="true">
    <div class="aiHead">
      <div>
        <div class="aiTitle">IA Karameloo</div>
        <div class="aiSub" id="aiSub">Ajuda para Cliente, Editor e novos usuários</div>
      </div>
      <button class="aiClose" id="aiClose" type="button" aria-label="Fechar">×</button>
    </div>
    <div class="aiChips" id="aiChips">
      <button type="button" data-ai="novo">Primeiros passos</button>
      <button type="button" data-ai="cliente">Sou Cliente</button>
      <button type="button" data-ai="editor">Sou Editor</button>
      <button type="button" data-ai="pacotes">Sugestão de pacotes</button>
      <button type="button" data-ai="bio">Bio/Tags</button>
    </div>
    <div class="aiMsgs" id="aiMsgs" aria-live="polite"></div>
    <form class="aiForm" id="aiForm">
      <input class="aiInput" id="aiInput" placeholder="Pergunte algo..." autocomplete="off" />
      <button class="aiSend" type="submit">Enviar</button>
    </form>
  </section>

  <script>
    // ===== Util =====
    const MAX_STARS = 10;
    

    // ===== Supabase (Auth + Banco) =====
    // IMPORTANTE: anon key é pública. NUNCA coloque a service_role no frontend.
    const SUPABASE_URL = "https://qnraiayglvluzhuyigje.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_6P7JM9YccqYP2vPXNXOPdw_ogHZWqXF";
    const supaLib = window.supabase;
    const supaClient = (supaLib && typeof supaLib.createClient === 'function')
      ? supaLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;
    const SUPABASE_ENABLED = !!supaClient;

    async function sha256Hex(str){
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
      const bytes = Array.from(new Uint8Array(buf));
      return bytes.map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function supaEnsureProfileAndCpf({ userId, displayName, roleValue, cpfDigitsOnly }){
      // 1) profile
      const { error: pErr } = await supaClient
        .from('profiles')
        .upsert({ user_id: userId, display_name: displayName, role: roleValue }, { onConflict: 'user_id' });
      if(pErr) throw pErr;

      // 2) cpf (hash + last4). Sem armazenar CPF puro.
      if(cpfDigitsOnly){
        const cpfHash = await sha256Hex(String(cpfDigitsOnly));
        const last4 = String(cpfDigitsOnly).slice(-4);
        const { error: cErr } = await supaClient
          .from('user_cpf')
          .upsert({ user_id: userId, cpf_hash: cpfHash, cpf_last4: last4 }, { onConflict: 'user_id' });
        if(cErr) throw cErr;
      }
    }

    async function supaRegisterFlow({ nome, sobrenome, dob, cpfD, email, senha, roleUi }){
      if(!SUPABASE_ENABLED) throw new Error('Supabase não inicializou.');

      const displayName = `${nome} ${sobrenome}`.trim();
      const roleValue = (roleUi === 'cliente') ? 'client' : 'editor';

      const { data, error } = await supaClient.auth.signUp({
        email,
        password: senha,
        options: { data: { display_name: displayName, role: roleValue } }
      });
      if(error) throw error;

      // Se confirmação de email estiver ligada, pode não vir sessão.
      if(!data?.session || !data?.user){
        alert('Conta criada! Agora confirme o email para ativar e depois faça login.');
        return { ok:false, needsConfirm:true };
      }

      // cria profile + cpf
      await supaEnsureProfileAndCpf({
        userId: data.user.id,
        displayName,
        roleValue,
        cpfDigitsOnly: cpfD
      });

      // cria row de editor (opcional) pra aparecer na busca
      if(roleValue === 'editor'){
        const { error: eErr } = await supaClient
          .from('editors')
          .upsert({ user_id: data.user.id, headline: 'Editor', bio: '', skills: [], is_active: true }, { onConflict: 'user_id' });
        if(eErr) console.warn('Falha ao criar editor row:', eErr.message);
      }

      return { ok:true, roleValue };
    }

    async function supaLoginFlow({ email, senha }){
      if(!SUPABASE_ENABLED) throw new Error('Supabase não inicializou.');

      const { data, error } = await supaClient.auth.signInWithSenha({ email, password: senha });
      if(error) throw error;

      const userId = data?.user?.id;
      if(!userId) throw new Error('Login ok, mas não retornou user.');

      const { data: prof, error: profErr } = await supaClient
        .from('profiles')
        .select('user_id, display_name, role')
        .eq('user_id', userId)
        .maybeSingle();
      if(profErr) throw profErr;

      const { data: cpfRow } = await supaClient
        .from('user_cpf')
        .select('cpf_last4')
        .eq('user_id', userId)
        .maybeSingle();

      return { userId, profile: prof || null, cpf_last4: cpfRow?.cpf_last4 || null };
    }

    // Cria pedido no Supabase (MVP): salva como DRAFT e SEM total_cents (o total real será calculado no backend depois)
    async function supaCreateOrderFlow(order){
      if(!SUPABASE_ENABLED) throw new Error('Supabase não inicializou.');

      const { data: uData, error: uErr } = await supaClient.auth.getUser();
      if(uErr) throw uErr;
      const user = uData?.user;
      if(!user) throw new Error('Você precisa estar logado para criar pedido.');

      const packageCode = (order?.kind === 'package')
        ? `PACOTE_${order.packageId}`
        : 'CUSTOM';

      // payload guarda tudo (inclusive o total estimado do frontend), mas NÃO é usado como fonte de verdade para pagamento
      const payload = { ...order };

      const { data, error } = await supaClient
        .from('orders')
        .insert({
          client_id: user.id,
          package_code: packageCode,
          payload,
          total_cents: null,
          status: 'DRAFT'
        })
        .select('id, created_at')
        .single();

      if(error) throw error;
      return data; // {id, created_at}
    }


const START_STARS = 5.0;

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function brl(v){ return Number(v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }

    function renderStarsHTML(value, max=MAX_STARS){
      const v = Math.max(0, Math.min(max, Number(value||0)));
      const full = Math.round(v);
      let html = "";
      for(let i=0;i<full;i++) html += `<span class="star">★</span>`;
      for(let i=full;i<max;i++) html += `<span class="star off">★</span>`;
      html += `<small>${v.toFixed(1)}/${max}</small>`;
      return html;
    }

    function setAvatar(el, photoDataUrl, fallbackText){
      if(!el) return;
      el.innerHTML = "";
      if(photoDataUrl){
        const img = document.createElement("img");
        img.src = photoDataUrl;
        el.appendChild(img);
      }else{
        el.textContent = (fallbackText || "K").slice(0,1).toUpperCase();
      }
    }

    function readFileAsDataURL(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(String(r.result||""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }


    // ===== Sessão (para permitir "Sair" sem apagar seus dados) =====
    const LS_SESSION = 'karameloo_session_v1';
    function getSession(){
      return lsGet(LS_SESSION, { active:null, clientEmail:'', editorEmail:'' });
    }
    function setSession(s){ lsSet(LS_SESSION, s); }
    function setActiveSession(kind){
      const s = getSession();
      if(kind==='cliente'){ s.active='cliente'; s.clientEmail = clientData?.email || s.clientEmail || ''; }
      if(kind==='editor'){ s.active='editor'; s.editorEmail = editorData?.email || s.editorEmail || ''; }
      setSession(s);
    }
    function logoutSession(){
      const s = getSession();
      s.active = null;
      setSession(s);
      try{ selectedEditorFromProcurar = null; }catch(e){}
      try{ (function(){const __ci=document.getElementById('chatInput'); if(__ci) __ci.value='';})(); }catch(e){}
    }
    function isClientLogged(){
      const s = getSession();
      return s.active==='cliente' && !!(s.clientEmail);
    }
    function isEditorLogged(){
      const s = getSession();
      return s.active==='editor' && !!(s.editorEmail);
    }

    // ===== Moderação (frontend básico + ganchos para backend) =====
    async function moderateText(text){
      const t = String(text||'').trim();
      if(!t) return { ok:true };

      // 1) tenta backend (se existir)
      try{
        if(typeof apiBase==='function' && apiBase()){
          const r = await apiFetch('/api/moderate/text', { method:'POST', body: JSON.stringify({ text:t }) });
          if(typeof r?.ok==='boolean') return r;
        }
      }catch(e){ /* fallback */ }

      // 2) fallback local (não é perfeito)
      const bad = [
        'porn','porno','putaria','p*','sexo','nude','nudes','pelado','pelada','xereca','pinto','buceta','caralho','fds','foda','foder',
        'estupr','pedofil','cp','gore','suicid',
      ];
      const low = t.toLowerCase();
      const hit = bad.find(w => low.includes(w));
      if(hit){
        return { ok:false, reason:'Mensagem bloqueada por linguagem imprópria (demo).'};
      }
      return { ok:true };
    }

    async function moderateImageDataUrl(dataUrl){
      const img = String(dataUrl||'');
      if(!img.startsWith('data:image/')) return { ok:true };

      // 1) tenta backend (se existir)
      try{
        if(typeof apiBase==='function' && apiBase()){
          const r = await apiFetch('/api/moderate/image', { method:'POST', body: JSON.stringify({ image: img }) });
          if(typeof r?.ok==='boolean') return r;
        }
      }catch(e){ /* fallback */ }

      // 2) fallback local: checagem simples (tamanho + heurística leve)
      // OBS: isso NÃO garante 100% — moderação forte precisa de backend.
      const approxBytes = Math.floor((img.split(',')[1]||'').length * 0.75);
      if(approxBytes > 2_200_000){
        return { ok:false, reason:'Imagem muito pesada. Envie uma imagem menor (até ~2MB).'};
      }
      // Heurística: se muita área com tons de pele + pouca variação, sinaliza (pode dar falso positivo).
      try{
        const im = await new Promise((res, rej)=>{
          const i = new Image();
          i.onload = ()=>res(i);
          i.onerror = rej;
          i.src = img;
        });
        const c = document.createElement('canvas');
        const w = 96;
        const h = Math.max(48, Math.round((im.height/im.width)*w));
        c.width = w;
        c.height = h;
        const ctx = c.getContext('2d', { willReadFrequently:true });
        ctx.drawImage(im, 0, 0, w, h);
        const d = ctx.getImageData(0,0,w,h).data;
        let skin=0, total=0;
        for(let p=0; p<d.length; p+=16){
          const r=d[p], g=d[p+1], b=d[p+2];
          const maxv=Math.max(r,g,b), minv=Math.min(r,g,b);
          const lum = (0.2126*r+0.7152*g+0.0722*b);
          const cond = (r>95 && g>40 && b>20 && (maxv-minv)>15 && Math.abs(r-g)>15 && r>g && r>b && lum>60);
          total++;
          if(cond) skin++;
        }
        const ratio = skin/Math.max(1,total);
        if(ratio > 0.42){
          return { ok:false, reason:'Imagem suspeita de conteúdo sensível (demo).'};
        }
      }catch(e){ /* ignora */ }

      return { ok:true };
    }

    async function checkAndReadImage(file){
      const data = await readFileAsDataURL(file);
      const m = await moderateImageDataUrl(data);
      if(!m.ok) throw new Error(m.reason || 'Imagem bloqueada');
      return data;
    }

    // ===== Capas (plano de fundo do perfil) =====
    function pkgPattern(seed){
      const n = Number(seed||1) || 1;
      const deg = (n*37)%180;
      const a = (n%3===0) ? 'rgba(255,224,138,.10)' : (n%3===1 ? 'rgba(255,193,61,.10)' : 'rgba(56,189,248,.08)');
      return `repeating-linear-gradient(${deg}deg, ${a} 0, ${a} 1px, transparent 1px, transparent 10px)`;
    }

    function presetToCover(preset){
      const p = String(preset||'none');
      if(p==='gold') return 'radial-gradient(1200px 220px at 20% 0%, rgba(255,224,138,.32), transparent 60%), radial-gradient(900px 240px at 80% 20%, rgba(255,193,61,.22), transparent 55%), linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02))';
      if(p==='amber') return 'radial-gradient(900px 220px at 20% 0%, rgba(255,193,61,.30), transparent 60%), radial-gradient(900px 240px at 80% 20%, rgba(255,224,138,.18), transparent 55%), linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))';
      if(p==='sunset') return 'radial-gradient(900px 220px at 15% 0%, rgba(255,120,120,.22), transparent 60%), radial-gradient(900px 240px at 80% 20%, rgba(255,193,61,.20), transparent 55%), linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))';
      if(p==='graphite') return 'radial-gradient(900px 220px at 20% 0%, rgba(255,224,138,.14), transparent 60%), linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.18))';
      return '';
    }
    function applyCoverToEl(el, cover){
      if(!el) return;
      if(cover?.img){
        el.style.backgroundImage = `url(${cover.img})`;
      }else if(cover?.preset && cover.preset!=='none'){
        el.style.backgroundImage = presetToCover(cover.preset);
      }else{
        el.style.backgroundImage = '';
      }
    }

    function syncClientCoverControls(){
      const preset = document.getElementById('clCoverPreset');
      const up = document.getElementById('clCoverUpload');
      applyCoverToEl(document.getElementById('clientCover'), clientData?.cover);
      if(preset) preset.value = clientData?.cover?.preset || 'none';
      if(!clientData) return;
      // evita perder imagem se usuário trocar preset
      if(clientData.cover && !clientData.cover.preset) clientData.cover.preset = 'none';
    }

    function syncEditorCoverControls(){
      const preset = document.getElementById('edCoverPreset');
      const up = document.getElementById('edCoverUpload');
      applyCoverToEl(document.getElementById('editorCover'), editorData?.cover);
      if(preset) preset.value = editorData?.cover?.preset || 'none';
      if(!editorData) return;
      if(editorData.cover && !editorData.cover.preset) editorData.cover.preset = 'none';
    }

    async function onClientCoverPreset(){
      if(!clientData) return;
      const preset = document.getElementById('clCoverPreset');
      const v = preset ? preset.value : 'none';
      clientData.cover = { preset:v, img:'' };
      lsSet(LS_CLIENT, clientData);
      applyCoverToEl(document.getElementById('clientCover'), clientData.cover);
    }

    async function onEditorCoverPreset(){
      if(!editorData) return;
      const preset = document.getElementById('edCoverPreset');
      const v = preset ? preset.value : 'none';
      editorData.cover = { preset:v, img:'' };
      lsSet(LS_EDITOR, editorData);
      persistEditorToAccount();
      applyCoverToEl(document.getElementById('editorCover'), editorData.cover);
    }

    async function onClientCoverUpload(ev){
      const file = ev?.target?.files?.[0];
      if(!file || !clientData) return;
      try{
        const data = await checkAndReadImage(file);
        clientData.cover = { preset:'none', img:data };
        lsSet(LS_CLIENT, clientData);
        applyCoverToEl(document.getElementById('clientCover'), clientData.cover);
      }catch(err){
        alert(String(err.message||err));
        ev.target.value='';
      }
    }

    async function onEditorCoverUpload(ev){
      const file = ev?.target?.files?.[0];
      if(!file || !editorData) return;
      try{
        const data = await checkAndReadImage(file);
        editorData.cover = { preset:'none', img:data };
        lsSet(LS_EDITOR, editorData);
        persistEditorToAccount();
        applyCoverToEl(document.getElementById('editorCover'), editorData.cover);
      }catch(err){
        alert(String(err.message||err));
        ev.target.value='';
      }
    }

    function removeClientCover(){
      if(!clientData) return;
      clientData.cover = { preset:'none', img:'' };
      lsSet(LS_CLIENT, clientData);
      applyCoverToEl(document.getElementById('clientCover'), clientData.cover);
    }

    function removeEditorCover(){
      if(!editorData) return;
      editorData.cover = { preset:'none', img:'' };
      lsSet(LS_EDITOR, editorData);
      persistEditorToAccount();
      applyCoverToEl(document.getElementById('editorCover'), editorData.cover);
    }

    // ===== Menu do usuário =====
    const menuOverlay = document.getElementById('menuOverlay');
    const menuModal = document.getElementById('menuModal');
    const menuTitle = document.getElementById('menuTitle');
    const menuBody = document.getElementById('menuBody');
    let menuCtxRole = 'cliente';

    
    // ✅ Atalhos do Editor (fora do menu): Pedidos / Mensagens
    function openEditorOrders(){
      try{
        openUserMenu('editor');
        setTimeout(()=>{ if(typeof renderUserMenuOrders==='function') renderUserMenuOrders(); }, 30);
      }catch(e){}
    }
    function openEditorMessages(){
      try{
        openUserMenu('editor');
        setTimeout(()=>{ if(typeof renderUserMenuMessages==='function') renderUserMenuMessages(); }, 30);
      }catch(e){}
    }

function openUserMenu(r){
      menuCtxRole = (r==='editor') ? 'editor' : 'cliente';
      renderUserMenuHome();
      // garante que o menu fique preso na viewport (fora de containers com transform)
      try{
        if(menuOverlay && menuOverlay.parentElement !== document.body){
          document.body.appendChild(menuOverlay);
        }
      }catch(e){}
      if(menuOverlay){
        menuOverlay.classList.remove('closing');
        menuOverlay.classList.add('show');
        menuOverlay.setAttribute('aria-hidden','false');
      }
      // trava o scroll do fundo enquanto o menu estiver aberto
      document.body.style.overflow = 'hidden';
      // Re-dispara animação do modal (evita bug de só escurecer após fechar 1x)
      if(menuModal){
        menuModal.classList.remove('closing');
        menuModal.style.animation = 'none';
        // força reflow
        void menuModal.offsetHeight;
        menuModal.style.animation = '';
      }
    }
    function closeUserMenu(){
      if(!menuOverlay) return;
      menuOverlay.classList.add('closing');
      menuModal?.classList.add('closing');
      setTimeout(()=>{
        menuOverlay.classList.remove('show','closing');
        menuModal?.classList.remove('closing');
        menuOverlay.setAttribute('aria-hidden','true');
        // destrava scroll
        document.body.style.overflow = '';
      }, 220);
    }
    menuOverlay?.addEventListener('click', (e)=>{ if(e.target===menuOverlay) closeUserMenu(); });

    function menuBackBtn(label, fn){
      return `<div class="menuBack"><button class="btn secondary small" type="button" onclick="${fn}">← Voltar</button><span class="chip">${label}</span></div>`;
    }

    function setMenuHTML(htmlStr){
      if(!menuBody) return;
      menuBody.classList.remove('swap');
      void menuBody.offsetHeight;
      menuBody.classList.add('swap');
      menuBody.innerHTML = htmlStr;
    }

    function renderUserMenuHome(){
      if(!menuBody) return;
      if(menuTitle) menuTitle.textContent = 'Menu';

      const isClient = menuCtxRole==='cliente';
      const cpf = (isClient ? clientData?.cpf : editorData?.cpf) || '';
      const otherEmail = cpf ? (isClient ? findEmailByCPF('editor', cpf) : findEmailByCPF('client', cpf)) : null;
      const canSwitch = !!otherEmail;

      // Sempre mostra a opção de mudar de modo:
      // - Se já existir conta do outro tipo (mesmo CPF neste navegador), troca direto.
      // - Se não existir, abre o cadastro já no modo correto.
      const switchBtn = (()=>{
        if(isClient){
          if(canSwitch){
            return `
              <button class="menuBtn" type="button" onclick="becomeEditorFromClient()">
                <span>Entrar como Editor/Vendedor</span>
                <small>Trocar modo</small>
              </button>`;
          }
          return `
            <button class="menuBtn" type="button" onclick="becomeEditorFromClient();">
              <span>Trocar para Editor</span>
              <small>Sem relogar</small>
            </button>`;
        } else {
          if(canSwitch){
            return `
              <button class="menuBtn" type="button" onclick="switchToClientFromEditor()">
                <span>Trocar para Cliente</span>
                <small>Sem relogar</small>
              </button>`;
          }
          return `
            <button class="menuBtn" type="button" onclick="switchToClientFromEditor()">
              <span>Trocar para Cliente</span>
              <small>Sem relogar</small>
            </button>`;
        }
      })();

      setMenuHTML(`
        <div class="menuList">
          ${switchBtn}
          <button class="menuBtn" type="button" onclick="renderUserMenuSettings()">
            <span>Configurações</span><small>Conta & perfil</small>
          </button>
          <button class="menuBtn" type="button" onclick="renderUserMenuPrivacy()">
            <span>Privacidade</span><small>Dados & segurança</small>
          </button>
          <button class="menuBtn" type="button" onclick="renderUserMenuTerms()">
            <span>Termos de uso</span><small>Regras do app</small>
          </button>
          ${isClient ? `
          <button class="menuBtn menuDanger" type="button" onclick="logoutAndGoStart()">
            <span>Sair</span>
            <small>Encerrar sessão</small>
          </button>
          ` : `
          <button class="menuBtn menuDanger" type="button" onclick="logoutAndGoStart()">
            <span>Sair</span>
            <small>Encerrar sessão</small>
          </button>
          `}
          <div class="noteWarn">
            <strong>Importante:</strong> o filtro de mensagens/imagens aqui é <em>demo</em>.
            Para ficar forte de verdade, a moderação com IA deve rodar no <strong>backend</strong>.
          </div>
        </div>`);
    }

    function renderUserMenuSettings(){
      if(!menuBody) return;
      if(menuTitle) menuTitle.textContent = 'Configurações';
      const isClient = menuCtxRole==='cliente';
      setMenuHTML(`
        ${menuBackBtn('Configurações', 'renderUserMenuHome()')}
        <div class="card" style="margin:0">
          <h3 style="margin-top:0">Preferências do perfil</h3>
          <p style="opacity:.9; margin:8px 0 0">Você pode trocar a foto e a capa do seu perfil na própria tela de perfil.</p>
          <div class="pill" style="margin-top:10px">Dica: use uma capa clara para destacar seus cards no Procurar.</div>
        </div>`);
    }

    function renderUserMenuPrivacy(){
      if(!menuBody) return;
      if(menuTitle) menuTitle.textContent = 'Privacidade';
      setMenuHTML(`
        ${menuBackBtn('Privacidade', 'renderUserMenuHome()')}
        <div class="card" style="margin:0">
          <h3 style="margin-top:0">Privacidade (demo)</h3>
          <p style="opacity:.92">
            • Suas informações ficam salvas apenas no seu navegador (LocalStorage).
            <br>• Para um site real: precisa backend com banco de dados e políticas (LGPD).
            <br>• Chat e moderação fortes também entram no backend.
          </p>
        </div>`);
    }

    function renderUserMenuTerms(){
      if(!menuBody) return;
      if(menuTitle) menuTitle.textContent = 'Termos de uso';
      setMenuHTML(`
        ${menuBackBtn('Termos', 'renderUserMenuHome()')}
        <div class="card" style="margin:0">
          <h3 style="margin-top:0">Termos (resumo)</h3>
          <p style="opacity:.92">
            Ao usar o Karameloo você concorda em não enviar conteúdo ilegal, ofensivo ou impróprio.
            Perfis e mensagens podem ser filtrados e removidos.
            <br><br><strong>Etapa real:</strong> termos completos + moderação com IA no backend.
          </p>
        </div>`);
    }


    function renderUserMenuOrders(){
      if(!menuBody) return;
      if(menuTitle) menuTitle.textContent = 'Pedidos';
      const all = lsGet(LS_ORDERS, []);
      const list = Array.isArray(all) ? all : [];
      const isEditor = menuCtxRole === 'editor';
      const meName = String(editorData?.full || editorData?.first || editorData?.name || 'Editor').trim().toLowerCase();

      let use = list;
      if(isEditor && meName){
        const mine = list.filter(o => String(o?.editor?.name || '').trim().toLowerCase() === meName);
        // Se não achou pedidos “meus” (porque é demo), mostra todos mesmo
        use = mine.length ? mine : list;
      }

      const rows = use.slice(0, 30).map((o, i)=>{
        const title = escapeHtml(o?.title || 'Pedido');
        const client = escapeHtml(o?.client?.name || 'Cliente');
        const total = escapeHtml(o?.totalText || brl(o?.total || 0));
        const eta = escapeHtml(o?.eta || '—');
        const when = new Date(o?.createdAt || Date.now());
        const stamp = escapeHtml(when.toLocaleString('pt-BR'));
        const badge = o?.editor?.name ? `<span class="chip">Editor: ${escapeHtml(o.editor.name)}</span>` : `<span class="chip">Sem editor</span>`;
        return `
          <div class="card" style="margin:0 0 10px">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
              <div style="font-weight:900">${title}</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
                ${badge}
                <span class="chip">${stamp}</span>
              </div>
            </div>
            <div class="pill" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
              <span><b>Cliente:</b> ${client}</span>
              <span><b>Total:</b> ${total}</span>
              <span><b>Entrega:</b> ${eta}</span>
            </div>
          </div>`;
      }).join('');

      setMenuHTML(`
        ${menuBackBtn('Pedidos', 'renderUserMenuHome()')}
        <div class="card" style="margin:0">
          <h3 style="margin-top:0">Pedidos (demo/local)</h3>
          <p style="opacity:.9; margin:8px 0 0">
            Aqui aparecem os pedidos salvos no seu navegador. No backend (Supabase), isso vem do banco.
          </p>
        </div>
        <div style="margin-top:12px">
          ${rows || `<div class="card"><div class="hint">Nenhum pedido por enquanto.</div></div>`}
        </div>
      `);
    }

    function listChatThreads(){
      const out = [];
      try{
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(!k || !String(k).startsWith('karamelo_chat_')) continue;
          const arr = lsGet(k, []);
          const msgs = Array.isArray(arr) ? arr : [];
          const last = msgs.length ? msgs[msgs.length-1] : null;
          out.push({
            key: k,
            ts: last?.ts || 0,
            lastText: String(last?.text || '').slice(0, 80),
            lastFrom: last?.from || ''
          });
        }
      }catch(e){}
      out.sort((a,b)=>(b.ts||0)-(a.ts||0));
      return out;
    }
    function prettyChatTitleFromKey(k){
      // karamelo_chat_<clientId>_<peerId>
      const parts = String(k||'').split('_');
      const peer = parts.slice(3).join('_') || 'conversa';
      return peer.replace(/_/g,' ').slice(0, 28);
    }

    function renderUserMenuMessages(){
      if(!menuBody) return;
      if(menuTitle) menuTitle.textContent = 'Mensagens';
      const threads = listChatThreads();
      const items = threads.slice(0, 25).map(t=>{
        const title = escapeHtml(prettyChatTitleFromKey(t.key));
        const hint = escapeHtml((t.lastFrom==='me' ? 'Você: ' : '') + (t.lastText || 'Abrir conversa'));
        const enc = encodeURIComponent(t.key);
        return `
          <button class="menuBtn" type="button" onclick="renderUserMenuMessageThread('${enc}')">
            <span>${title}</span><small>${hint}</small>
          </button>`;
      }).join('');

      setMenuHTML(`
        ${menuBackBtn('Mensagens', 'renderUserMenuHome()')}
        <div class="card" style="margin:0">
          <h3 style="margin-top:0">Mensagens (demo/local)</h3>
          <p style="opacity:.9; margin:8px 0 0">
            As conversas ficam salvas no seu navegador. No backend, isso vira chat real (com moderação e histórico).
          </p>
        </div>
        <div class="menuList" style="margin-top:12px">
          ${items || `<div class="card"><div class="hint">Nenhuma conversa ainda.</div></div>`}
        </div>
      `);
    }

    function renderUserMenuMessageThread(encKey){
      const key = decodeURIComponent(String(encKey||''));
      if(menuTitle) menuTitle.textContent = 'Mensagens';
      const arr = lsGet(key, []);
      const msgs = Array.isArray(arr) ? arr : [];
      const bubbles = msgs.slice(-50).map(m=>{
        const div = document.createElement('div');
        div.className = 'aiMsg' + (m.from==='me' ? ' me' : '');
        div.textContent = String(m.text || '');
        return div.outerHTML;
      }).join('');

      setMenuHTML(`
        ${menuBackBtn('Mensagens', 'renderUserMenuMessages()')}
        <div class="card" style="margin:0">
          <h3 style="margin-top:0">${escapeHtml(prettyChatTitleFromKey(key))}</h3>
          <div class="hint">Leitura (demo). Envio completo e lista de chats entram no backend.</div>
        </div>
        <div class="card" style="margin-top:12px; padding:0">
          <div style="display:grid; gap:10px; max-height:420px; overflow:auto; padding:12px; border-radius:18px">
            ${bubbles || `<div class="hint">Sem mensagens.</div>`}
          </div>
        </div>
      `);
    }

    function logoutAndGoStart(){
      logoutSession();
      try{ closeEditorProfile(); }catch(e){}
      try{ closeChat(); }catch(e){}
      try{ closeCadastro(); }catch(e){}
      selectedEditorFromProcurar = null;
      currentOrder = null;
      closeUserMenu();
      showScreen(screenStart, true);
    }

    function becomeEditorFromClient(){
      showLoading('Trocando para Editor…','Carregando modo vendedor');
      // Troca para Editor SEM pedir email/senha novamente.
      // No modo demo/local, copiamos a conta do Cliente (se existir) para Editor automaticamente.
      try{
        // Garante que temos um perfil de cliente carregado
        const storedClient = lsGet(LS_CLIENT) || null;
        const baseClientProfile = (clientData && Object.keys(clientData||{}).length ? clientData : storedClient) || {};

        const cpf = (baseClientProfile?.cpf || '').toString();
        let email = (baseClientProfile?.email || '').toString();
        if(!email && cpf){ email = (findEmailByCPF('client', cpf) || '').toString(); }
        email = normEmail(email);

        // Recupera (ou reconstrói) a conta de Cliente
        let clientAcc = null;
        if(email){
          clientAcc = loadAccount('client', email);
        }
        if(!clientAcc){
          // fallback: cria um "account" a partir do perfil salvo (sem bloquear o usuário)
          const fallbackEmail = email || (cpf ? `cliente_${cpf}@local` : 'cliente@local');
          clientAcc = {
            email: normEmail(fallbackEmail),
            pass: '',
            cpf: cpf || '',
            profile: Object.assign({}, baseClientProfile, { email: normEmail(fallbackEmail), cpf: cpf || baseClientProfile?.cpf || '' })
          };
          // salva para manter consistência nas próximas trocas
          saveAccount('client', clientAcc);
        }

        // Se já existe conta editor com o mesmo CPF, usa ela; senão, cria.
        let editorEmail = cpf ? (findEmailByCPF('editor', cpf) || '') : '';
        editorEmail = normEmail(editorEmail || clientAcc.email);

        if(!loadAccount('editor', editorEmail)){
          const editorProfile = Object.assign({}, clientAcc.profile || {});
          editorProfile.cpf = cpf || editorProfile.cpf || '';
          editorProfile.email = editorEmail;
          editorProfile.kind = 'editor';

          saveAccount('editor', {
            email: editorEmail,
            pass: clientAcc.pass || '',
            cpf: (cpf || editorProfile.cpf || ''),
            profile: editorProfile
          });
        }

        const acc = loadAccount('editor', editorEmail);
        if(!acc){
          // última tentativa: não trava — só muda o modo visual
          role = 'editor';
          editorData = Object.assign({}, baseClientProfile, { kind:'editor' });
          lsSet(LS_EDITOR, editorData);
          setActiveSession('editor');
          closeUserMenu();
          showScreen(screenEditor, true);
          hideLoading();
          return;
        }

        role = 'editor';
        applyAccountToSession('editor', acc);
        setActiveSession('editor');
        closeUserMenu();
        showScreen(screenEditor, true);
      hideLoading();
      }catch(e){
        console.error(e);
        // Não trava a navegação por causa de localStorage inconsistente
        try{
          role = 'editor';
          setActiveSession('editor');
          closeUserMenu();
          showScreen(screenEditor, true);
        }catch(_){}
      }
      hideLoading();
    }

    // Compat: se algum lugar ainda chamar isso, mantém funcionando
    function switchToEditorFromClient(){
      becomeEditorFromClient();
    }
    function switchToClientFromEditor(){
      showLoading('Trocando para Cliente…','Carregando modo cliente');
      // Troca para Cliente SEM pedir email/senha novamente.
      // No modo demo/local, copiamos a conta do Editor (se existir) para Cliente automaticamente.
      try{
        const storedEditor = lsGet(LS_EDITOR) || null;
        const baseEditorProfile = (editorData && Object.keys(editorData||{}).length ? editorData : storedEditor) || {};

        const cpf = (baseEditorProfile?.cpf || '').toString();
        let email = (baseEditorProfile?.email || '').toString();
        if(!email && cpf){ email = (findEmailByCPF('editor', cpf) || '').toString(); }
        email = normEmail(email);

        // Recupera (ou reconstrói) a conta de Editor
        let editorAcc = null;
        if(email){
          editorAcc = loadAccount('editor', email);
        }
        if(!editorAcc){
          const fallbackEmail = email || (cpf ? `editor_${cpf}@local` : 'editor@local');
          editorAcc = {
            email: normEmail(fallbackEmail),
            pass: '',
            cpf: cpf || '',
            profile: Object.assign({}, baseEditorProfile, { email: normEmail(fallbackEmail), cpf: cpf || baseEditorProfile?.cpf || '' })
          };
          saveAccount('editor', editorAcc);
        }

        // Se já existe conta cliente com o mesmo CPF, usa ela; senão, cria.
        let clientEmail = cpf ? (findEmailByCPF('client', cpf) || '') : '';
        clientEmail = normEmail(clientEmail || editorAcc.email);

        if(!loadAccount('client', clientEmail)){
          const clientProfile = Object.assign({}, editorAcc.profile || {});
          clientProfile.cpf = cpf || clientProfile.cpf || '';
          clientProfile.email = clientEmail;
          clientProfile.kind = 'client';

          saveAccount('client', {
            email: clientEmail,
            pass: editorAcc.pass || '',
            cpf: (cpf || clientProfile.cpf || ''),
            profile: clientProfile
          });
        }

        const acc = loadAccount('client', clientEmail);
        if(!acc){
          // última tentativa: não trava — só muda o modo visual
          role = 'client';
          clientData = Object.assign({}, baseEditorProfile, { kind:'client' });
          lsSet(LS_CLIENT, clientData);
          setActiveSession('client');
          closeUserMenu();
          showScreen(screenClientProfile, true);
          hideLoading();
          return;
        }

        role = 'client';
        applyAccountToSession('client', acc);
        setActiveSession('client');
        closeUserMenu();
        showScreen(screenClientProfile, true);
      }catch(e){
        console.error(e);
        try{
          role = 'client';
          setActiveSession('client');
          closeUserMenu();
          showScreen(screenClientProfile, true);
        }catch(_){}
      }
      hideLoading();
    }



    function lsGet(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){ return fallback; }
    }
    function lsSet(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
    }


// ===== UI State (BETA) - Persistência para não voltar do início ao recarregar =====
// Salva o mínimo necessário no localStorage (tela atual + seleções + pedido ativo).
const LS_UI_STATE = 'karameloo_ui_state_v1';
let __uiSaveTimer = null;

function uiGetState(){ return lsGet(LS_UI_STATE, null); }
function uiSetState(state){ lsSet(LS_UI_STATE, state); }

function uiScreenIdFromEl(el){
  try{ return el?.id || null; }catch(e){ return null; }
}
function uiCurrentVisibleScreenId(){
  const s = document.querySelector('.screen.show');
  return uiScreenIdFromEl(s) || 'screenStart';
}

function uiSnapshot(){
  // evita exceptions quebrando o site
  let selectedEditor = null;
  try{
    if(typeof selectedEditorFromProcurar !== 'undefined' && selectedEditorFromProcurar){
      selectedEditor = {
        id: selectedEditorFromProcurar.id,
        name: selectedEditorFromProcurar.name,
        rating: selectedEditorFromProcurar.rating ?? selectedEditorFromProcurar.stars ?? null,
        tags: selectedEditorFromProcurar.tags || [],
        packages: selectedEditorFromProcurar.packages || []
      };
    }
  }catch(e){}

  let co = null;
  try{
    // currentOrder é um objeto simples; clonamos pra não levar referências
    co = currentOrder ? JSON.parse(JSON.stringify(currentOrder)) : null;
  }catch(e){
    co = null;
  }

  let ao = null;
  try{ ao = (typeof activeOrderId !== 'undefined') ? (activeOrderId || null) : null; }catch(e){ ao = null; }

  let overlayOpen = false;
  try{ overlayOpen = !!(orderOverlay && orderOverlay.classList.contains('show')); }catch(e){ overlayOpen = false; }

  let chatOpen = false;
  try{ chatOpen = !!(chatOverlay && chatOverlay.classList.contains('show')); }catch(e){ chatOpen = false; }

  return {
    v: 1,
    ts: Date.now(),
    screenId: uiCurrentVisibleScreenId(),
    role: (typeof role !== 'undefined') ? role : null,
    currentOrder: co,
    selectedEditor,
    activeOrderId: ao,
    orderOverlayOpen: overlayOpen,
    chatOverlayOpen: chatOpen
  };
}

function uiSaveNow(){
  try{
    uiSetState(uiSnapshot());
  }catch(e){}
}
function uiSaveDebounced(){
  try{
    if(__uiSaveTimer) clearTimeout(__uiSaveTimer);
    __uiSaveTimer = setTimeout(()=>{ uiSaveNow(); }, 120);
  }catch(e){}
}

function uiRestore(){
  const st = uiGetState();
  if(!st || !st.screenId) return;

  // restaura variáveis principais
  try{ if(st.role) role = st.role; }catch(e){}
  try{
    if(st.selectedEditor){
      selectedEditorFromProcurar = st.selectedEditor;
    }
  }catch(e){}
  try{
    if(st.currentOrder){
      currentOrder = st.currentOrder;
    }
  }catch(e){}
  try{
    if(typeof activeOrderId !== 'undefined' && st.activeOrderId){
      activeOrderId = st.activeOrderId;
    }
  }catch(e){}

  // restaura tela
  try{
    if(st.screenId === 'screenCheckout'){
      const o = (typeof getOrderById === 'function' && (activeOrderId || st.activeOrderId)) ? getOrderById(activeOrderId || st.activeOrderId) : null;
      if(o && typeof showCheckoutForOrder === 'function'){
        showCheckoutForOrder(o);
      }else{
        // fallback
        const el = document.getElementById('screenClientProfile') || document.getElementById('screenStart');
        if(el && typeof showScreen === 'function') showScreen(el, true);
      }
    }else if(st.screenId === 'screenPickEditor'){
      if(currentOrder && typeof startPickEditor === 'function'){
        startPickEditor();
      }else{
        const el = document.getElementById('screenClient') || document.getElementById('screenStart');
        if(el && typeof showScreen === 'function') showScreen(el, true);
      }
    }else if(st.screenId === 'screenClient'){
      try{ if(typeof paintClientTop === 'function') paintClientTop(); }catch(e){}
      try{ if(typeof renderPackages === 'function') renderPackages(); }catch(e){}
      const el = document.getElementById('screenClient');
      if(el && typeof showScreen === 'function') showScreen(el, true);
    }else if(st.screenId === 'screenProcurar'){
      // garante render ao restaurar (evita cards vazios)
      try{ if(typeof renderProcurarEditors === 'function') renderProcurarEditors(); }catch(e){}
      const el = document.getElementById('screenProcurar');
      if(el && typeof showScreen === 'function') showScreen(el, true);
    }else if(st.screenId === 'screenProcurarEditor'){
      try{ if(typeof renderProcurarClients === 'function') renderProcurarClients(); }catch(e){}
      const el = document.getElementById('screenProcurarEditor');
      if(el && typeof showScreen === 'function') showScreen(el, true);
    }else{
      const el = document.getElementById(st.screenId) || document.getElementById('screenStart');
      if(el && typeof showScreen === 'function') showScreen(el, true);
    }
  }catch(e){}

  // reabre overlays se o usuário estava neles
  try{
    if(st.orderOverlayOpen && typeof openOrderConfirm === 'function' && currentOrder){
      openOrderConfirm();
    }
  }catch(e){}
  try{
    if(st.chatOverlayOpen && typeof openChatForOrder === 'function' && (activeOrderId || st.activeOrderId)){
      openChatForOrder(activeOrderId || st.activeOrderId);
    }
  }catch(e){}

  // salva de novo para garantir consistência
  uiSaveDebounced();
}

// salva sempre que sair/atualizar
window.addEventListener('beforeunload', ()=>{ try{ uiSaveNow(); }catch(e){} });

    // ===== Base (screens) =====
    const titleCadastro = document.getElementById('titleCadastro');
    const btnCadastrar = document.getElementById('btnCadastrar');

    const screenStart = document.getElementById('screenStart');
    const screenProcurar = document.getElementById('screenProcurar');
    const screenProcurarEditor = document.getElementById('screenProcurarEditor');
    const screenClientProfile = document.getElementById('screenClientProfile');
    const screenClient = document.getElementById('screenClient');
    const screenPickEditor = document.getElementById('screenPickEditor');
    const screenEditor = document.getElementById('screenEditor');
    const screenAuth = document.getElementById('screenAuth');

        const screenCheckout = document.getElementById('screenCheckout');

const siteHeader = document.getElementById('siteHeader');

    // ===== Global Loader =====
    const globalLoader = document.getElementById('globalLoader');
    const globalLoaderText = document.getElementById('globalLoaderText');
    const globalLoaderSub = document.getElementById('globalLoaderSub');
    let __loaderStart = 0;
    let __loaderHideTimer = null;

    function __nextPaint(){
      return new Promise(r => requestAnimationFrame(()=>requestAnimationFrame(r)));
    }
    function showLoading(msg, sub){
      if(!globalLoader) return;
      if(__loaderHideTimer){ clearTimeout(__loaderHideTimer); __loaderHideTimer = null; }
      __loaderStart = Date.now();
      if(globalLoaderText) globalLoaderText.textContent = msg || 'Carregando…';
      if(globalLoaderSub) globalLoaderSub.textContent = sub || 'Aguarde só um instante';
      globalLoader.classList.add('show');
      globalLoader.setAttribute('aria-hidden','false');
      try{ document.body.classList.add('no-scroll'); }catch(e){}
    }
    function hideLoading(){
      if(!globalLoader) return;
      const minMs = 520;
      const elapsed = Date.now() - (__loaderStart||0);
      const wait = Math.max(0, minMs - elapsed);
      if(__loaderHideTimer) clearTimeout(__loaderHideTimer);
      __loaderHideTimer = setTimeout(()=>{
        globalLoader.classList.remove('show');
        globalLoader.setAttribute('aria-hidden','true');
        try{ document.body.classList.remove('no-scroll'); }catch(e){}
      }, wait);
    }

    // ===== Helpers: open auth with loader + password eye =====
    const __PASS_EYE = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3"/></svg>`;
    const __PASS_EYE_OFF = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-6.5 0-10-7-10-7a20.77 20.77 0 0 1 5.06-5.94"/><path d="M1 1l22 22"/><path d="M9.9 9.9a3 3 0 0 0 4.24 4.24"/><path d="M14.12 14.12 9.88 9.88"/><path d="M12 5c6.5 0 10 7 10 7a20.77 20.77 0 0 1-4.37 5.08"/></svg>`;
    function togglePass(id, btn){
      const el = document.getElementById(id);
      if(!el) return;
      const isPw = (el.type === 'password');
      el.type = isPw ? 'text' : 'password';
      if(btn){
        btn.innerHTML = isPw ? __PASS_EYE_OFF : __PASS_EYE;
        btn.setAttribute('aria-label', isPw ? 'Ocultar senha' : 'Mostrar senha');
      }
    }

    async function openAuth(mode, tipo){
      // Abre a tela de Auth (tela inteira).
      openCadastro(tipo || 'cliente');
      setAuthMode(mode === 'login' ? 'login' : 'register', false);
    }

    const inNome = document.getElementById('inNome');
    const inSobrenome = document.getElementById('inSobrenome');

    const clientName = document.getElementById('clientName');
    const editorName = document.getElementById('editorName');

    let role = null;
    let currentOrder = null;

    // ===== Auth modal (Cadastro/Login) =====
    const authWrap = document.getElementById('authWrap');
    const viewRegister = document.getElementById('viewRegister');
    const viewLogin = document.getElementById('viewLogin');
    const toLogin = document.getElementById('toLogin');
    const toRegister = document.getElementById('toRegister');
    const btnLogin = document.getElementById('btnLogin');

    // Seletor de tipo de conta (Cliente / Editor) dentro do modal
    const rolePicker = document.getElementById('rolePicker');
    const roleBtns = rolePicker ? Array.from(rolePicker.querySelectorAll('.roleBtn')) : [];

    function syncRolePickerVisibility(){
      if(!rolePicker) return;
      // só aparece no cadastro (não muda nada no login)
      rolePicker.style.display = 'flex';
    }

    function setRole(newRole){
      if(!newRole) return;
      role = newRole;
      roleBtns.forEach(b=> b.classList.toggle('active', (b.dataset.role === role)));
      updateAuthTitle();
    }

    roleBtns.forEach(b=> b.addEventListener('click', ()=> setRole(b.dataset.role)));


    const inData = document.getElementById('inData');
    const inCPF = document.getElementById('inCPF');
    const inEmail = document.getElementById('inEmail');
    const inSenha = document.getElementById('inSenha');
    const inSenha2 = document.getElementById('inSenha2');

    const loginEmail = document.getElementById('loginEmail');
    const loginSenha = document.getElementById('loginSenha');

    let authMode = 'register';

    function updateAuthTitle(){
      // título simples (sem "como Cliente/Editor")
      titleCadastro.textContent = (authMode === 'register') ? 'Criar conta' : 'Fazer login';
    }

    // garante que o conteúdo do cadastro/login não fique “cortado” (PC e celular)
    function syncAuthWrapHeight(){
      if(!authWrap) return;
      const active = (authMode === 'register') ? viewRegister : viewLogin;
      if(!active) return;
      authWrap.style.height = `${active.scrollHeight}px`;
    }

    let switchingAuth = false;

    function setAuthMode(mode, animate=true){
      if(!authWrap || mode === authMode || switchingAuth) return;

      const from = (authMode === 'register') ? viewRegister : viewLogin;
      const to   = (mode === 'register') ? viewRegister : viewLogin;
      if(!from || !to) { authMode = mode; updateAuthTitle(); return; }

      switchingAuth = true;

      // limpa classes de animação anteriores
      [from, to].forEach(el=>{
        el.classList.remove('enterLeft','enterRight','leaveLeft','leaveRight','enter-left','enter-right','leave-left','leave-right');
        el.style.zIndex = '';
      });

      // ativa destino e garante stacking correto
      to.classList.add('active');
      to.style.zIndex = '3';
      from.style.zIndex = '2';

      if(!animate){
        from.classList.remove('active');
        authMode = mode;
        updateAuthTitle();
        syncAuthWrapHeight();
        switchingAuth = false;
        return;
      }

      const toLoginDir = (mode === 'login');

      // força reflow pra animação NÃO “pular”
      void to.offsetWidth;

      requestAnimationFrame(()=>{
        // usa os nomes novos (Left/Right) mas também funciona com CSS anterior
        from.classList.add(toLoginDir ? 'leaveLeft' : 'leaveRight');
        to.classList.add(toLoginDir ? 'enterRight' : 'enterLeft');
      });

      authMode = mode;
      updateAuthTitle();
      syncRolePickerVisibility();

      setTimeout(()=>{
        from.classList.remove('active','leaveLeft','leaveRight');
        to.classList.remove('enterLeft','enterRight');
        from.style.zIndex = '';
        to.style.zIndex = '';
        syncAuthWrapHeight();
        switchingAuth = false;
      }, 380);
    }


    function resetAuthUI(){
      switchingAuth = false;
      authMode = 'register';

      viewRegister?.classList.add('active');
      viewLogin?.classList.remove('active');

      [viewRegister, viewLogin].forEach(el=>{
        el?.classList.remove('enterLeft','enterRight','leaveLeft','leaveRight','enter-left','enter-right','leave-left','leave-right');
        if(el) el.style.zIndex = '';
      });

      updateAuthTitle();
      syncRolePickerVisibility();
      // garante destaque correto no seletor
      if(role){ roleBtns?.forEach(b=> b.classList.toggle('active', (b.dataset.role === role))); }
      syncAuthWrapHeight();
    }


    toLogin?.addEventListener('click', ()=> setAuthMode('login', true));
    toRegister?.addEventListener('click', ()=> setAuthMode('register', true));

    // ===== CPF / Idade (demo) =====
    function cpfDigits(v){ return String(v||'').replace(/\D/g,'').slice(0,11); }
    function formatCPF(d){
      d = cpfDigits(d);
      if(d.length<=3) return d;
      if(d.length<=6) return d.slice(0,3)+'.'+d.slice(3);
      if(d.length<=9) return d.slice(0,3)+'.'+d.slice(3,6)+'.'+d.slice(6);
      return d.slice(0,3)+'.'+d.slice(3,6)+'.'+d.slice(6,9)+'-'+d.slice(9);
    }
    function isValidCPF(cpf){
      const d = cpfDigits(cpf);
      if(d.length !== 11) return false;
      if(/^([0-9])\1+$/.test(d)) return false;
      let sum=0; for(let i=0;i<9;i++) sum += parseInt(d.charAt(i),10)*(10-i);
      let check = 11 - (sum % 11); if(check>=10) check=0;
      if(check !== parseInt(d.charAt(9),10)) return false;
      sum=0; for(let i=0;i<10;i++) sum += parseInt(d.charAt(i),10)*(11-i);
      check = 11 - (sum % 11); if(check>=10) check=0;
      return check === parseInt(d.charAt(10),10);
    }
    function calcAge(isoDate){
      if(!isoDate) return NaN;
      const b = new Date(isoDate);
      if(isNaN(b.getTime())) return NaN;
      const n = new Date();
      let age = n.getFullYear() - b.getFullYear();
      const m = n.getMonth() - b.getMonth();
      if(m < 0 || (m===0 && n.getDate() < b.getDate())) age--;
      return age;
    }

    if(inCPF){
      inCPF.addEventListener('input', ()=>{
        const d = cpfDigits(inCPF.value);
        inCPF.value = formatCPF(d);
      });
    }


    function openCadastro(tipo){
      // Tela inteira (sem modal). Loader só aparece quando clicar em Entrar / Criar conta.
      if(typeof setRole === 'function') setRole(tipo || 'cliente'); else role = (tipo || 'cliente');
      resetAuthUI();

      // limpa campos (para nao misturar cadastros)
      if(inNome) inNome.value = '';
      if(inSobrenome) inSobrenome.value = '';
      if(inData) inData.value = '';
      if(inCPF) inCPF.value = '';
      if(inEmail) inEmail.value = '';
      if(inSenha) inSenha.value = '';
      if(inSenha2) inSenha2.value = '';
      if(loginEmail) loginEmail.value = '';
      if(loginSenha) loginSenha.value = '';

      // abre tela de auth
      showScreen(screenAuth, true);
      window.scrollTo(0,0);
      requestAnimationFrame(syncAuthWrapHeight);
    }
    function closeCadastro(){
      // volta para a tela inicial
      showScreen(screenStart, true);
      window.scrollTo(0,0);
    }

    // expõe funções para onclick inline
    window.openAuth = openAuth;
    window.openCadastro = openCadastro;
    window.closeCadastro = closeCadastro;

// ===== START (Login Hero) =====
function startSignIn(){
  const email = (document.getElementById('startEmail')?.value || '').trim();
  const senha = (document.getElementById('startSenha')?.value || '').trim();
  const remember = !!document.getElementById('startRemember')?.checked;

  if(!email || !senha){
    alert('Preencha email e senha.');
    return;
  }

  try{
    if(typeof setRole === 'function') setRole(getStartRole());
    else role = getStartRole();
  }catch(e){}

  try{
    if(remember){
      localStorage.setItem('karameloo_remember_email', email);
    }else{
      localStorage.removeItem('karameloo_remember_email');
    }
  }catch(e){}

  // injeta nos campos reais do login (screenAuth) e dispara o mesmo fluxo
  try{
    if(loginEmail) loginEmail.value = email;
    if(loginSenha) loginSenha.value = senha;
  }catch(e){}

  // dispara o mesmo handler do botão de login
  try{
    if(typeof showLoading === 'function') showLoading('Entrando…','Verificando sua conta');
  }catch(e){}

  try{
    if(btnLogin) btnLogin.click();
    else alert('Erro: botão de login não encontrado.');
  }catch(e){
    alert('Erro ao tentar entrar. Abra o console (F12) para ver detalhes.');
  }
}
window.startSignIn = startSignIn;



// ===== Start screen role toggle (Cliente/Editor) =====
function getStartRole(){
  try{
    return (localStorage.getItem('karameloo_start_role') || 'cliente');
  }catch(e){
    return window.__karameloo_start_role || 'cliente';
  }
}
function setStartRole(r){
  const role = (r === 'editor') ? 'editor' : 'cliente';
  try{ localStorage.setItem('karameloo_start_role', role); }catch(e){ window.__karameloo_start_role = role; }
  try{
    document.querySelectorAll('.startRoleBtn').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.role === role);
    });
  }catch(e){}
  return role;
}
window.getStartRole = getStartRole;
window.setStartRole = setStartRole;

document.addEventListener('DOMContentLoaded', ()=>{
  // trava scroll se começar na tela inicial
  try{
    const ss = document.getElementById('screenStart');
    document.body.classList.toggle('startActive', !!ss && ss.classList.contains('show'));
  }catch(e){}

  try{
    const saved = localStorage.getItem('karameloo_remember_email');
    if(saved){
      const e = document.getElementById('startEmail');
      const r = document.getElementById('startRemember');
      if(e) e.value = saved;
      if(r) r.checked = true;
    }
  }catch(e){}

  // init start role buttons
  try{
    const savedRole = getStartRole();
    document.querySelectorAll('.startRoleBtn').forEach(btn=>{
      btn.addEventListener('click', ()=> setStartRole(btn.dataset.role));
    });
    setStartRole(savedRole);
  }catch(e){}

});

    window.addEventListener('resize', ()=>{
      if(screenAuth && screenAuth.classList.contains('show')) syncAuthWrapHeight();
    });

    function showScreen(which, instant=false){
      // ✅ Segurança: se algum fluxo deixou o site em "betaTabMode", limpa antes de trocar de tela
      try{
        document.body.classList.remove('betaTabMode');
        const r = document.getElementById('betaTabRoot');
        if(r) r.remove();
      }catch(e){}

      const screens = [screenStart, screenProcurar, screenProcurarEditor, screenClientProfile, screenClient, screenPickEditor, screenEditor, screenAuth].filter(Boolean);
      if(!which) { console.warn('showScreen called with null'); return; }

      // Remove "show" de todos, exceto do alvo (evita tela vazia entre trocas)
      screens.forEach(s => { if(s !== which) s.classList.remove('show'); });

      // Header grande só na tela inicial
      if(siteHeader){
        siteHeader.style.display = (which === screenStart) ? '' : 'none';
      }

      // Mostra imediatamente (com animação CSS)
      which.classList.add('show');
      document.body.classList.toggle('startActive', which === screenStart);

      try{
        window.scrollTo({top:0, behavior: instant ? 'auto' : 'smooth'});
      }catch(e){
        window.scrollTo(0,0);
      }

      try{ uiSaveDebounced(); }catch(e){}
    }
    function goBackStart(){ showScreen(screenStart,true); }{ showScreen(screenStart,true); }
    function goStart(){ goBackStart(); }
    function goStartInstant(){ showScreen(screenStart,true); }

    // ===== Storage =====
    const LS_EDITOR = "karamello_editor_v6";
    const LS_CLIENT = "karamello_client_v2";

    const LS_ACCOUNTS = "karamello_accounts_v1";

    function normEmail(v){ return String(v||"").trim().toLowerCase(); }
    function roleKey(){ return (role === "cliente") ? "client" : "editor"; }
    function getAccounts(){ return lsGet(LS_ACCOUNTS, { client:{}, editor:{} }); }
    function setAccounts(obj){ lsSet(LS_ACCOUNTS, obj); }
    function findEmailByCPF(kind, cpfD){
      const acc = getAccounts();
      const m = acc?.[kind] || {};
      for(const k of Object.keys(m)){
        if(String(m[k]?.cpf||"") === String(cpfD)) return k;
      }
      return null;
    }

    

    // ===== Pacotes =====
    const packages = [
      {id:1,  name:'Starter Foto',     price:27.40, eta:'35min', items:['2 Fotos (básicas)','Cor + nitidez','Ajuste de luz/contraste']},
      {id:2,  name:'Duo Foto',         price:41.80, eta:'35min', items:['3 Fotos (básicas)','Cor + nitidez','Padronização simples']},

      {id:3,  name:'Foto Pro 3',       price:53.60, eta:'55min', items:['4 Fotos (pro)','Ajustes finos + cor','Retoque leve (detalhes)','Remoção de manchas (leve)','1 revisão inclusa']},
      {id:4,  name:'Vídeo Short 1min', price:63.90, eta:'55min', items:['2 Vídeos (até 1min)','Cortes + ritmo','Limpeza de áudio leve','Legenda básica (opcional)','1 revisão inclusa']},
      {id:5,  name:'Foto Pack 4',      price:73.50, eta:'1h10', items:['5 Fotos (pro)','Cor + detalhes','Retoque leve (pele/objetos)','Nitidez premium','1 revisão inclusa']},
      {id:6,  name:'Short Duo 1m30',   price:86.40, eta:'1h25', items:['3 Vídeos (até 1m30)','Cortes + transições simples','Correção de cor leve','SFX leves (opcional)','1 revisão inclusa']},
      {id:7,  name:'Combo Social',     price:96.80, eta:'1h45', items:['2 Fotos + 1 Vídeo (até 1min)','Look cinematográfico leve','Correção de cor','Legenda simples (opcional)','1 revisão inclusa']},
      {id:8,  name:'Foto Pack 5',      price:108.90,eta:'2h20', items:['6 Fotos (pro)','Padronização de cor','Retoque leve + nitidez premium','Remoção de objetos simples (1x)','1 revisão inclusa']},

      {id:9,  name:'Short Trio 2min',  price:132.70,eta:'2h20', items:['4 Vídeos (até 2min)','Cor + ritmo','Efeitos sonoros leves','Legenda básica (opcional)','1 revisão inclusa']},
      {id:10, name:'Foto Pack 8',      price:151.40,eta:'3h30', items:['9 Fotos (pro)','Cor + retoques leves','Remoção de objetos simples (1x)','Retoque avançado (selecionado)','1 revisão inclusa']},
      {id:11, name:'Short 5 3min',     price:176.90,eta:'3h30', items:['6 Vídeos (até 3min)','Cortes + cor','Áudio: redução de ruído','Legenda básica (opcional)','2 revisões inclusas']},
      {id:12, name:'Creator Mix Pro',  price:197.80,eta:'3h30', items:['12 Fotos + 1 Vídeo (até 5min)','Padronização completa','Thumbnail premium (1x)','Export 1080p/4K (se tiver)','2 revisões inclusas']},

      {id:13, name:'Vídeo Médio 8min', price:221.60,eta:'3h30', items:['1 Vídeo (até 8min)','Cor + transições','Áudio + legenda simples','Motion text leve (opcional)','2 revisões inclusas']},
      {id:14, name:'Vídeo Longo 15min',price:259.40,eta:'6h00', items:['1 Vídeo (até 15min)','Edição avançada + ritmo','Sound design (leve)','Thumbnail (1x)','3 revisões inclusas']},
      {id:15, name:'Premium Creator+', price:329.90,eta:'6h00', items:['18 Fotos (pro)','4 Vídeos (até 15min cada)','Look premium + revisão','Prioridade (fila rápida)','3 revisões inclusas']},
    ];
// ===== NÍVEL DO EDITOR (Iniciante / Intermediário / Avançado) =====
// Regra: os preços atuais são do nível AVANÇADO (não mudam).
let PRICE_TIER = (localStorage.getItem('karameloo_price_tier') || 'avancado');

function tierMultiplier(){
  if(PRICE_TIER === 'intermediario') return 0.86;
  if(PRICE_TIER === 'iniciante') return 0.74;
  return 1.0; // avançado

}

function normTier(v){
  return String(v||'')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')  // remove acentos
    .replace(/\s+/g,'')
    .trim();
}



function marketRoundBRL(value, seed){
  // ✅ Se não tem valor, não inventa centavos (evita aparecer 0,80 quando é 0)
  if(!isFinite(value) || Number(value) <= 0) return 0;

  // "Jogo de mercado": evita números redondos e cria preços psicológicos.
  // Ex.: termina em ,90 / ,80 / ,70 / ,60 / ,40 (determinístico pelo seed)
  const patterns = [0.90, 0.80, 0.70, 0.60, 0.40];
  const p = patterns[Math.abs(seed) % patterns.length];
  let v = Math.max(0, value);
  // base em inteiro + centavos padrão
  let base = Math.floor(v);
  let out = base + p;
  // garante que não fique acima do valor original (para não "subir" o desconto)
  if(out > v) out = Math.max(0, out - 0.10);
  // se ficou muito abaixo (por causa do floor), aproxima um pouco
  if(v - out > 1.20) out = base + patterns[(Math.abs(seed)+1)%patterns.length];
  return Math.round(out * 100) / 100;
}

function priceForTier(basePrice, seed){
  if(PRICE_TIER === 'avancado') return basePrice;
  const mult = tierMultiplier();
  const discounted = basePrice * mult;
  // seed muda por tier também
  const tierSeed = seed + (PRICE_TIER === 'iniciante' ? 13 : 7);
  return marketRoundBRL(discounted, tierSeed);
}

function packagePrice(p){
  return priceForTier(Number(p.price||0), Number(p.id||0));
}

function setPriceTier(tier){
  PRICE_TIER = (tier === 'iniciante' || tier === 'intermediario' || tier === 'avancado') ? tier : 'avancado';
  localStorage.setItem('karameloo_price_tier', PRICE_TIER);
  // UI
  const wrap = document.getElementById('tierTogglePackages');
  if(wrap){
    wrap.querySelectorAll('.tier-btn').forEach(btn=>{
      const active = btn.getAttribute('data-tier') === PRICE_TIER;
      btn.classList.toggle('is-active', active);
      btn.setAttribute('aria-selected', active ? 'true' : 'false');
    });
  }
  // Re-render preços
  if(typeof renderPackages === 'function') renderPackages();
  if(typeof calcCustom === 'function') calcCustom();
}

function initTierToggle(){
  const wrap = document.getElementById('tierTogglePackages');
  if(!wrap) return;
  wrap.addEventListener('click', (e)=>{
    const btn = e.target && e.target.closest ? e.target.closest('.tier-btn') : null;
    if(!btn) return;
    setPriceTier(btn.getAttribute('data-tier'));
  });
  // estado inicial
  setPriceTier(PRICE_TIER);
}


    function renderPackages(){
      const grid = document.getElementById('packagesGrid');
      if(!grid) return;

      // Se o cliente veio da tela Explorar, mostramos só os pacotes que esse editor aceita
      const ctx = document.getElementById('clientEditorContext');
      let arr = packages.slice();
      if(typeof selectedEditorFromProcurar !== 'undefined' && selectedEditorFromProcurar){
        const allow = new Set((selectedEditorFromProcurar.packages||[]).map(n=>Number(n)));
        arr = arr.filter(p=>allow.has(p.id));
        if(ctx){
          ctx.style.display = '';
          ctx.innerHTML = `Editor selecionado: <strong>${escapeHtml(selectedEditorFromProcurar.name)}</strong> • Pacotes: <strong>${arr.length}</strong> <span style="opacity:.85">(voltar para procurar para trocar)</span>`;
        }
      }else{
        if(ctx){ ctx.style.display='none'; ctx.textContent=''; }
      }

      grid.innerHTML = '';
      arr.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        const nm = (p.name||'').toLowerCase();
        const th = nm.includes('foto') ? presetToCover('graphite') : (nm.includes('vídeo') || nm.includes('video') || nm.includes('short') ? presetToCover('gold') : presetToCover('amber'));
        if(th) card.style.setProperty('--pkgthumb', th);
        card.style.setProperty('--pkgpattern', pkgPattern(p.id));
        card.innerHTML = `
          <div class="pkgThumb"></div>
          <h3>${p.id}. ${escapeHtml(p.name)}</h3>
          <p>Entrega a partir de <strong>${escapeHtml(p.eta)}</strong> (mínimo 35min)</p>
          <div class="price">${brl(packagePrice(p))}</div>
          <ul>${p.items.map(i=>`<li>${escapeHtml(i)}</li>`).join('')}</ul>
          <button class="btn" type="button" data-action="choose-package" data-package-id="${p.id}">Escolher pacote</button>
        `;
        grid.appendChild(card);
      });

      if(selectedEditorFromProcurar && !arr.length){
        grid.innerHTML = `
          <div class="card full" style="grid-column:1/-1">
            <h3>Esse editor ainda não selecionou pacotes</h3>
            <p>Volte para explorar e escolha outro editor, ou peça um Personalizado.</p>
          </div>`;
      }
    }



    // ===== EXPLORAR (Marketplace) =====
    const LS_API_BASE = 'karamelo_api_base_v1';
    const LS_FAV_EDITORS = 'karamelo_fav_editors_v1';
    const LS_RECENT_EDITORS = 'karamelo_recent_editors_v1';

    let exploreFilter = 'all';
    let exploreEditorsCache = [];
    let exploreEditorsById = {};
    let selectedEditorFromProcurar = null; // editor selecionado (para filtrar pacotes)

    // intenção pós-login (fluxo A: navegar livre, e só criar conta ao falar/contratar)
    let postLoginIntent = null; // {type:'chat'|'package', editorId?, packageId?}
    function setPostLoginIntent(intent){ postLoginIntent = intent; }
    function runPostLoginIntent(){
      const intent = postLoginIntent;
      if(!intent) return;
      postLoginIntent = null;
      if(intent.type==='chat' && intent.editorId){
        try{ openEditorProfile(String(intent.editorId)); }catch(e){}
        setTimeout(()=>{ try{ openChatWithEditor(String(intent.editorId)); }catch(e){} }, 140);
        return;
      }
      if(intent.type==='package'){
        // abre pacotes (demo)
        try{ paintClientTop(); selectedEditorFromProcurar = null; renderPackages(); showScreen(screenClient); }catch(e){}
      }
    }


    const exploreEditorsGrid = document.getElementById('exploreEditorsGrid');
    const exploreSearch = document.getElementById('exploreSearch');
    const exploreSort = document.getElementById('exploreSort');
    const exploreAvatar = document.getElementById('exploreAvatar');
    const exploreSubtitle = document.getElementById('exploreSubtitle');
    const exploreHint = document.getElementById('exploreHint');
    const exploreBackendStatus = document.getElementById('exploreBackendStatus');
    const exploreWelcomeName = document.getElementById('exploreWelcomeName');
    const exploreEditorsCarousel = document.getElementById('exploreEditorsCarousel');
    const marketCats = document.getElementById('marketCats');

    // Editor -> explorar clientes
    const LS_FAV_CLIENTS = 'karamelo_fav_clients_v1';
    let exploreEFilter = 'all';
    const exploreESearch = document.getElementById('exploreESearch');
    const exploreESort = document.getElementById('exploreESort');
    const exploreEWelcomeName = document.getElementById('exploreEWelcomeName');
    const exploreESubtitle = document.getElementById('exploreESubtitle');
    const exploreEHint = document.getElementById('exploreEHint');
    const exploreClientsGrid = document.getElementById('exploreClientsGrid');
    const exploreClientsCarousel = document.getElementById('exploreClientsCarousel');
    const marketCatsE = document.getElementById('marketCatsE');

    const btnProcurarProfile = document.getElementById('btnProcurarProfile');

    const profileOverlay = document.getElementById('profileOverlay');
    const profileModal = document.getElementById('profileModal');
    const profileTitle = document.getElementById('profileTitle');
    const profileBody = document.getElementById('profileBody');

    const chatOverlay = document.getElementById('chatOverlay');
    const chatModal = document.getElementById('chatModal');
    
    const orderOverlay = document.getElementById('orderOverlay');
    const orderModal = document.getElementById('orderModal');
    const orderSummary = document.getElementById('orderSummary');
    const btnGoPay = document.getElementById('btnGoPay');

    // Checkout refs
    const checkoutOrderTitle = document.getElementById('checkoutOrderTitle');
    const checkoutOrderMeta = document.getElementById('checkoutOrderMeta');
    const checkoutStatus = document.getElementById('checkoutStatus');
    const checkoutPixCode = document.getElementById('checkoutPixCode');
    const btnCopyPix = document.getElementById('btnCopyPix');
    const btnConfirmPaid = document.getElementById('btnConfirmPaid');
    const btnOpenOrderChat = document.getElementById('btnOpenOrderChat');
const chatTitle = document.getElementById('chatTitle');
    const chatMsgs = document.getElementById('chatMsgs');
    const chatInput = document.getElementById('chatInput');
    let chatCtx = null; // { peerId, peerName, peerWhats, key }


    function apiBase(){
      const v = (localStorage.getItem(LS_API_BASE) || '').trim();
      return v.replace(/\/+$/,'');
    }

    async function apiFetch(path, opts){
      const base = apiBase();
      if(!base) throw new Error('no_api');
      const url = base + path;
      const res = await fetch(url, { headers:{'Content-Type':'application/json'}, ...opts });
      if(!res.ok) throw new Error('api_' + res.status);
      return await res.json();
    }

    async function apiHealth(){
      try{
        await apiFetch('/api/health', { method:'GET' });
        return true;
      }catch(e){
        return false;
      }
    }

    async function apiGetEditors(){
      const data = await apiFetch('/api/editors', { method:'GET' });
      const list = Array.isArray(data?.editors) ? data.editors : (Array.isArray(data) ? data : []);
      return list;
    }

    function getFavIds(){
      const arr = lsGet(LS_FAV_EDITORS, []);
      return new Set(Array.isArray(arr) ? arr : []);
    }

    function setFavIds(setObj){
      lsSet(LS_FAV_EDITORS, Array.from(setObj));
    }

    function toggleFavEditor(id){
      const s = getFavIds();
      if(s.has(id)) s.delete(id);
      else s.add(id);
      setFavIds(s);
    }

    function addRecentEditor(id){
      const arr = lsGet(LS_RECENT_EDITORS, []);
      const list = Array.isArray(arr) ? arr : [];
      const next = [id, ...list.filter(x=>x!==id)].slice(0, 12);
      lsSet(LS_RECENT_EDITORS, next);
    }

    function hasAnyVideoPkg(editor){
      return (editor.packages||[]).some(pid=>{
        const p = packages.find(x=>x.id===pid);
        const n = (p?.name||'').toLowerCase();
        return n.includes('vídeo') || n.includes('video') || n.includes('short');
      });
    }

    function hasAnyFotoPkg(editor){
      return (editor.packages||[]).some(pid=>{
        const p = packages.find(x=>x.id===pid);
        const n = (p?.name||'').toLowerCase();
        return n.includes('foto');
      });
    }

    function normalizeEditor(raw, fallbackId){
      const name = raw?.name || raw?.full || raw?.nome || 'Editor';
      const id = String(raw?.id || raw?.uid || raw?.email || fallbackId || name).replace(/\s+/g,'_');
      return {
        id,
        name,
        xp: raw?.xp || 'iniciante',
        tags: Array.isArray(raw?.tags) ? raw.tags : (Array.isArray(raw?.skills) ? raw.skills : []),
        packages: Array.isArray(raw?.packages) ? raw.packages.map(n=>Number(n)).filter(Boolean) : [],
        available: !!raw?.available,
        stars: (raw?.stars ?? START_STARS),
        photo: raw?.photo || '',
        bio: raw?.bio || '',
        soft: raw?.soft || raw?.software || '',
        whats: raw?.whats || raw?.whatsapp || raw?.wpp || '',
        cover: raw?.cover || raw?.capa || raw?.bg || raw?.coverImg || raw?.coverImage || ''
      
      };
    }

    function getLocalEditorsFromAccounts(){
      const acc = getAccounts();
      const edMap = acc?.editor || {};
      const list = [];
      Object.keys(edMap).forEach((k, idx)=>{
        const prof = edMap[k]?.profile || edMap[k]?.perfil || edMap[k];
        if(!prof) return;
        const e = normalizeEditor({
          id: 'acc_' + k,
          name: prof.full || prof.name || ('Editor ' + (idx+1)),
          xp: prof.xp,
          tags: prof.tags,
          packages: prof.packages,
          available: prof.available,
          stars: prof.stars,
          photo: prof.photo,
          bio: prof.bio,
          soft: prof.soft,
          whats: prof.whats,
          cover: prof.cover
        }, 'acc_' + k);
        list.push(e);
      });
      return list;
    }

    function getProcurarEditorsLocal(){
      const list = [];

      // editores cadastrados (no mesmo navegador)
      getLocalEditorsFromAccounts().forEach(e=> list.push(e));

      // seu editor (se existir)
      if(editorData && (editorData.full || editorData.first)){
        list.push(normalizeEditor({
          id:'you',
          name: editorData.full || 'Você',
          xp: editorData.xp,
          tags: editorData.tags,
          packages: editorData.packages,
          available: editorData.available,
          stars: editorData.stars,
          photo: editorData.photo,
          bio: editorData.bio,
          soft: editorData.soft,
          whats: editorData.whats,
          cover: editorData.cover
        }, 'you'));
      }

      // demos
      DEMO_EDITORS.forEach((e, i)=> list.push(normalizeEditor(e, 'demo_'+(i+1))));

      // remove duplicados por id
      const seen = new Set();
      const uniq = [];
      list.forEach(e=>{
        if(seen.has(e.id)) return;
        seen.add(e.id);
        uniq.push(e);
      });
      return uniq;
    }

    async function getProcurarEditors(){
      const base = apiBase();
      if(base){
        const ok = await apiHealth();
        if(ok){
          try{
            const apiEditors = await apiGetEditors();
            const list = apiEditors.map((e,i)=>normalizeEditor(e, 'api_'+(i+1)));
            return list;
          }catch(e){
            // cai para local
          }
        }
      }
      return getProcurarEditorsLocal();
    }

    function editorMatchesSearch(e, q){
      if(!q) return true;
      const hay = [e.name, e.xp, e.soft, e.bio, (e.tags||[]).join(' ')].join(' ').toLowerCase();
      return hay.includes(q);
    }

    function editorMatchesFilter(e){
      const f = exploreFilter;
      const fav = getFavIds();
      if(f==='fav') return fav.has(e.id);
      if(f==='video') return hasAnyVideoPkg(e) || (e.tags||[]).join(' ').toLowerCase().includes('vídeo');
      if(f==='foto') return hasAnyFotoPkg(e) || (e.tags||[]).join(' ').toLowerCase().includes('foto');
      if(f==='audio') return (e.tags||[]).join(' ').toLowerCase().includes('áudio') || (e.tags||[]).join(' ').toLowerCase().includes('audio');
      if(f==='legenda') return (e.tags||[]).join(' ').toLowerCase().includes('legenda');
      if(f==='motion') return (e.tags||[]).join(' ').toLowerCase().includes('motion');
      if(f==='premium') return (Number(e.stars||START_STARS) >= 8) || (e.packages||[]).length >= 8 || (String(e.xp||'').toLowerCase()==='avancado');
      return true;
    }

    function sortEditors(arr, mode){
      const rank = { avancado:3, intermediario:2, iniciante:1 };
      if(mode==='fast') return arr.sort((a,b)=>(rank[b.xp]||1)-(rank[a.xp]||1));
      if(mode==='pkgs') return arr.sort((a,b)=>(b.packages?.length||0)-(a.packages?.length||0));
      if(mode==='new') return arr.sort((a,b)=>String(b.id).localeCompare(String(a.id)));
      // best
      return arr.sort((a,b)=>(Number(b.stars||START_STARS))-(Number(a.stars||START_STARS)));
    }

    function updateProcurarHeader(){
      const logged = isClientLogged();
      if(btnProcurarProfile) btnProcurarProfile.style.display = logged ? '' : 'none';

      if(exploreSubtitle){
        exploreSubtitle.textContent = logged
          ? `Bem-vindo, ${clientData?.first || clientData?.full || 'Cliente'} — escolha um editor e veja os pacotes dele.`
          : 'Descubra perfis, compare estilos e salve seus favoritos.';
      }

      if(exploreAvatar){
        const letter = (clientData?.full||'K')[0];
        setAvatar(exploreAvatar, logged ? (clientData?.photo||'') : '', letter);
      }

      if(exploreBackendStatus){
        const base = apiBase();
        exploreBackendStatus.textContent = base ? `Backend conectado: ${base}` : 'Modo demo/local (sem backend).';
        exploreBackendStatus.style.opacity = '.9';
      }
    }

    
    function requestChatWithEditor(editorId){
      const id = String(editorId||'');
      if(!id) return;
      if(!isClientLogged()){
        setPostLoginIntent({ type:'chat', editorId:id });
        openCadastro('cliente');
        return;
      }
      openChatWithEditor(id);
    }

    function renderEditorCard(e){

      const fav = getFavIds();
      const isFav = fav.has(e.id);
      const tags = (e.tags||[]).slice(0,6);
      const statusBadge = e.available
        ? `<span class="badge you">Disponível</span>`
        : `<span class="badge off">Off</span>`;

      const btnProfile = `<button class="btn" type="button" onclick="openEditorProfile('${escapeHtml(e.id)}')">Ver perfil</button>`;

      const btnPrimary = `<button class="btn" type="button" onclick="requestChatWithEditor('${escapeHtml(e.id)}')">💬 Falar com o editor</button>`;

      const btnSecondary = `<button class="btn secondary" type="button" onclick="toggleProcurarFav('${escapeHtml(e.id)}')">${isFav ? '★ Salvo' : '☆ Salvar'}</button>`;

      return `
        <div class="eThumb" style="background-image: var(--thumb, none)"></div>
        <div class="eTop">
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="avatar" style="width:46px;height:46px" id="exAv_${escapeHtml(e.id)}">${escapeHtml((e.name||'E')[0])}</div>
            <div>
              <div class="eName">${escapeHtml(e.name)}</div>
              <div class="stars" style="margin-top:4px">${renderStarsHTML(e.stars ?? START_STARS, MAX_STARS)}</div>
              <div class="eMeta">${escapeHtml(e.xp)} • Pacotes: ${e.packages?.length||0}</div>
            </div>
          </div>
          <div style="text-align:right">${statusBadge}</div>
        </div>
        <div class="eBio">${escapeHtml(e.bio || (tags.length ? tags.join(' • ') : 'Editor com estilo premium.'))}</div>
        <div class="eBadges">
          ${tags.map(t=>`<span class="badge pillBlue">${escapeHtml(t)}</span>`).join('') || `<span class="badge off">Sem tags</span>`}
        </div>
        <div class="eActions">
          ${btnProfile}
          ${btnPrimary}
          ${btnSecondary}
        </div>
      `;
    }

    function renderProcurarCarousel(list){
      if(!exploreEditorsCarousel) return;
      exploreEditorsCarousel.innerHTML = '';
      const top = (list || []).slice(0, 10);

      top.forEach(e=>{
        const id = String(e.id);
        const nm = escapeHtml(e.name || 'Editor');
        const initials = escapeHtml((e.name||'E')[0]);
        const mt = escapeHtml(((e.tags||[]).slice(0,2).join(' • ')) || e.xp || 'Editor premium');
        const rating = Math.round((Number(e.stars ?? START_STARS))*10)/10;

        const card = document.createElement('div');
        card.className = 'miniGig';
        const mth = (e.cover && e.cover.img) ? `url(${e.cover.img})` : (e.cover && e.cover.preset && e.cover.preset!=='none' ? presetToCover(e.cover.preset) : '');
        if(mth) card.style.setProperty('--miniThumb', mth);
        card.innerHTML = `
          <div class="thumb" style="background-image: var(--miniThumb, none)"></div>
          <div class="info">
            <div class="whoMini">
              <div class="avMini" id="miniAv_${id}">${initials}</div>
              <div>
                <div class="nm">${nm}</div>
                <div class="mt">${mt}</div>
              </div>
            </div>
            <div style="font-weight:1000; color:rgba(255,224,138,.95)">${rating}</div>
          </div>`;

        card.addEventListener('click', ()=>{ openEditorProfile(id); });
        exploreEditorsCarousel.appendChild(card);
        const av = document.getElementById(`miniAv_${id}`);
        if(av) setAvatar(av, e.photo || '', (e.name||'E')[0]);
      });
    }


    async function renderProcurarEditors(){
      if(!exploreEditorsGrid) return;
      updateProcurarHeader();

      const q = (exploreSearch?.value || '').trim().toLowerCase();
      const sort = exploreSort?.value || 'best';

      const all = await getProcurarEditors();
      exploreEditorsCache = all.slice();
      exploreEditorsById = {};
      exploreEditorsCache.forEach(e=>{ exploreEditorsById[e.id] = e; });

      let arr = all.slice();

      // sempre mostra OFF também, mas joga pro final
      arr = arr.filter(e => editorMatchesFilter(e) && editorMatchesSearch(e, q));
      arr = sortEditors(arr, sort);
      arr.sort((a,b)=> (b.available===a.available)?0:(b.available? -1: 1));

      renderProcurarCarousel(arr);

      exploreEditorsGrid.innerHTML = '';
      if(!arr.length){
        exploreEditorsGrid.innerHTML = `
          <div class="card full" style="grid-column:1/-1">
            <h3>Nenhum editor encontrado</h3>
            <p>Tente outra busca ou filtre por “Todos”.</p>
          </div>`;
        return;
      }

      arr.forEach(e=>{
        const card = document.createElement('div');
        card.className = 'eCard';
        const th = (e.cover && e.cover.img) ? `url(${e.cover.img})` : (e.cover && e.cover.preset && e.cover.preset!=='none' ? presetToCover(e.cover.preset) : '');
        if(th) card.style.setProperty('--thumb', th);
        card.innerHTML = renderEditorCard(e);
        exploreEditorsGrid.appendChild(card);
        const av = document.getElementById(`exAv_${e.id}`);
        if(av) setAvatar(av, e.photo || '', (e.name||'E')[0]);
      });

      // ativa chip selecionado
      const row = document.querySelector('.chipsRow');
      row?.querySelectorAll('.chipBtn').forEach(b=>{
        const f = b.getAttribute('data-filter') || 'all';
        b.classList.toggle('active', f === exploreFilter);
      });

      // sincroniza categorias do topo
      if(marketCats){
        marketCats.querySelectorAll('.catBtn').forEach(b=>{
          const f = b.getAttribute('data-filter') || 'all';
          b.classList.toggle('active', f === exploreFilter);
        });
      }

      if(exploreHint){
        exploreHint.textContent = isClientLogged()
          ? 'Dica: abra o perfil do editor e clique em “Ver pacotes deste editor”.'
          : 'Dica: você pode procurar — para contratar, crie uma conta de cliente (ou fale com o editor e crie na hora).';
      }
    }

    function goProcurar(instant=false){
      if(instant){
        showScreen(screenProcurar, true);
        requestAnimationFrame(()=>{ try{ renderProcurarEditors(); }catch(e){} });
      }else{
        renderProcurarEditors();
        showScreen(screenProcurar, false);
      }
    }

    function goProcurarEditor(instant=false){
      if(!editorData) editorData = buildEditorDefaults();
      if(exploreEWelcomeName) exploreEWelcomeName.textContent = (editorData.full || editorData.first || 'Editor');
      if(exploreESubtitle){
        exploreESubtitle.textContent = 'Encontre clientes compatíveis com seus pacotes e envie uma proposta (demo).';
      }
      if(instant){
        showScreen(screenProcurarEditor, true);
        requestAnimationFrame(()=>{ try{ renderProcurarClients(); }catch(e){} });
      }else{
        renderProcurarClients();
        showScreen(screenProcurarEditor, false);
      }
    }

    function goEditorDashboard(){
      if(!editorData) editorData = buildEditorDefaults();
      paintEditor();
      showScreen(screenEditor, true);
    }

    function scrollToProcurarClientsGrid(){
      const el = document.getElementById('exploreClientsGridAnchor');
      el?.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function getFavClientIds(){
      const arr = lsGet(LS_FAV_CLIENTS, []);
      return new Set(Array.isArray(arr) ? arr : []);
    }
    function setFavClientIds(setObj){ lsSet(LS_FAV_CLIENTS, Array.from(setObj)); }
    function toggleFavClient(id){
      const s = getFavClientIds();
      if(s.has(id)) s.delete(id); else s.add(id);
      setFavClientIds(s);
    }

    function normalizeClient(raw, fallbackId){
      const name = raw?.name || raw?.full || raw?.nome || 'Cliente';
      const id = String(raw?.id || raw?.uid || raw?.email || fallbackId || name).replace(/\s+/g,'_');
      const niche = raw?.niche || raw?.categoria || '';
      const about = raw?.about || raw?.bio || raw?.descricao || '';
      const city = raw?.city || raw?.cidade || '';
      const platform = raw?.mainPlatform || raw?.plataforma || raw?.platform || '';
      const whats = raw?.whats || raw?.whatsapp || '';
      const tags = [];
      if(niche) tags.push(niche);
      if(platform) tags.push(platform);
      const txt = (niche + ' ' + about).toLowerCase();
      if(txt.includes('reels') || txt.includes('tiktok') || txt.includes('short')) tags.push('reels');
      if(txt.includes('foto')) tags.push('foto');
      if(txt.includes('áudio') || txt.includes('audio') || txt.includes('ruído') || txt.includes('ruido')) tags.push('audio');
      if(txt.includes('legenda')) tags.push('legenda');
      if(txt.includes('motion')) tags.push('motion');
      const urgent = txt.includes('urgente') || txt.includes('hoje') || txt.includes('rápido') || txt.includes('rapido');
      return { id, name, niche, about, city, platform, whats, tags, urgent };
    }

    function getLocalClientsFromAccounts(){
      const acc = getAccounts();
      const clMap = acc?.client || {};
      const list = [];
      Object.keys(clMap).forEach((k, idx)=>{
        const prof = clMap[k]?.profile || clMap[k]?.perfil || clMap[k];
        if(!prof) return;
        const c = normalizeClient({
          id: 'acc_' + k,
          name: prof.full || prof.name || ('Cliente ' + (idx+1)),
          niche: prof.niche,
          about: prof.about,
          city: prof.city,
          mainPlatform: prof.mainPlatform,
          whats: prof.whats,
          cover: prof.cover
        }, 'acc_' + k);
        list.push(c);
      });
      return list;
    }

    const DEMO_CLIENTS = [
      {id:'c1', name:'Loja de Roupas', niche:'Moda', mainPlatform:'instagram', about:'Preciso de 6 Reels por semana (cortes rápidos, cor cine).', whats:''},
      {id:'c2', name:'Personal Trainer', niche:'Fitness', mainPlatform:'tiktok', about:'Vídeos curtos com legendas e limpeza de áudio. Prazo rápido.', whats:''},
      {id:'c3', name:'Canal de Gameplay', niche:'Gaming', mainPlatform:'youtube', about:'Highlights com motion simples, zoom, SFX e ritmo.', whats:''},
      {id:'c4', name:'Imobiliária', niche:'Negócios', mainPlatform:'instagram', about:'Edição de fotos + reels de imóveis com áudio limpo e cor.', whats:''},
    ];

    function getProcurarClientsLocal(){
      const list = [];
      getLocalClientsFromAccounts().forEach(c=>list.push(c));
      if(clientData && (clientData.full || clientData.first)){
        list.push(normalizeClient({
          id:'you_client',
          name: clientData.full || 'Você',
          niche: clientData.niche,
          about: clientData.about,
          city: clientData.city,
          mainPlatform: clientData.mainPlatform,
          whats: clientData.whats
        }, 'you_client'));
      }
      DEMO_CLIENTS.forEach((c,i)=> list.push(normalizeClient(c,'demo_c_'+(i+1))));
      // uniq
      const seen = new Set();
      const uniq = [];
      list.forEach(c=>{ if(seen.has(c.id)) return; seen.add(c.id); uniq.push(c); });
      return uniq;
    }

    function clientMatchesFilter(c){
      if(exploreEFilter==='all') return true;
      if(exploreEFilter==='urg') return !!c.urgent;
      if(exploreEFilter==='fav') return getFavClientIds().has(String(c.id));
      return (c.tags||[]).some(t=> String(t).toLowerCase().includes(exploreEFilter));
    }
    function clientMatchesSearch(c, q){
      if(!q) return true;
      const hay = `${c.name} ${c.niche} ${c.about} ${c.city} ${c.platform}`.toLowerCase();
      return hay.includes(q);
    }
    function sortClients(arr, sort){
      const a = arr.slice();
      if(sort==='urg') a.sort((x,y)=> (y.urgent===x.urgent)?0:(y.urgent?1:-1));
      else if(sort==='new') a.sort((x,y)=> String(y.id).localeCompare(String(x.id)));
      else if(sort==='fit') a.sort((x,y)=> (y.tags?.length||0) - (x.tags?.length||0));
      return a;
    }

    function renderClientCard(c){
      const fav = getFavClientIds();
      const isFav = fav.has(String(c.id));
      const badges = (c.tags||[]).slice(0,6).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join('') || `<span class="badge off">Sem tags</span>`;
      const meta = [c.niche, c.city].filter(Boolean).join(' • ');
      return `
        <div class="eThumb"></div>
        <div class="eTop">
          <div class="eName">${escapeHtml(c.name)}</div>
          <div class="pill" style="margin:0">${c.urgent ? 'Urgente' : 'Pedido'}</div>
        </div>
        <div class="eSub">${escapeHtml(meta || 'Cliente (demo)')}</div>
        <div class="eBadges" style="margin-top:10px">${badges}</div>
        <div class="hint" style="margin-top:10px">${escapeHtml((c.about||'').slice(0,120) + ((c.about||'').length>120?'…':''))}</div>
        <div class="eActions">
          <button class="btn" type="button" onclick="openClientBriefing('${escapeHtml(c.id)}')">Ver briefing</button>
          <button class="btn secondary" type="button" onclick="toggleProcurarClientFav('${escapeHtml(c.id)}')">${isFav ? '★ Salvo' : '☆ Salvar'}</button>
        </div>
      `;
    }

    function toggleProcurarClientFav(id){
      toggleFavClient(String(id));
      renderProcurarClients();
    }

    let exploreClientsById = {};
    function renderProcurarClients(){
      const q = String(exploreESearch?.value||'').trim().toLowerCase();
      const sort = String(exploreESort?.value||'best');
      let arr = getProcurarClientsLocal().filter(c=> clientMatchesFilter(c) && clientMatchesSearch(c,q));
      arr = sortClients(arr, sort);

      exploreClientsById = {};
      arr.forEach(c=> exploreClientsById[c.id]=c);

      // carousel
      if(exploreClientsCarousel){
        exploreClientsCarousel.innerHTML = '';
        arr.slice(0,8).forEach(c=>{
          const d = document.createElement('div');
          d.className = 'carItem';
          d.innerHTML = `<div class="carTitle">${escapeHtml(c.name)}</div><div class="carSub">${escapeHtml(c.niche || 'Pedido')}</div>`;
          d.addEventListener('click', ()=> openClientBriefing(c.id));
          exploreClientsCarousel.appendChild(d);
        });
      }

      if(exploreClientsGrid){
        exploreClientsGrid.innerHTML = '';
        if(!arr.length){
          exploreClientsGrid.innerHTML = `<div class="card full" style="grid-column:1/-1"><h3>Nenhum cliente encontrado</h3><p>Tente outra busca ou troque os filtros.</p></div>`;
        }else{
          arr.forEach(c=>{
            const card = document.createElement('div');
            card.className = 'eCard';
            card.innerHTML = renderClientCard(c);
            exploreClientsGrid.appendChild(card);
          });
        }
      }

      if(exploreEHint){
        exploreEHint.textContent = 'Dica: abra o briefing e combine pelo WhatsApp (se o cliente tiver informado).';
      }
    }

    function openClientBriefing(id){
      const c = exploreClientsById?.[id];
      if(!c) return;
      const txt = `Cliente: ${c.name}\nNicho: ${c.niche||'-'}\nCidade: ${c.city||'-'}\nPlataforma: ${c.platform||'-'}\n\nBriefing:\n${c.about||'(não informado)'}\n\n(OK = abrir WhatsApp se existir / Cancelar = fechar)`;
      const ok = confirm(txt);
      if(!ok) return;
      const d = String(c.whats||'').replace(/\D/g,'');
      if(!d){
        alert('Este cliente ainda não informou WhatsApp. (demo)');
        return;
      }
      const br = (d.length===10 || d.length===11) ? ('55'+d) : d;
      const msg = encodeURIComponent('Olá! Vi seu pedido no Karameloo. Posso te ajudar com a edição?');
      window.open(`https://wa.me/${br}?text=${msg}`, '_blank');
    }

    function goClientProfileFromProcurar(){
      if(!clientData) clientData = buildClientDefaults();
      paintClientProfile();
      if(typeof syncClientCoverControls==='function') syncClientCoverControls();
      showScreen(screenClientProfile);
    }

    function openProcurarApiConfig(){
      const cur = apiBase();
      const v = prompt('Cole a URL do backend (ex: http://localhost:3000).\nDeixe vazio para usar modo LocalStorage.', cur || '');
      if(v === null) return;
      localStorage.setItem(LS_API_BASE, String(v||'').trim());
      renderProcurarEditors();
    }

    
    function scrollToProcurarGrid(){
      const el = document.getElementById('exploreGridAnchor');
      el?.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function startBriefing(){
      // pode ver pacotes sem conta; contratar pede conta
      if(!clientData) clientData = buildClientDefaults();
      // se ainda nao completou o perfil, vai para o perfil primeiro
      if(!clientData) clientData = buildClientDefaults();
      const hasProfile = !!(clientData?.whats || clientData?.city || clientData?.niche || clientData?.about);
      if(!hasProfile){
        paintClientProfile();
        showScreen(screenClientProfile);
        return;
      }
      // vai para pacotes e rola direto no personalizado
      paintClientTop();
      showScreen(screenClient);
      setTimeout(()=>{
        const h = document.querySelector('#screenClient .card.highlight');
        h?.scrollIntoView({behavior:'smooth', block:'start'});
      }, 80);
    }
function toggleProcurarFav(id){
      toggleFavEditor(String(id));
      renderProcurarEditors();
    }

    function openEditorProfile(id){
      const e = exploreEditorsById?.[id];
      if(!e) return;
      addRecentEditor(e.id);

      if(profileTitle) profileTitle.textContent = `Perfil: ${e.name}`;
      if(profileBody){
        const tags = (e.tags||[]).slice(0,10);
        const pkgs = (e.packages||[]).slice(0,10);
        const fav = getFavIds();
        const isFav = fav.has(e.id);

        const pkgBadges = pkgs.map(pid=>{
          const p = packages.find(x=>x.id===pid);
          return p ? `<span class="badge pillBlue">${escapeHtml(p.name)}</span>` : '';
        }).join('');

        profileBody.innerHTML = `
          <div class="who" style="margin-bottom:12px">
            <div class="avatar" id="profileAv" style="width:56px;height:56px"></div>
            <div class="meta">
              <div style="font-weight:900; font-size:1.15rem">${escapeHtml(e.name)}</div>
              <div class="stars" style="margin-top:4px">${renderStarsHTML(e.stars ?? START_STARS, MAX_STARS)}</div>
              <div class="pill" style="margin-top:8px">${escapeHtml(e.xp)} • Pacotes: <strong>${e.packages?.length||0}</strong> • ${e.available ? 'Disponível' : 'Off'}</div>
            </div>
          </div>

          <div class="card" style="padding:14px">
            <h3 style="margin:0 0 6px">Sobre</h3>
            <p style="margin:0; color:rgba(229,231,235,.78)">${escapeHtml(e.bio || 'Bio não informada.')}</p>
            <div class="eBadges" style="margin-top:12px">
              ${tags.map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join('') || `<span class="badge off">Sem tags</span>`}
            </div>
          </div>

          <div class="card" style="padding:14px; margin-top:12px">
            <h3 style="margin:0 0 6px">Pacotes aceitos</h3>
            <div class="eBadges">${pkgBadges || `<span class="badge off">Nenhum pacote selecionado</span>`}</div>
            <div class="hint" style="margin-top:10px">* Demo: o editor precisa marcar pacotes e ficar “Disponível”.</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
            <button class="btn" type="button" onclick="openEditorShop('${escapeHtml(e.id)}')">Ver pacotes deste editor</button>
            <button class="btn secondary" type="button" onclick="requestChatWithEditor('${escapeHtml(e.id)}')">💬 Falar com o editor</button>
            <button class="btn secondary" type="button" onclick="toggleProcurarFav('${escapeHtml(e.id)}')">${isFav ? '★ Remover dos salvos' : '☆ Salvar editor'}</button>
            <button class="btn secondary" type="button" onclick="closeEditorProfile()">Fechar</button>
          </div>
        `;
        const av = document.getElementById('profileAv');
        if(av) setAvatar(av, e.photo || '', (e.name||'E')[0]);
      }

      if(profileOverlay){
        profileOverlay.classList.remove('closing');
        profileModal?.classList.remove('closing');
        profileOverlay.classList.add('show');
        profileOverlay.setAttribute('aria-hidden','false');
      }
    }

    function closeEditorProfile(){
      if(!profileOverlay) return;
      profileOverlay.classList.add('closing');
      profileModal?.classList.add('closing');
      setTimeout(()=>{
        profileOverlay.classList.remove('show','closing');
        profileModal?.classList.remove('closing');
        profileOverlay.setAttribute('aria-hidden','true');
      }, 220);
    }

    profileOverlay?.addEventListener('click', (e)=>{ if(e.target === profileOverlay) closeEditorProfile(); });

    // ===== Chat (demo local) =====
    function clientChatId(){
      const base = (clientData?.email || clientData?.cpf || clientData?.full || 'client');
      return String(base).trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,72) || 'client';
    }
    function chatKeyFor(peerId){
      return `karamelo_chat_${clientChatId()}_${String(peerId||'peer').replace(/[^a-z0-9_\-]+/gi,'_').slice(0,72)}`;
    }
    function renderChat(){
      if(!chatMsgs || !chatCtx) return;
      const arr = lsGet(chatCtx.key, []);
      const msgs = Array.isArray(arr) ? arr : [];
      chatMsgs.innerHTML = '';

      const fmtTime = (ts)=>{
        try{
          const d = new Date(ts||Date.now());
          return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        }catch(e){ return ''; }
      };
      const fmtDay = (ts)=>{
        try{
          const d = new Date(ts||Date.now());
          return d.toLocaleDateString('pt-BR',{weekday:'short', day:'2-digit', month:'short'});
        }catch(e){ return ''; }
      };

      let lastDay = '';
      msgs.forEach(m=>{
        const day = fmtDay(m.ts);
        if(day && day !== lastDay){
          const sep = document.createElement('div');
          sep.className = 'chatDay';
          sep.textContent = day;
          chatMsgs.appendChild(sep);
          lastDay = day;
        }

        const row = document.createElement('div');
        row.className = 'chatRow' + (m.from==='me' ? ' me' : '');
        const bubble = document.createElement('div');
        bubble.className = 'chatBubble';

        const text = document.createElement('div');
        text.className = 'chatText';
        text.textContent = String(m.text||'');
        bubble.appendChild(text);

        const meta = document.createElement('div');
        meta.className = 'chatMeta';
        const time = document.createElement('span');
        time.textContent = fmtTime(m.ts);
        meta.appendChild(time);

        if(m.from==='me'){
          const tick = document.createElement('span');
          tick.textContent = '✓';
          tick.style.opacity = '.75';
          meta.appendChild(tick);
        }

        bubble.appendChild(meta);
        row.appendChild(bubble);
        chatMsgs.appendChild(row);
      });

      // typing indicator
      if(chatCtx.typing){
        const row = document.createElement('div');
        row.className = 'chatRow';
        const tip = document.createElement('div');
        tip.className = 'chatTyping';
        tip.innerHTML = 'Digitando <span class="dots"><i></i><i></i><i></i></span>';
        row.appendChild(tip);
        chatMsgs.appendChild(row);
      }

      chatScrollToBottom(true);
    }
    function openChatWithEditorOrSignup(editorId){
      requestChatWithEditor(editorId);
    }

    function openChatWithEditor(editorId){
      if(!isClientLogged()){
        setPostLoginIntent({ type:'chat', editorId:String(editorId||'') });
        openCadastro('cliente');
        return;
      }
      const e = exploreEditorsById?.[editorId];
      if(!e) return;
      chatCtx = {
        peerId: e.id,
        peerName: e.name,
        peerWhats: e.whats || '',
        key: chatKeyFor(e.id)
      };
      if(chatTitle) chatTitle.textContent = `Falar com ${e.name}`;
      try{
        const av = document.getElementById('chatAvatar');
        const nm = document.getElementById('chatPeerName');
        const st = document.getElementById('chatPeerStatusText');
        if(nm) nm.textContent = e.name;
        if(av) av.textContent = String(e.name||'E').trim().slice(0,1).toUpperCase();
        if(st) st.textContent = (e.online===false ? 'Offline (responde depois)' : 'Online agora');
      }catch(err){}
      chatRememberLast();
      closeEditorProfile();
      renderChat();
      if(chatOverlay){
        chatOverlay.classList.remove('closing');
        chatModal?.classList.remove('closing');
        chatOverlay.classList.add('show');
        chatOverlay.setAttribute('aria-hidden','false');
        setTimeout(()=> chatInput?.focus(), 60);
      }
      try{ uiSaveDebounced(); }catch(e){}
    }

    function closeChat(){
      if(!chatOverlay) return;
      chatOverlay.classList.add('closing');
      chatModal?.classList.add('closing');
      setTimeout(()=>{
        chatOverlay.classList.remove('show','closing');
        chatModal?.classList.remove('closing');
        chatOverlay.setAttribute('aria-hidden','true');
      }, 220);
    }
    chatOverlay?.addEventListener('click', (e)=>{ if(e.target === chatOverlay) closeChat(); });
    async function sendChat(){
      if(!chatCtx || !chatInput) return;
      const raw = String(chatInput.value||'');
      const txt = raw.trim();
      if(!txt) return;

      const mod = await moderateText(txt);
      if(!mod.ok){ alert(mod.reason || 'Mensagem bloqueada.'); return; }

      const arr = lsGet(chatCtx.key, []);
      const msgs = Array.isArray(arr) ? arr : [];
      msgs.push({from:'me', text: txt, ts: Date.now()});
      lsSet(chatCtx.key, msgs);

      chatInput.value = '';
      chatRememberLast();
      chatCtx.typing = true;
      renderChat();

      // resposta simulada (demo) — deixa o chat bonito pra testar o beta
      setTimeout(()=>{
        try{
          const a2 = lsGet(chatCtx.key, []);
          const m2 = Array.isArray(a2) ? a2 : [];
          const replies = [
            'Perfeito! Me diga a plataforma (Reels/TikTok/Shorts) e o estilo 🙂',
            'Show! Você prefere cortes rápidos ou mais cinematográfico?',
            'Pode mandar referências (links) e me dizer o prazo ideal?',
            'Entendi! Quer legenda e efeitos/zoom ou mais clean?'
          ];
          const pick = replies[Math.floor(Math.random()*replies.length)];
          m2.push({from:'them', text: pick, ts: Date.now()});
          lsSet(chatCtx.key, m2);
        }catch(e){}
        chatCtx.typing = false;
        renderChat();
      }, 750);
    }
    chatInput?.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
    });
    
    function chatScrollToBottom(smooth){
      try{
        if(!chatMsgs) return;
        const behavior = smooth ? 'smooth' : 'auto';
        chatMsgs.scrollTo({ top: chatMsgs.scrollHeight, behavior });
      }catch(e){
        try{ chatMsgs.scrollTop = chatMsgs.scrollHeight; }catch(e2){}
      }
    }

    function chatQuick(text){
      if(!chatInput) return;
      const t = String(text||'').trim();
      if(!t) return;
      chatInput.value = t;
      chatInput.focus();
    }

    function chatSetFabBadge(n){
      const b = document.getElementById('chatFabBadge');
      if(!b) return;
      const nn = Number(n||0);
      b.style.display = nn>0 ? 'flex' : 'none';
      b.textContent = String(Math.min(99, nn));
    }

    function chatRememberLast(){
      try{ if(chatCtx?.key) localStorage.setItem('karameloo_last_chat', chatCtx.key); }catch(e){}
    }

    function chatOpenLast(){
      if(!isClientLogged()){
        setPostLoginIntent({ type:'open_last_chat' });
        openCadastro('cliente');
        return;
      }
      const key = (()=>{
        try{ return localStorage.getItem('karameloo_last_chat') || ''; }catch(e){ return ''; }
      })();
      if(!key) { alert('Você ainda não iniciou nenhuma conversa. Abra um editor e clique em "Falar com o editor".'); return; }
      // recuperar peerId do key (formato chat_editor_<id>)
      const peerId = String(key).replace('chat_editor_','');
      const e = exploreEditorsById?.[peerId];
      if(!e){ alert('Não encontrei esse editor (modo beta).'); return; }
      openChatWithEditor(peerId);
    }

    document.getElementById('chatFab')?.addEventListener('click', ()=> chatOpenLast() );

    function openChatWhats(){
      if(!chatCtx) return;
      const d = String(chatCtx.peerWhats||'').replace(/\D/g,'');
      if(!d){
        alert('Este editor ainda não informou WhatsApp. (demo)');
        return;
      }
      const br = (d.length===10 || d.length===11) ? ('55'+d) : d;
      const msg = encodeURIComponent('Olá! Vi seu perfil no Karameloo. Podemos conversar sobre meu pedido?');
      window.open(`https://wa.me/${br}?text=${msg}`, '_blank');
    }

    // chips
    document.querySelector('.chipsRow')?.addEventListener('click', (e)=>{
      const btn = e.target?.closest('.chipBtn');
      if(!btn) return;
      exploreFilter = btn.getAttribute('data-filter') || 'all';
      renderProcurarEditors();
    });

    // inputs
    exploreSearch?.addEventListener('input', ()=>{ renderProcurarEditors(); });
    exploreSort?.addEventListener('change', ()=>{ renderProcurarEditors(); });

    marketCats?.addEventListener('click', (ev)=>{
      const btn = ev.target?.closest?.('.catBtn');
      if(!btn) return;
      const f = btn.getAttribute('data-filter') || 'all';
      if(f==='pkgs'){
        // atalho para ver pacotes (pode sem conta)
        if(!clientData) clientData = buildClientDefaults();
        paintClientTop();
        selectedEditorFromProcurar = null;
        renderPackages();
        showScreen(screenClient);
        return;
      }
      exploreFilter = f;
      // ativa visual
      marketCats.querySelectorAll('.catBtn').forEach(b=>b.classList.toggle('active', b===btn));
      renderProcurarEditors();
    });

    // Editor explore (clientes)
    exploreESearch?.addEventListener('input', ()=>{ renderProcurarClients(); });
    exploreESort?.addEventListener('change', ()=>{ renderProcurarClients(); });
    marketCatsE?.addEventListener('click', (ev)=>{
      const btn = ev.target?.closest?.('.catBtn');
      if(!btn) return;
      const f = btn.getAttribute('data-filter') || 'all';
      if(f==='pkgs'){
        // atalho: ir para seleção de pacotes do editor
        if(!isEditorLogged()) return openCadastro('editor');
        showScreen(screenEditor, true);
        return;
      }
      exploreEFilter = f;
      marketCatsE.querySelectorAll('.catBtn').forEach(b=>b.classList.toggle('active', b===btn));
      renderProcurarClients();
    });


    // ===== Loja do editor: filtrar pacotes pelo editor selecionado =====
    function openEditorShop(editorId){
      const e = exploreEditorsById?.[editorId];
      if(!e) return;
      if(!e.available){
        alert('Esse editor está OFF no momento.');
        return;
      }
      selectedEditorFromProcurar = e;
      closeEditorProfile();
      paintClientTop();
      goProcurar();
    }


    // ===== CLIENTE (perfil) =====
    const clientAvatarBox = document.getElementById('clientAvatarBox');
    const clientAvatarTop = document.getElementById('clientAvatarTop');
    const clientProfileName = document.getElementById('clientProfileName');
    const clientStars = document.getElementById('clientStars');
    const clientStarsTop = document.getElementById('clientStarsTop');

    const clientPhoto = document.getElementById('clientPhoto');
    const clWhats = document.getElementById('clWhats');
    const clCity = document.getElementById('clCity');
    const clNiche = document.getElementById('clNiche');
    const clMainPlatform = document.getElementById('clMainPlatform');
    const clAbout = document.getElementById('clAbout');

    let clientData = lsGet(LS_CLIENT, null);

    function ensureClientData(nome, sobrenome){
      const full = `${nome} ${sobrenome}`.trim();
      clientData = clientData || {
        first:nome||'Cliente',
        last:sobrenome||'',
        full: full || 'Cliente',
        stars: START_STARS,
        photo:'',
        cover:{preset:'none', img:''},
        whats:'',
        city:'',
        niche:'',
        mainPlatform:'instagram',
        about:'',
        cpf:'',
        email:'',
        dob:''
      };
      clientData.first = nome || clientData.first;
      clientData.last = sobrenome || clientData.last;
      clientData.full = full || clientData.full;
      clientData.stars = START_STARS;
      lsSet(LS_CLIENT, clientData);
    }

    function paintClientProfile(){
      if(clientProfileName) clientProfileName.textContent = clientData?.full || 'Cliente';
      if(clientStars) clientStars.innerHTML = renderStarsHTML(clientData?.stars ?? START_STARS, MAX_STARS);
      setAvatar(clientAvatarBox, clientData?.photo, (clientData?.full||'C')[0]);
      applyCoverToEl(document.getElementById('clientCover'), clientData?.cover);
      if(clWhats) clWhats.value = clientData?.whats || '';
      if(clCity) clCity.value = clientData?.city || '';
      if(clNiche) clNiche.value = clientData?.niche || '';
      if(clMainPlatform) clMainPlatform.value = clientData?.mainPlatform || 'instagram';
      if(clAbout) clAbout.value = clientData?.about || '';
      if(typeof syncClientCoverControls==='function') syncClientCoverControls();
    }

    function paintClientTop(){
      if(clientName) clientName.textContent = clientData?.first || 'Cliente';
      if(clientStarsTop) clientStarsTop.innerHTML = renderStarsHTML(clientData?.stars ?? START_STARS, MAX_STARS);
      setAvatar(clientAvatarTop, clientData?.photo, (clientData?.full||'C')[0]);
    }

    clientPhoto?.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file || !clientData) return;
      try{
        const data = await checkAndReadImage(file);
        clientData.photo = data;
      }catch(err){
        alert(String(err.message||err));
        e.target.value='';
        return;
      }
      lsSet(LS_CLIENT, clientData);
      paintClientProfile();
      paintClientTop();
    });

    function removeClientPhoto(){
      if(!clientData) return;
      clientData.photo = '';
      lsSet(LS_CLIENT, clientData);
      paintClientProfile();
      paintClientTop();
    }

    function saveClientProfileAndGo(){
      if(!clientData) clientData = {first:'Cliente', last:'', full:'Cliente', stars:START_STARS};
      clientData.whats = (clWhats?.value||'').trim();
      clientData.city = (clCity?.value||'').trim();
      clientData.niche = (clNiche?.value||'').trim();
      clientData.mainPlatform = clMainPlatform?.value || 'instagram';
      clientData.about = (clAbout?.value||'').trim();
      clientData.stars = START_STARS;
      lsSet(LS_CLIENT, clientData);
      paintClientTop();
      goProcurar(true);
    }

    // ===== CUSTOM (Cliente) =====
    const custFotos = document.getElementById('custFotos');
    const custVideos = document.getElementById('custVideos');
    const custPlataforma = document.getElementById('custPlataforma');
    const custTipoVideo = document.getElementById('custTipoVideo');
    const custTotal = document.getElementById('custTotal');
    const custEntrega = document.getElementById('custEntrega');

    const PRICES = {
      // ✅ Valores "abaixo do mercado" + jogo psicológico (sem números redondos)
      foto: 18.40,

      // Vídeos curtos (base)
      video15: 16.90,
      video45: 24.90,
      video60: 29.90,

      // ✅ Vídeos longos: custo por minuto cai MUITO conforme a duração aumenta (até 3h)
      // (taxas aplicadas APENAS aos minutos adicionais após 1min)
      longRates: [
        { upToMin: 5,   perMin: 7.70 },  // 1–5 min
        { upToMin: 20,  perMin: 5.60 },  // 6–20 min
        { upToMin: 60,  perMin: 4.10 },  // 21–60 min
        { upToMin: 120, perMin: 3.20 },  // 61–120 min
        { upToMin: 180, perMin: 2.70 },  // 121–180 min (3h)
      ],

      platformMult: {
        reels:1.00, tiktok:1.00, insta:1.03, shorts:1.03,
        ytlong:1.05, facebookreels:1.02, kwai:1.00, snap:1.02,
        pinterest:1.02, linkedin:1.03, x:1.02
      }
    };

    // ✅ Calcula preço unitário para 1 vídeo longo (acima de 60s) com desconto progressivo por minuto
    function longVideoUnitPrice(durSec){
      const dur = Math.max(60, Number(durSec)||60);
      const mins = Math.min(180, Math.max(1, dur/60)); // até 3h
      let price = PRICES.video60; // inclui o 1º minuto
      let remaining = mins - 1;

      // aplica faixas de desconto
      let lastCap = 1;
      for(const band of (PRICES.longRates||[])){
        const cap = Math.min(180, Math.max(1, Number(band.upToMin)||lastCap));
        const room = Math.max(0, cap - lastCap);
        const take = Math.min(remaining, room);
        if(take > 0){
          price += take * (Number(band.perMin)||0);
          remaining -= take;
        }
        lastCap = cap;
        if(remaining <= 0) break;
      }
      // se sobrou por qualquer motivo, cobra a última taxa
      if(remaining > 0){
        const last = (PRICES.longRates && PRICES.longRates.length) ? PRICES.longRates[PRICES.longRates.length-1] : {perMin:2.70};
        price += remaining * (Number(last.perMin)||2.70);
      }

      // jogo de mercado no unitário (centavos psicológicos)
      return marketRoundBRL(price, Math.round(mins*13));
    }

    const EXTRA_OPTIONS = [
      { id:'optCorCine',    kind:'video', price:11.60 },
      { id:'optLegenda',    kind:'video', price:11.60 },
      { id:'optTransicoes', kind:'video', price:9.40  },
      { id:'optMotion',     kind:'video', price:11.60 },
      { id:'optIntroOutro', kind:'video', price:11.60 },
      { id:'optEstabilizar',kind:'video', price:11.60 },
      { id:'optSpeedRamp',  kind:'video', price:9.40  },

      { id:'optSFX',        kind:'video', price:9.40  },
      { id:'optAudio',      kind:'video', price:11.60 },
      { id:'optMusicSync',  kind:'video', price:9.90  },
      { id:'optVoiceClean', kind:'video', price:11.90 },

      { id:'optRetoquePro', kind:'photo', price:9.40  },
      { id:'optPele',       kind:'photo', price:9.40  },
      { id:'optFundo',      kind:'photo', price:11.60 },
      { id:'optCoresFoto',  kind:'photo', price:9.40  },
      { id:'optHDR',        kind:'photo', price:9.40  },
      { id:'optObjeto',     kind:'photo', price:11.60 },
      { id:'optTexto',      kind:'photo', price:9.40  },

      { id:'optHook',       kind:'video', price:7.90  },
      { id:'optCutsPro',    kind:'video', price:11.40 },
      { id:'optColorMatch', kind:'video', price:12.90 },
      { id:'optVfxLite',    kind:'video', price:9.80  },
      { id:'optReframe',    kind:'video', price:8.90  },
      { id:'optCapStyle',   kind:'video', price:9.70  },

      { id:'optDodgeBurn',  kind:'photo', price:12.40 },
      { id:'optNoisePhoto', kind:'photo', price:8.90  },
      { id:'optBatchPreset',kind:'photo', price:9.40  },
      { id:'optBlurBG',     kind:'photo', price:11.60 },
      { id:'optLensFix',    kind:'photo', price:9.90  },

      { id:'optThumbnail',  kind:'order', price:19.90 },
      { id:'optUrgente',    kind:'order', price:29.90 },
    ];

    function calcEntrega(total, urgent){
      // tempo mínimo agora é 35min (pedido simples)
      let eta = '35min';
      if(total <= 120) eta = '35min';
      else if(total <= 250) eta = '55min';
      else if(total <= 400) eta = '1h25';
      else if(total <= 700) eta = '2h20';
      else if(total <= 1000) eta = '3h30';
      else eta = '6h00';

      if(urgent){
        const steps = ['35min','55min','1h10','1h25','1h45','2h20','3h30','6h00'];
        const i = steps.indexOf(eta);
        if(i > 0) eta = steps[i-1]; // um nível mais rápido, sem passar de 35min
      }
      return eta;
    }

    function calcCustom(){
      const maxN = 999;
      const fotos = Math.min(maxN, Math.max(0, parseInt(custFotos?.value||'0',10) || 0));
      const vids  = Math.min(maxN, Math.max(0, parseInt(custVideos?.value||'0',10) || 0));
      if(custFotos) custFotos.value = String(fotos);
      if(custVideos) custVideos.value = String(vids);
      const plat  = custPlataforma?.value||'reels';
      const tipo  = custTipoVideo?.value||'15';

      const dur = Math.max(15, (parseInt(tipo,10) || 15)); // segundos
      let unitVideo = PRICES.video15;
      if(dur<=15){
        unitVideo = PRICES.video15;
      }else if(dur<=45){
        unitVideo = PRICES.video45;
      }else if(dur<=60){
        unitVideo = PRICES.video60;
      }else{
        // acima de 60s: desconto progressivo por minuto (até 3h)
        unitVideo = longVideoUnitPrice(dur);
      }

      const mult = PRICES.platformMult[plat] ?? 1.0;

      let extraVideo=0, extraPhoto=0, extraOrder=0;
      EXTRA_OPTIONS.forEach(o=>{
        const el=document.getElementById(o.id);
        if(!el||!el.checked) return;
        if(o.kind==='video') extraVideo+=o.price;
        else if(o.kind==='photo') extraPhoto+=o.price;
        else extraOrder+=o.price;
      });

      const tMult = tierMultiplier();
      const rawTotal = (fotos*((PRICES.foto+extraPhoto)*tMult)) + (vids*(((unitVideo*mult)+extraVideo)*tMult)) + extraOrder;

      // jitter leve só pra não ficar "redondo", depois aplicamos jogo psicológico nos centavos
      const jitter = (fotos+vids)>0 ? (0.18 + ((fotos*5 + vids*9 + dur)%9)*0.07) : 0;
      const totalRaw = Math.max(0, rawTotal + jitter);

      // ✅ jogo de mercado no TOTAL (sem subir preço; só ajusta centavos)
      const total = marketRoundBRL(totalRaw, (fotos*31 + vids*17 + dur));

      if(custTotal) custTotal.textContent = brl(total);
      const urgent = document.getElementById('optUrgente')?.checked || false;
      if(custEntrega) custEntrega.textContent = calcEntrega(total, urgent);
    }

    [custFotos,custVideos,custPlataforma,custTipoVideo].forEach(el=>{
      if(!el) return;
      el.addEventListener('input', calcCustom);
      el.addEventListener('change', calcCustom);
    });
    Array.from(document.querySelectorAll('[data-custom-opt]')).forEach(el=>{
      el.addEventListener('change', calcCustom);
    });

    // ===== UI: Personalizado (5 principais + setinha) =====
    let showAllCustomOptions = false;
    function toggleCustomOptions(){
      showAllCustomOptions = !showAllCustomOptions;
      const more = document.getElementById('customOptsMore');
      const btn  = document.getElementById('toggleCustomOpts');
      if(more) more.classList.toggle('collapsed', !showAllCustomOptions);
      if(btn) btn.textContent = showAllCustomOptions ? 'Mostrar menos ↑' : 'Ver mais opções ↓';
    }

    // ===== Pedido -> Escolher Editor =====
    function choosePackage(id){
      // ✅ Permite ver os editores (bots) mesmo sem estar logado como Cliente (modo demo/teste).
      // Se não estiver logado, marcamos intenção de login para finalizar depois.
      const logged = isClientLogged();

      const p = packages.find(x => x.id === id);
      if(!p) return;

      currentOrder = {
        kind: 'package',
        packageId: p.id,
        title: `${p.id}. ${p.name}`,
        total: packagePrice(p),
        tier: PRICE_TIER,
        eta: p.eta,
        needsLogin: !logged
      };

      try{ uiSaveDebounced(); }catch(e){}

      if(!logged){
        try{ setPostLoginIntent({ type:'package', packageId:id }); }catch(e){}
      }

      if(typeof selectedEditorFromProcurar !== "undefined" && selectedEditorFromProcurar){
        openOrderConfirm();
      }else{
        startPickEditor();
      }
    }

    function confirmCustom(){
      const logged = isClientLogged();
      if(!logged){
        try{ setPostLoginIntent({ type:'package' }); }catch(e){}
      }
      currentOrder = {
        kind: 'custom',
        title: 'Pacote Personalizado',
        totalText: custTotal?.textContent || brl(0),
        eta: custEntrega?.textContent || '35min',
        fotos: parseInt(custFotos?.value||'0',10),
        videos: parseInt(custVideos?.value||'0',10),
        tier: PRICE_TIER,
        needsLogin: !logged
      };
      try{ uiSaveDebounced(); }catch(e){}
      if(typeof selectedEditorFromProcurar !== "undefined" && selectedEditorFromProcurar){
        openOrderConfirm();
      }else{
        startPickEditor();
      }
    }

    
    // ===== Finalização simples (demo) =====
    const LS_ORDERS = 'karamelo_orders_v1';

    async function createOrderAndFinish(){
      const order = {
        ...currentOrder,
        createdAt: Date.now(),
        client: { name: clientData?.full || 'Cliente', email: clientData?.email || '' },
        editor: selectedEditorFromProcurar ? { id:selectedEditorFromProcurar.id, name:selectedEditorFromProcurar.name } : null
      };

      // ✅ Beta: garante ID + status antes de salvar
      if(!order.id){
        order.id = 'LOCAL-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,7);
      }
      if(!order.status){
        order.status = 'AWAITING_PAYMENT';
      }


      // Se tiver backend conectado, tenta enviar o pedido
      try{
        if(typeof apiBase === 'function' && apiBase()){
          await apiFetch('/api/orders', { method:'POST', body: JSON.stringify({ order }) });
        }else if(typeof SUPABASE_ENABLED !== 'undefined' && SUPABASE_ENABLED){
          const created = await supaCreateOrderFlow(order);
          order._supa = { id: created?.id || null, created_at: created?.created_at || null };
          if(created?.id) order.id = created.id;
        }else{
          const arr = lsGet(LS_ORDERS, []);
          const list = Array.isArray(arr) ? arr : [];
          list.unshift(order);
          lsSet(LS_ORDERS, list.slice(0, 50));
        }
      }catch(e){
        // fallback local
        const arr = lsGet(LS_ORDERS, []);
        const list = Array.isArray(arr) ? arr : [];
        list.unshift(order);
        lsSet(LS_ORDERS, list.slice(0, 50));
      }

      return order;
    }

    function backToProcurarFromPackages(){
      selectedEditorFromProcurar = null;
      currentOrder = null;
      goProcurar(true);
    }

    function backToClientProfileFromPackages(){
      try{ paintClientProfile && paintClientProfile(); }catch(e){}
      showScreen(screenClientProfile, true);
    }

    // ===== Confirmação do pedido + Checkout (BETA) =====
    let activeOrderId = null;

    function ordersLoad(){
      const arr = lsGet(LS_ORDERS, []);
      return Array.isArray(arr) ? arr : [];
    }
    function ordersSave(list){
      const safe = Array.isArray(list) ? list : [];
      lsSet(LS_ORDERS, safe.slice(0, 80));
    }
    function upsertOrder(order){
      const list = ordersLoad();
      const id = String(order?.id || '');
      const idx = list.findIndex(o => String(o?.id||'') === id || (o?._supa?.id && order?._supa?.id && String(o._supa.id)===String(order._supa.id)));
      if(idx >= 0) list[idx] = { ...list[idx], ...order };
      else list.unshift(order);
      ordersSave(list);
      return order;
    }
    function getOrderById(orderId){
      const id = String(orderId||'');
      if(!id) return null;
      const list = ordersLoad();
      return list.find(o => String(o?.id||'') === id || (o?._supa?.id && String(o._supa.id)===id)) || null;
    }
    function setOrderStatus(orderId, status){
      const o = getOrderById(orderId);
      if(!o) return null;
      o.status = status;
      upsertOrder(o);

      // se tiver supabase, tenta atualizar (não quebra beta se falhar)
      try{
        if(typeof supaUpdateOrderStatus === 'function' && o?._supa?.id){
          supaUpdateOrderStatus(o._supa.id, status).catch(()=>{});
        }
      }catch(e){}
      return o;
    }

    function statusLabel(s){
      const st = String(s||'').toUpperCase();
      if(st==='AWAITING_PAYMENT') return 'Aguardando pagamento';
      if(st==='PAID') return 'Pago';
      if(st==='IN_PROGRESS') return 'Em andamento';
      if(st==='DONE') return 'Concluído';
      if(st==='CANCELLED') return 'Cancelado';
      return st || '—';
    }

    function ensureOrderHasEditor(){
      if(!currentOrder) return false;
      if(!currentOrder.editor && selectedEditorFromProcurar){
        const e = selectedEditorFromProcurar;
        currentOrder.editor = { id: e.id, name: e.name, rating: e.rating || e.stars || START_STARS, tags: e.tags || [] };
      }
      return true;
    }

    function openOrderConfirm(){
      if(!currentOrder){
        alert('Selecione um pacote/pedido primeiro.');
        return;
      }
      ensureOrderHasEditor();
      if(!currentOrder.editor){
        alert('Selecione um editor para continuar.');
        return;
      }

      // Preenche resumo
      const title = currentOrder.kind === 'package' ? currentOrder.title : 'Pacote Personalizado';
      const totalText = currentOrder.kind === 'package' ? brl(currentOrder.total || 0) : (currentOrder.totalText || brl(0));
      const eta = currentOrder.eta || '—';
      const editorName = currentOrder.editor?.name || 'Editor';
      const editorRate = (currentOrder.editor?.rating ?? START_STARS);
      const needLogin = !!currentOrder.needsLogin;

      if(orderSummary){
        orderSummary.innerHTML = `
          <h3 style="margin-top:0">Resumo</h3>
          <div class="pill" style="display:flex; gap:12px; flex-wrap:wrap">
            <span><b>Serviço:</b> ${escapeHtml(title)}</span>
            <span><b>Total:</b> ${escapeHtml(totalText)}</span>
            <span><b>Entrega:</b> ${escapeHtml(eta)}</span>
          </div>
          <div class="pill" style="margin-top:10px"><b>Editor:</b> ${escapeHtml(editorName)} • <b>Avaliação:</b> ${escapeHtml(String(editorRate))}/${MAX_STARS} ⭐</div>
          ${needLogin ? `<div class="hint" style="margin-top:10px">* Você não está logado. No beta dá para testar, mas no lançamento vamos exigir login para finalizar.</div>` : ``}
        `;
      }

      if(btnGoPay){
        btnGoPay.onclick = () => { void goToPaymentFromConfirm(); };
      }

      if(orderOverlay){
        orderOverlay.classList.remove('closing');
        orderModal?.classList.remove('closing');
        orderOverlay.classList.add('show');
        orderOverlay.setAttribute('aria-hidden','false');
      }
    }

    function closeOrderConfirm(){
      if(!orderOverlay) return;
      orderOverlay.classList.add('closing');
      orderModal?.classList.add('closing');
      setTimeout(()=>{
        orderOverlay.classList.remove('show','closing');
        orderModal?.classList.remove('closing');
        orderOverlay.setAttribute('aria-hidden','true');
      }, 220);
    }

    function buildPixPayload(order){
      const id = escapeHtml(String(order?.id || 'LOCAL'));
      const total = escapeHtml(order?.totalText || brl(order?.total || 0));
      // Placeholder PIX (beta)
      return `PIX-BETA|KARAMELOO|PEDIDO:${id}|TOTAL:${total}|GERADO:${new Date().toLocaleString('pt-BR')}`;
    }

    async function goToPaymentFromConfirm(){
      try{
        if(btnGoPay){ btnGoPay.disabled = true; btnGoPay.textContent = 'Gerando pedido...'; }

        // Cria e salva pedido
        const saved = await createOrderAndFinish();
        if(!saved) throw new Error('Pedido não foi criado');

        upsertOrder(saved);
        activeOrderId = saved.id || saved?._supa?.id || null;

        try{ uiSaveDebounced(); }catch(e){}

        // Abre checkout
        showCheckoutForOrder(saved);

        // fecha modal
        closeOrderConfirm();
      }catch(err){
        console.error(err);
        alert('Não foi possível criar o pedido. Abra o Console (F12) e me mande o erro.');
      }finally{
        if(btnGoPay){ btnGoPay.disabled = false; btnGoPay.textContent = 'Ir para pagamento'; }
      }
    }

    function showCheckoutForOrder(order){
      const o = order || (activeOrderId ? getOrderById(activeOrderId) : null) || currentOrder;
      if(!o) return;

      const title = o.kind === 'package' ? o.title : 'Pacote Personalizado';
      const totalText = o.totalText || brl(o.total || 0);
      const eta = o.eta || '—';
      const editorName = o.editor?.name || '—';

      if(checkoutOrderTitle) checkoutOrderTitle.textContent = `${title}`;
      if(checkoutOrderMeta) checkoutOrderMeta.textContent = `Editor: ${editorName} • Total: ${totalText} • Entrega: ${eta} • ID: ${o.id || 'LOCAL'}`;
      if(checkoutStatus) checkoutStatus.textContent = statusLabel(o.status || 'AWAITING_PAYMENT');
      if(checkoutPixCode) checkoutPixCode.value = buildPixPayload(o);

      // habilita chat só se pago
      const paid = String(o.status||'').toUpperCase() !== 'AWAITING_PAYMENT';
      if(btnOpenOrderChat){
        btnOpenOrderChat.disabled = !paid;
      }

      showScreen(screenCheckout, true);
    }

    function openChatForOrder(orderId){
      const o = getOrderById(orderId) || null;
      if(!o){
        alert('Pedido não encontrado.');
        return;
      }
      if(String(o.status||'').toUpperCase()==='AWAITING_PAYMENT'){
        alert('Confirme o pagamento para liberar o chat.');
        return;
      }
      // configura chatCtx para usar chave por pedido
      const peerName = o.editor?.name || 'Editor';
      chatCtx = {
        peerId: o.editor?.id || 'editor',
        peerName,
        peerWhats: '',
        key: `karamelo_chat_order_${o.id}`
      };
      if(chatTitle) chatTitle.textContent = `Chat do pedido • ${peerName}`;
      renderChat();
      if(chatOverlay){
        chatOverlay.classList.remove('closing');
        chatModal?.classList.remove('closing');
        chatOverlay.classList.add('show');
        chatOverlay.setAttribute('aria-hidden','false');
        setTimeout(()=> chatInput?.focus(), 60);
      }
    }

    // Checkout buttons
    btnCopyPix?.addEventListener('click', ()=>{
      try{
        checkoutPixCode?.select();
        document.execCommand('copy');
      }catch(e){}
      try{ navigator.clipboard?.writeText(checkoutPixCode?.value || ''); }catch(e){}
      toast && toast('PIX copiado!');
    });

    btnConfirmPaid?.addEventListener('click', ()=>{
      if(!activeOrderId){
        alert('Nenhum pedido ativo para confirmar.');
        return;
      }
      const updated = setOrderStatus(activeOrderId, 'PAID');
      if(updated){
        if(checkoutStatus) checkoutStatus.textContent = statusLabel(updated.status);
        if(btnOpenOrderChat) btnOpenOrderChat.disabled = false;
        toast && toast('Pagamento confirmado (BETA). Chat liberado!');
        try{ uiSaveDebounced(); }catch(e){}
      }
    });

    btnOpenOrderChat?.addEventListener('click', ()=>{
      if(!activeOrderId) return;
      openChatForOrder(activeOrderId);
    });



function startPickEditor(){
      const pickInfo = document.getElementById('pickInfo');
      const pickRatingChip = document.getElementById('pickRatingChip');
      if(pickRatingChip) pickRatingChip.textContent = `Avaliação: ${START_STARS.toFixed(0)}/${MAX_STARS} ⭐`;

      if(currentOrder?.kind === 'package'){
        if(pickInfo) pickInfo.textContent = `Pedido: ${currentOrder.title} • ${brl(currentOrder.total)} • ${currentOrder.eta}`;
      }else{
        if(pickInfo) pickInfo.textContent = `Pedido: Personalizado • ${currentOrder.totalText} • ${currentOrder.eta}`;
      }

      // Mostra a tela primeiro (para não parecer que “não aconteceu nada”)
      showScreen(screenPickEditor);

      // Render com proteção (se der erro, ainda assim o usuário vê feedback)
      try{
        renderPickEditors();
      }catch(err){
        console.error('renderPickEditors error:', err);
        const grid = document.getElementById('editorsGrid');
        if(grid){
          grid.innerHTML = `<div class="card full" style="grid-column:1/-1">
            <h3>Ops! Algo deu errado ao carregar os editores</h3>
            <p>Abra o Console (F12) e me mande o erro que apareceu. Eu arrumo na hora.</p>
          </div>`;
        }
      }
    }

    function backToOrder(){ showScreen(screenClient); }

    // ===== EDITOR (dashboard) =====
    const editorAvatarBox = document.getElementById('editorAvatarBox');
    const editorFullName = document.getElementById('editorFullName');
    const editorStars = document.getElementById('editorStars');

    const editorPhoto = document.getElementById('editorPhoto');
    const edAvailable = document.getElementById('edAvailable');
    const edAvailText = document.getElementById('edAvailText');

    const edRatingTxt = document.getElementById('edRatingTxt');
    const edStarsRow = document.getElementById('edStarsRow');
    const edDone = document.getElementById('edDone');
    const edStatus = document.getElementById('edStatus');

    const edXp = document.getElementById('edXp');
    const edWhats = document.getElementById('edWhats');
    const edBio = document.getElementById('edBio');
    const edSoft = document.getElementById('edSoft');
    const edPortfolio = document.getElementById('edPortfolio');
    const edTags = document.getElementById('edTags');
    const edTagsPreview = document.getElementById('edTagsPreview');

    const edSearchPkg = document.getElementById('edSearchPkg');
    const edQuick = document.getElementById('edQuick');
    const edPkgCount = document.getElementById('edPkgCount');
    const edPkgHint = document.getElementById('edPkgHint');
    const edPublicPreview = document.getElementById('edPublicPreview');

    let editorData = lsGet(LS_EDITOR, null);

    // ===== Portfólio (Editor) - demo (não salva em localStorage por tamanho) =====
    let workPhotos = []; // object URLs
    let workVideos = []; // object URLs

    function updateWorkUI(){
      const c = document.getElementById('edWorkCount');
      const g = document.getElementById('edWorkGrid');
      if(c) c.textContent = `${workPhotos.length}/${MAX_WORK_PHOTOS} fotos • ${workVideos.length}/${MAX_WORK_VIDEOS} vídeos`;
      if(!g) return;
      g.innerHTML = '';
      const addItem = (node)=>{
        const wrap = document.createElement('div');
        wrap.className='work-item';
        wrap.appendChild(node);
        g.appendChild(wrap);
      };
      workPhotos.forEach(url=>{
        const img=document.createElement('img');
        img.src=url;
        img.loading='lazy';
        addItem(img);
      });
      workVideos.forEach(url=>{
        const v=document.createElement('video');
        v.src=url;
        v.muted=true;
        v.playsInline=true;
        v.controls=true;
        addItem(v);
      });
    }

    function clearEditorWorks(){
      workPhotos.forEach(u=>{ try{ URL.revokeObjectURL(u);}catch(e){} });
      workVideos.forEach(u=>{ try{ URL.revokeObjectURL(u);}catch(e){} });
      workPhotos=[]; workVideos=[];
      const inP=document.getElementById('edWorkPhotos');
      const inV=document.getElementById('edWorkVideos');
      if(inP) inP.value='';
      if(inV) inV.value='';
      updateWorkUI();
    }

    function addFilesToWork(type, files){
      const arr = (type==='photo') ? workPhotos : workVideos;
      const max = (type==='photo') ? MAX_WORK_PHOTOS : MAX_WORK_VIDEOS;
      const left = Math.max(0, max - arr.length);
      const list = Array.from(files||[]).slice(0, left);
      if((files||[]).length > left){
        alert(`Limite atingido: no máximo ${max} ${type==='photo'?'fotos':'vídeos'}.`);
      }
      list.forEach(f=>{
        try{ arr.push(URL.createObjectURL(f)); }catch(e){}
      });
      updateWorkUI();
    }



    function ensureEditorData(nome, sobrenome){
      const full = `${nome} ${sobrenome}`.trim();
      editorData = editorData || {
        first:nome||'Editor',
        last:sobrenome||'',
        full: full || 'Editor',
        stars: START_STARS,
        photo:'',
        cover:{preset:'none', img:''},
        available:false,
        xp:'iniciante',
        whats:'',
        bio:'',
        soft:'',
        portfolio:'',
        tags:[],
        done:0,
        status:'Novo',
        packages:[],
        cpf:'',
        email:'',
        dob:''
      };
      editorData.first = nome || editorData.first;
      editorData.last = sobrenome || editorData.last;
      editorData.full = full || editorData.full;
      editorData.stars = START_STARS;
      lsSet(LS_EDITOR, editorData);
    }

    function renderTagsPreview(){
      if(!edTagsPreview) return;
      const raw = (edTags?.value||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,12);
      edTagsPreview.innerHTML = raw.map(t=>`<span class="tag blue">${escapeHtml(t)}</span>`).join('');
    }

    function paintEditor(){
      if(editorName) editorName.textContent = editorData?.first || 'Editor';
      if(editorFullName) editorFullName.textContent = editorData?.full || 'Editor';

      if(editorStars) editorStars.innerHTML = renderStarsHTML(editorData?.stars ?? START_STARS, MAX_STARS);
      if(edRatingTxt) edRatingTxt.textContent = String((editorData?.stars ?? START_STARS).toFixed(1));
      if(edStarsRow) edStarsRow.innerHTML = renderStarsHTML(editorData?.stars ?? START_STARS, MAX_STARS);

      if(edDone) edDone.textContent = String(editorData?.done || 0);
      if(edStatus) edStatus.textContent = editorData?.status || 'Novo';

      if(edAvailable){
        edAvailable.checked = !!editorData?.available;
        if(edAvailText) edAvailText.textContent = editorData?.available ? 'On' : 'Off';
      }

      if(edXp) edXp.value = editorData?.xp || 'iniciante';
      if(edWhats) edWhats.value = editorData?.whats || '';
      if(edBio) edBio.value = editorData?.bio || '';
      if(edSoft) edSoft.value = editorData?.soft || '';
      if(edPortfolio) edPortfolio.value = editorData?.portfolio || '';
      if(edTags) edTags.value = (editorData?.tags || []).join(', ');

      setAvatar(editorAvatarBox, editorData?.photo, (editorData?.full||'E')[0]);
      applyCoverToEl(document.getElementById('editorCover'), editorData?.cover);

      renderTagsPreview();
      renderEditorPackages();
      updatePkgCount();
      renderPublicPreview();
    }

    editorPhoto?.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file || !editorData) return;
      try{
        const data = await checkAndReadImage(file);
        editorData.photo = data;
      }catch(err){
        alert(String(err.message||err));
        e.target.value='';
        return;
      }
      lsSet(LS_EDITOR, editorData);
      paintEditor();
    });

    function removeEditorPhoto(){
      if(!editorData) return;
      editorData.photo = '';
      lsSet(LS_EDITOR, editorData);
      paintEditor();
    }

    edAvailable?.addEventListener('change', ()=>{
      if(!editorData) return;
      editorData.available = !!edAvailable.checked;
      if(edAvailText) edAvailText.textContent = editorData.available ? 'On' : 'Off';
      lsSet(LS_EDITOR, editorData);
      renderPublicPreview();
    });

    edTags?.addEventListener('input', renderTagsPreview);

    function saveEditorProfile(){
      if(!editorData) editorData = {first:'Editor', last:'', full:'Editor', stars:START_STARS, packages:[]};
      editorData.xp = edXp?.value || 'iniciante';
      editorData.whats = (edWhats?.value||'').trim();
      editorData.bio = (edBio?.value||'').trim();
      editorData.soft = (edSoft?.value||'').trim();
      editorData.portfolio = (edPortfolio?.value||'').trim();
      editorData.tags = (edTags?.value||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,12);
      editorData.stars = START_STARS;
      lsSet(LS_EDITOR, editorData);
      renderPublicPreview();
      alert('Perfil do editor salvo (demo).');
    }

    function resetEditor(){
      localStorage.removeItem(LS_EDITOR);
      editorData = null;
      alert('Reset feito. Reabra como Editor para criar de novo.');
      goBackStart();
    }



    // ===== Limites / validações rápidas =====
    const MAX_EDITOR_PACKAGES = 10;
    const MAX_WORK_PHOTOS = 30;
    const MAX_WORK_VIDEOS = 10;

    // clamp para números (ex: fotos/vídeos no personalizado)
    function clampInt(val, min, max){
      const n = parseInt(val||'0',10);
      if(isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    // ===== Pacotes do Editor (thumbs + só 5 + seta + atalhos) =====
    let showAllPackages = false;

    function toggleMorePackages(){
      showAllPackages = !showAllPackages;
      const btn = document.getElementById('toggleMorePkgs');
      if(btn) btn.textContent = showAllPackages ? 'Mostrar menos ↑' : 'Ver mais pacotes ↓';
      renderEditorPackages();
    }

    function updatePkgCount(){
      const count = (editorData?.packages || []).length;
      if(edPkgCount) edPkgCount.textContent = String(count);
      if(edPkgHint) edPkgHint.textContent = count ? 'Perfeito: você vai aparecer em pedidos compatíveis.' : 'Dica: selecione pelo menos 1 pacote para aparecer para clientes.';
    }

    function renderEditorPackages(){
      const wrap = document.getElementById('editorPackages');
      if(!wrap) return;

      const search = (edSearchPkg?.value || '').toLowerCase().trim();
      const quick = (edQuick?.value || 'all');

      if((search && !showAllPackages) || (quick !== 'all' && !showAllPackages)){
        showAllPackages = true;
        const btn = document.getElementById('toggleMorePkgs');
        if(btn) btn.textContent = 'Mostrar menos ↑';
      }

      wrap.innerHTML = '';

      packages.forEach((p, index) => {
        if(!showAllPackages && index >= 5) return;

        const text = `${p.name} ${p.items.join(' ')}`.toLowerCase();
        if(search && !text.includes(search)) return;

        const isVideo = p.name.toLowerCase().includes('vídeo') || p.name.toLowerCase().includes('short');
        const isFoto  = p.name.toLowerCase().includes('foto');
        const isMix   = p.name.toLowerCase().includes('combo') || p.name.toLowerCase().includes('mix') || (isVideo && isFoto);

        if(quick === 'video' && !isVideo) return;
        if(quick === 'foto' && !isFoto) return;
        if(quick === 'mix' && !isMix) return;
        if(quick === 'audio' && index < 8) return; // áudio a partir do pacote 9

        const checked = (editorData?.packages || []).includes(p.id);
        const audioExtras = (index >= 8) ? `<div class="pkg-meta">🎧 Ajustes de áudio incluídos</div>` : '';

        const el = document.createElement('label');
        el.className = 'pkg-item';
        el.innerHTML = `
          <div class="pkg-thumb"></div>
          <div>
            <div style="display:flex; gap:10px; align-items:flex-start;">
              <input type="checkbox" data-pkg="${p.id}" ${checked ? 'checked' : ''}>
              <div>
                <div class="pkg-title">${p.id}. ${escapeHtml(p.name)}</div>
                <div class="pkg-sub">Entrega: ${escapeHtml(p.eta)} • ${brl(p.price)}</div>
              </div>
            </div>
            <div class="pkg-meta">${p.items.map(x=>escapeHtml(x)).join(' • ')}</div>
            ${audioExtras}
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.querySelectorAll('input[type="checkbox"][data-pkg]').forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const id = Number(chk.getAttribute('data-pkg'));
          if(!editorData) return;
          editorData.packages = editorData.packages || [];

          if(chk.checked){
            if(!editorData.packages.includes(id)) {
              if(editorData.packages.length >= MAX_EDITOR_PACKAGES){
                chk.checked = false;
                alert(`Limite atingido: no máximo ${MAX_EDITOR_PACKAGES} pacotes por editor.`);
                return;
              }
              editorData.packages.push(id);
            }
          }else{
            editorData.packages = editorData.packages.filter(x=>x!==id);
          }
          lsSet(LS_EDITOR, editorData);
          updatePkgCount();
          renderPublicPreview();
        });
      });
    }

    edSearchPkg?.addEventListener('input', renderEditorPackages);
    edQuick?.addEventListener('change', renderEditorPackages);

    function selectAllEditorPackages(flag){
      if(!editorData) return;
      editorData.packages = flag ? packages.slice(0, MAX_EDITOR_PACKAGES).map(p=>p.id) : [];
      lsSet(LS_EDITOR, editorData);
      renderEditorPackages();
      updatePkgCount();
      renderPublicPreview();
    }

    function saveEditorPackages(){
      lsSet(LS_EDITOR, editorData);
      alert('Pacotes salvos (demo).');
    }

    function renderPublicPreview(){
      if(!edPublicPreview) return;

      const tags = (editorData?.tags || []).slice(0,8);
      const pkgs = (editorData?.packages || []).slice(0,6);

      const pkgBadges = pkgs.map(id=>{
        const p = packages.find(x=>x.id===id);
        return p ? `<span class="badge pillBlue">${escapeHtml(p.name)}</span>` : '';
      }).join('');

      const tagBadges = tags.map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join('');

      const statusBadge = editorData?.available
        ? `<span class="badge you">Disponível</span>`
        : `<span class="badge off">Indisponível</span>`;

      edPublicPreview.innerHTML = `
        <div class="eTop">
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="avatar" style="width:48px;height:48px" id="pubAvatar"></div>
            <div>
              <div class="eName">${escapeHtml(editorData?.full || 'Editor')}</div>
              <div class="stars" style="margin-top:4px">${renderStarsHTML(editorData?.stars ?? START_STARS, MAX_STARS)}</div>
              <div class="eMeta">${escapeHtml(editorData?.xp || 'iniciante')} • ${escapeHtml(editorData?.soft || 'Softwares')}</div>
            </div>
          </div>
          <div style="text-align:right">
            ${statusBadge}
            <div class="eMeta" style="margin-top:6px">Pacotes: <strong>${(editorData?.packages||[]).length}</strong></div>
          </div>
        </div>

        <div class="eBio">${escapeHtml(editorData?.bio || 'Escreva uma bio curta e forte para aparecer melhor para clientes.')}</div>

        <div class="eBadges">${tagBadges || `<span class="badge off">Sem tags</span>`}</div>

        <div class="eBadges" style="margin-top:10px">${pkgBadges || `<span class="badge off">Sem pacotes selecionados</span>`}</div>

        <div class="hint" style="margin-top:10px">* Demo sem backend: informações ficam salvas no seu navegador.</div>
      `;

      const pubAvatar = document.getElementById('pubAvatar');
      setAvatar(pubAvatar, editorData?.photo, (editorData?.full||'E')[0]);
    }

    // ===== Tela “Escolher Editor” (demo) =====
    const DEMO_EDITORS = [
      { id:'d1', name:'Editor Neon',  xp:'avancado', tags:['Reels','TikTok','Áudio'], packages:[4,6,9,11,13,14,15], available:true,  stars:START_STARS },
      { id:'d2', name:'Editor Flux',  xp:'intermediario', tags:['Foto pro','Cor cine'], packages:[1,2,3,5,8,10,12,15], available:true, stars:START_STARS },
      { id:'d3', name:'Editor Pulse', xp:'intermediario', tags:['Motion','Legendas'], packages:[4,6,7,9,11,13,15], available:true, stars:START_STARS },
      { id:'d4', name:'Editor Vibe',  xp:'iniciante', tags:['Shorts','Cortes'], packages:[4,6,7,9], available:true, stars:START_STARS },
      { id:'d5', name:'Editor Clean', xp:'avancado', tags:['Áudio','Ruído','Voz'], packages:[9,11,13,14,15], available:true, stars:START_STARS },
    ];

    function getAllEditors(){
      const list = [];
      if(editorData){
        list.push({
          id:'you',
          name: editorData.full || 'Você',
          xp: editorData.xp || 'iniciante',
          tags: editorData.tags || [],
          packages: editorData.packages || [],
          available: !!editorData.available,
          photo: editorData.photo || '',
          stars: editorData.stars ?? START_STARS
        });
      }
      DEMO_EDITORS.forEach(e=> list.push({...e}));
      return list;
    }

    function isCompatible(editor, order){
      if(!editor.available) return false;
      // ✅ BOTS DEMO (testes): sempre compatíveis, para você sempre ver opções ao escolher um pacote
      if(String(editor.id||'').startsWith('d')) return true;
if(order?.kind === 'package') return (editor.packages || []).includes(order.packageId);

      const vids = Number(order?.videos||0);
      const fotos = Number(order?.fotos||0);

      if(vids > 0){
        return (editor.packages||[]).some(id => {
          const p = packages.find(x=>x.id===id);
          const n = (p?.name||'').toLowerCase();
          return n.includes('vídeo') || n.includes('short');
        });
      }
      if(fotos > 0){
        return (editor.packages||[]).some(id => {
          const p = packages.find(x=>x.id===id);
          const n = (p?.name||'').toLowerCase();
          return n.includes('foto');
        });
      }
      return (editor.packages||[]).length > 0;
    }

    function renderPickEditors(){
  const grid = document.getElementById('editorsGrid');
  if(!grid) return;

  const sort = document.getElementById('pickSort')?.value || 'best';
  const all = getAllEditors();

  let compatible = all.filter(e => isCompatible(e, currentOrder));

  // Filtra por nível escolhido (iniciante/intermediário/avançado)
  const _tier = normTier(currentOrder?.tier || PRICE_TIER || 'avancado');
  const tierRank = (t)=>({ iniciante:1, intermediario:2, avancado:3 }[normTier(t)] || 1);

  // Regra: mostra SOMENTE o nível escolhido
  // iniciante -> só iniciantes, intermediário -> só intermediários, avançado -> só avançados
  compatible = compatible.filter(e => normTier(e.xp) === _tier);

  if(sort === 'fast'){
    compatible.sort((a,b)=> tierRank(b.xp) - tierRank(a.xp));
  }else{
    compatible.sort((a,b)=>(Number(b.stars||START_STARS))-(Number(a.stars||START_STARS)));
  }

  grid.innerHTML = '';
  if(!compatible.length){
    grid.innerHTML = `<div class="card full" style="grid-column:1/-1">
      <h3>Nenhum editor compatível (demo)</h3>
      <p>Peça para um editor marcar os pacotes compatíveis e ficar “Disponível”.</p>
    </div>`;
    return;
  }

  window._pickEditorsById = window._pickEditorsById || {};
  compatible.forEach(e=>{
    window._pickEditorsById[e.id] = e;

    const you = e.id === 'you';
    const card = document.createElement('div');
    card.className = 'eCard';

    card.innerHTML = `
      <div class="eTop">
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="avatar" style="width:46px;height:46px" id="pickAv_${e.id}">${escapeHtml(e.name[0])}</div>
          <div>
            <div class="eName">${escapeHtml(e.name)} ${you ? '• (Você)' : ''}</div>
            <div class="stars" style="margin-top:4px">${renderStarsHTML(e.stars ?? START_STARS, MAX_STARS)}</div>
            <div class="eMeta">${escapeHtml(e.xp)} • Pacotes: ${e.packages?.length||0}</div>
          </div>
        </div>
        <div><span class="badge ${e.available ? 'you' : 'off'}">${e.available ? 'Disponível' : 'Off'}</span></div>
      </div>

      <div class="eBio">${escapeHtml((e.tags||[]).slice(0,5).join(' • ') || 'Editor demo')}</div>
      <div class="eBadges">
        ${(e.tags||[]).slice(0,6).map(t=>`<span class="badge pillBlue">${escapeHtml(t)}</span>`).join('') || `<span class="badge off">Sem tags</span>`}
      </div>

      <div class="eActions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn" type="button" data-action="select-editor" data-editor-id="${e.id}">Selecionar este editor</button>
        <button class="btn secondary" type="button" data-action="view-editor-profile" data-editor-id="${e.id}">Ver perfil do editor</button>
      </div>
      <div class="hint">* Demo: sem pagamento/entrega real ainda.</div>
    `;

    grid.appendChild(card);

    const av = document.getElementById(`pickAv_${e.id}`);
    if(av) setAvatar(av, e.photo || '', e.name[0]);
  });
}

// ✅ Perfil do editor na etapa "Escolha seu Editor"
window.openEditorProfileFromPick = function(id){
  try{
    const _id = String(id||'');

    // tenta pegar do cache do pick; fallback para lista geral
    const pickMap = window._pickEditorsById || {};
    const e = pickMap[_id] || (typeof getAllEditors==='function' ? (getAllEditors()||[]).find(x=>String(x.id)===_id) : null);

    // garante que o perfil consiga abrir mesmo fora do "Explorar"
    window.exploreEditorsById = window.exploreEditorsById || {};
    if(e) window.exploreEditorsById[_id] = e;

    // caso especial: perfil do "you" (você)
    if(_id==='you' && !window.exploreEditorsById[_id]){
      window.exploreEditorsById[_id] = {
        id:'you',
        name: (document.getElementById('editorName')?.textContent || 'Você'),
        xp: (window.editorData?.xp || 'avancado'),
        stars: (window.editorData?.stars ?? START_STARS),
        available: !!window.editorData?.available,
        photo: (window.editorData?.photo || ''),
        tags: (window.editorData?.tags || []),
        bio: (window.editorData?.bio || 'Perfil do editor (você).'),
        packages: (window.editorData?.packages || [])
      };
    }

    if(typeof openEditorProfile==='function'){
      openEditorProfile(_id);
    }
  }catch(err){
    console.error('openEditorProfileFromPick error:', err);
  }
};

document.getElementById('pickSort')?.addEventListener('change', renderPickEditors);

    function selectEditor(id){
      // Quando o cliente escolhe um editor, a gente FINALIZA o pedido e salva no Supabase.
      if(!currentOrder){
        alert('Antes de escolher o editor, selecione um pacote/pedido primeiro.');
        return;
      }
      let e = null;

      if(id === 'you'){
        if(!editorData?.available){
          alert('Seu perfil está como OFF. Ative “Disponível” no painel do editor.');
          return;
        }
        e = {
          id: (currentSession?.user?.id || 'you'),
          name: (editorData?.displayName || 'Você'),
          rating: (editorData?.rating || 5),
          tags: (editorData?.tags || [])
        };
      } else {
        e = (exploreEditorsById && exploreEditorsById[id]) || (exploreEditorsCache || []).find(x => x.id === id) || { id, name:'Editor', rating:5, tags:[] };
      }

      selectedEditorFromProcurar = e;
      currentOrder.editor = { id: e.id, name: e.name, rating: e.rating, tags: e.tags };

      // Abre confirmação do pedido em NOVA ABA (BETA)
      openConfirmTabFromCurrentOrder();
    }

    // Expor no escopo global para funcionar com onclick
    window.selectEditor = selectEditor;

    // =========================
    // ✅ Delegação de cliques (anti-bug)
    // Evita problemas de onclick não achar função / escopo / HTML gerado por template.
    // =========================
    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button, a, [role="button"]');
      if(!btn) return;
      const act = btn.getAttribute('data-action');
      if(!act) return;

      try{
        if(act === 'choose-package'){
          ev.preventDefault();
          const pid = parseInt(btn.getAttribute('data-package-id')||'0', 10);
          if(Number.isFinite(pid) && pid>0) choosePackage(pid);
          return;
        }
        if(act === 'select-editor'){
          ev.preventDefault();
          const eid = String(btn.getAttribute('data-editor-id')||'').trim();
          if(eid) selectEditor(eid);
          return;
        }
        if(act === 'view-editor-profile'){
          ev.preventDefault();
          const eid = String(btn.getAttribute('data-editor-id')||'').trim();
          if(eid) openEditorProfile(eid);
          return;
        }
      }catch(err){
        console.error('click handler error:', err);
        alert('Ops! Algo deu errado. Abra o Console (F12) para ver o erro.');
      }
    });

    // =========================
    // ✅ Flow BETA em nova aba: Confirmar Pedido -> Pagamento (demo) -> Chat
    // =========================
    const ORDER_STORE_KEY = 'kml_beta_orders_v1';

    function safeJsonParse(s, fallback){
      try{ return JSON.parse(s); }catch(e){ return fallback; }
    }
    function loadOrders(){
      return safeJsonParse(localStorage.getItem(ORDER_STORE_KEY) || '[]', []);
    }
    function saveOrders(list){
      localStorage.setItem(ORDER_STORE_KEY, JSON.stringify(list||[]));
    }
    function upsertOrder(order){
      if(!order) return;
      const list = loadOrders();
      const idx = list.findIndex(o => o && o.id === order.id);
      if(idx >= 0) list[idx] = order;
      else list.unshift(order);
      saveOrders(list);
      localStorage.setItem('kml_beta_order_'+order.id, JSON.stringify(order));
    }
    function getOrderById(id){
      const direct = localStorage.getItem('kml_beta_order_'+id);
      if(direct) return safeJsonParse(direct, null);
      const list = loadOrders();
      return list.find(o => o && o.id === id) || null;
    }
    function genOrderId(){
      return 'ord_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }
    function normalizeOrderForStore(order){
      const o = JSON.parse(JSON.stringify(order||{}));
      if(!o.id) o.id = genOrderId();
      if(!o.status) o.status = 'AWAITING_PAYMENT';
      o.updatedAt = new Date().toISOString();
      if(!o.createdAt) o.createdAt = o.updatedAt;
      return o;
    }

    function encodeBetaPayload(obj){
      try{
        const json = JSON.stringify(obj || {});
        // base64url
        return btoa(unescape(encodeURIComponent(json)))
          .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      }catch(e){ return ''; }
    }
    function decodeBetaPayload(str){
      try{
        const s = String(str||'').replace(/-/g,'+').replace(/_/g,'/');
        const pad = s.length % 4 ? '='.repeat(4 - (s.length % 4)) : '';
        const json = decodeURIComponent(escape(atob(s + pad)));
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function openConfirmTabFromCurrentOrder(){
      try{
        if(!currentOrder) { alert('Selecione um pacote primeiro.'); return; }
        ensureOrderHasEditor();
        if(!currentOrder.editor){ alert('Selecione um editor para continuar.'); return; }

        // Monta um payload "preview" (não cria pedido ainda — evita bug e evita forçar pagamento na aba atual)
        const pkg = (currentOrder.kind !== 'custom') ? (packages || []).find(p => p.id === currentOrder.packageId) : null;
        const totalN = Number(currentOrder.total ?? (pkg ? pkg.price : 0) ?? 0);
        const payload = {
          v: 1,
          kind: currentOrder.kind || (pkg ? 'package' : 'custom'),
          packageId: currentOrder.packageId || (pkg ? pkg.id : null),
          title: currentOrder.title || (pkg ? pkg.name : 'Pacote Personalizado'),
          total: totalN,
          totalText: currentOrder.totalText || brl(totalN),
          eta: currentOrder.eta || (pkg ? pkg.eta : '—'),
          items: Array.isArray(currentOrder.items) ? currentOrder.items : (pkg ? (pkg.items||[]) : []),
          editor: currentOrder.editor,
          createdAt: new Date().toISOString()
        };

        const enc = encodeBetaPayload(payload);
        // Em vez de abrir nova aba, mostramos a confirmação AQUI MESMO (uma única aba)
        location.hash = '#beta_preview=' + encodeURIComponent(enc);
        try{ handleBetaHashRoutes(); }catch(e){}
        // Não resetamos o fluxo automaticamente; o usuário pode fechar e escolher outro pacote/editor.
      }catch(err){
        console.error('openConfirmTabFromCurrentOrder error:', err);
        alert('Erro ao abrir confirmação. Veja o Console (F12).');
      }
    }

    function renderBetaTabUI(order, step){
      // step: 'confirm' | 'pay' | 'done'
      let root = document.getElementById('betaTabRoot');
      if(!root){
        root = document.createElement('div');
        root.id = 'betaTabRoot';
        document.body.appendChild(root);
      }
      document.body.classList.add('betaTabMode');

      // Resolve itens do pacote (evita ReferenceError e evita aba vazia)
      let items = [];
      try{
        if(Array.isArray(order?.items)) items = order.items.slice();
        if(!items.length && order?.packageId){
          const pkg = (packages||[]).find(p => p.id === order.packageId);
          if(pkg && Array.isArray(pkg.items)) items = pkg.items.slice();
        }
      }catch(e){ items = []; }

      const title = escapeHtml(order.title || 'Pedido');
      const totalText = escapeHtml(order.totalText || brl(order.total||0));
      const eta = escapeHtml(order.eta || '—');
      const editorName = escapeHtml(order.editor?.name || 'Editor');
      const rating = escapeHtml(String(order.editor?.rating ?? START_STARS));
      const statusLabel = (order.status === 'PAID') ? 'Pago'
                        : (order.status === 'AWAITING_PAYMENT') ? 'Aguardando pagamento'
                        : (order.status === 'DRAFT') ? 'Rascunho'
                        : (order.status === 'PREVIEW') ? 'Prévia'
                        : escapeHtml(String(order.status||'—'));

      const itemsBlock = items.length ? `
        <div class="pill" style="margin-top:10px">
          <b>O que vem:</b>
          <div style="margin-top:6px">
            <ul style="margin:0; padding-left:18px">
              ${items.map(i => `<li>${escapeHtml(i)}</li>`).join('')}
            </ul>
          </div>
        </div>
      ` : '';

      const tags = Array.isArray(order.editor?.tags) ? order.editor.tags : [];
      const tagsBlock = tags.length ? `
        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px">
          ${tags.map(t => `<span class="pill" style="padding:6px 10px">${escapeHtml(t)}</span>`).join('')}
        </div>
      ` : `<div class="hint" style="margin-top:8px">Tags: —</div>`;

      function ensurePersisted(status){
        // Cria um pedido real só quando o usuário clicar em pagar/chat
        try{
          if(order.id){
            const existing = getOrderById(order.id);
            if(existing) return existing;
          }
        }catch(e){}
        const stored = normalizeOrderForStore({
          id: null,
          kind: order.kind,
          packageId: order.packageId,
          title: order.title || 'Pedido',
          total: Number(order.total||0),
          totalText: order.totalText || brl(Number(order.total||0)),
          eta: order.eta || '—',
          items: items,
          editor: order.editor,
          status: status || 'DRAFT'
        });
        order.id = stored.id;
        order.status = stored.status;
        order.items = stored.items || items;
        upsertOrder(stored);
        return stored;
      }

      function openChatForOrder(o){
        try{
          chatCtx = {
            peerId: o.editor?.id || '',
            peerName: o.editor?.name || 'Editor',
            peerWhats: o.editor?.whats || '',
            key: 'chat_order_' + String(o.id||'')
          };
          if(chatTitle) chatTitle.textContent = `Chat do pedido • ${o.editor?.name || 'Editor'}`;
          renderChat();
          if(chatOverlay){
            chatOverlay.classList.remove('closing');
            chatModal?.classList.remove('closing');
            chatOverlay.classList.add('show');
            chatOverlay.style.display = 'flex';
          }
        }catch(e){
          console.error('openChatForOrder error', e);
          alert('Não consegui abrir o chat. Veja o Console (F12).');
        }
      }

      let inner = `
        <div class="overlay show" style="display:flex">
          <div class="modal" style="max-width:860px;width:min(860px,100%);">
            <div class="modalHead">
              <div>
                <div style="font-weight:900;font-size:1.2rem">Karameloo • Beta</div>
                <div class="hint">Confirmação, pagamento e chat (demo)</div>
              </div>
              <button class="xBtn" id="betaTabCloseBtn" aria-label="Fechar">✕</button>
            </div>

            <div class="card" style="padding:14px;border-radius:16px">
              <div class="pill" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between">
                <span><b>Status:</b> ${statusLabel}</span>
                <span><b>Total:</b> ${totalText}</span>
                <span><b>Entrega:</b> ${eta}</span>
              </div>

              <div style="display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top:12px">
                <div class="pill" style="padding:12px 14px">
                  <div style="font-weight:900">Resumo do pedido</div>
                  <div style="margin-top:6px"><b>Serviço:</b> ${title}</div>
                  ${itemsBlock || `<div class="hint" style="margin-top:8px">Itens do pacote: —</div>`}
                </div>

                <div class="pill" style="padding:12px 14px">
                  <div style="font-weight:900">Sobre o editor</div>
                  <div style="margin-top:6px"><b>Nome:</b> ${editorName}</div>
                  <div style="margin-top:6px"><b>Avaliação:</b> ${rating}/10</div>
                  ${tagsBlock}
                </div>
              </div>
      `;

      if(step === 'confirm'){
        inner += `
          <h3 style="margin:14px 0 8px 0">Confirmar</h3>
          <p class="hint" style="margin-top:0">Agora escolha: pagar agora ou falar com o editor.</p>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn" type="button" id="betaPayNowBtn">Pagar agora</button>
            <button class="btn secondary" type="button" id="betaTalkBtn">Falar com o editor</button>
            <button class="btn secondary" type="button" id="betaOpenProfileBtn">Ver perfil do editor</button>
          </div>
        `;
      } else if(step === 'pay'){
        inner += `
          <h3 style="margin:14px 0 8px 0">Pagamento • PIX (demo)</h3>
          <p class="hint" style="margin-top:0">No beta o pagamento é simulado para testar o fluxo.</p>

          <div class="card" style="background:rgba(0,0,0,.25);border-radius:14px;padding:14px;margin-top:10px">
            <div style="font-weight:800">Chave PIX (demo)</div>
            <div style="margin-top:6px;word-break:break-all;opacity:.95">karameloo@pix.demo</div>
            <div class="hint" style="margin-top:8px">Depois de “pagar” (simulado), clique em confirmar.</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
            <button class="btn" type="button" id="betaPaidBtn">Já paguei (confirmar)</button>
            <button class="btn secondary" type="button" id="betaBackConfirmBtn">Voltar</button>
          </div>
        `;
      } else {
        inner += `
          <h3 style="margin:14px 0 8px 0">Pagamento confirmado ✅</h3>
          <p class="hint" style="margin-top:0">Agora você já pode falar com o editor.</p>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
            <button class="btn" type="button" id="betaOpenChatBtn">Abrir chat</button>
            <button class="btn secondary" type="button" id="betaViewOrderBtn">Ver resumo</button>
          </div>
        `;
      }

      inner += `
            </div>
          </div>
        </div>
      `;

      root.innerHTML = inner;

      // handlers
      const closeBtn = document.getElementById('betaTabCloseBtn');
      const exitBeta = ()=>{
        try{
          document.body.classList.remove('betaTabMode');
          const r = document.getElementById('betaTabRoot');
          if(r) r.innerHTML = '';
          const base = window.location.href.split('#')[0];
          history.replaceState(null, '', base);
        }catch(e){}
      };
      if(closeBtn) closeBtn.onclick = exitBeta;

      if(step === 'confirm'){
        const payNow = document.getElementById('betaPayNowBtn');
        const talk = document.getElementById('betaTalkBtn');
        const openProfile = document.getElementById('betaOpenProfileBtn');

        if(payNow) payNow.onclick = ()=>{
          const stored = ensurePersisted('AWAITING_PAYMENT');
          location.hash = '#beta_pay=' + encodeURIComponent(stored.id);
        };

        if(talk) talk.onclick = ()=>{
          const stored = ensurePersisted('DRAFT');
          openChatForOrder(stored);
        };

        if(openProfile) openProfile.onclick = ()=>{
          try{
            // usa o perfil do editor (se existir na base em memória), senão só não faz nada
            openEditorProfile(order.editor?.id);
          }catch(e){}
        };
      }

      if(step === 'pay'){
        const paid = document.getElementById('betaPaidBtn');
        const back = document.getElementById('betaBackConfirmBtn');
        if(back){
          back.onclick = ()=>{
            // volta para o resumo/confirm do pedido
            if(order.id) location.hash = '#beta_confirm=' + encodeURIComponent(order.id);
            else location.hash = '#beta_preview=' + encodeURIComponent(encodeBetaPayload(order));
          };
        }
        if(paid) paid.onclick = ()=>{
          const stored = ensurePersisted('AWAITING_PAYMENT');
          stored.status = 'PAID';
          stored.paidAt = new Date().toISOString();
          upsertOrder(stored);
          location.hash = '#beta_done=' + encodeURIComponent(stored.id);
        };
      }

      if(step === 'done'){
        const openChatBtn = document.getElementById('betaOpenChatBtn');
        const viewOrderBtn = document.getElementById('betaViewOrderBtn');
        if(openChatBtn) openChatBtn.onclick = ()=>{
          const stored = ensurePersisted(order.status || 'PAID');
          openChatForOrder(stored);
        };
        if(viewOrderBtn) viewOrderBtn.onclick = ()=>{
          if(order.id) location.hash = '#beta_confirm=' + encodeURIComponent(order.id);
        };
      }
    }

    function handleBetaHashRoutes(){
      const h = String(location.hash||'');

      // Preview (abre ao selecionar o editor) — não depende de localStorage (evita aba vazia no file://)
      const mPrev = h.match(/^#beta_preview=([\w%.-]+)/);
      if(mPrev){
        const enc = decodeURIComponent(mPrev[1]||'');
        const p = decodeBetaPayload(enc) || {};
        const order = {
          id: null,
          kind: p.kind || 'package',
          packageId: p.packageId || null,
          title: p.title || 'Pedido',
          total: Number(p.total||0),
          totalText: p.totalText || brl(Number(p.total||0)),
          eta: p.eta || '—',
          items: Array.isArray(p.items) ? p.items : [],
          editor: p.editor || { id:'', name:'—', rating:START_STARS, tags:[] },
          status: 'PREVIEW',
          _preview: true
        };
        renderBetaTabUI(order, 'confirm');
        return true;
      }

      const match = h.match(/^#beta_(confirm|pay|done)=([\w%.-]+)/);
      if(!match) return false;
      const step = match[1];
      const id = decodeURIComponent(match[2]||'');
      let order = null;
      try{ order = getOrderById(id); }catch(e){ order = null; }
      if(!order){
        renderBetaTabUI({ id, title:'Pedido não encontrado', total:0, totalText: brl(0), eta:'—', items:[], editor:{name:'—',rating:START_STARS,tags:[]} }, 'confirm');
        return true;
      }
      if(step === 'confirm') renderBetaTabUI(order, 'confirm');
      if(step === 'pay') renderBetaTabUI(order, 'pay');
      if(step === 'done') renderBetaTabUI(order, 'done');
      return true;
    }

    window.addEventListener('hashchange', ()=>{ try{ handleBetaHashRoutes(); }catch(e){} });

    // Chama no load também (para quando abrir a nova aba)
    setTimeout(()=>{ try{ handleBetaHashRoutes(); }catch(e){} }, 0);


    // ===== Cadastro (modal) =====
    function buildClientDefaults(){
      return {
        first:'Cliente', last:'', full:'Cliente',
        stars: START_STARS,
        photo:'',
        cover:{preset:'none', img:''},
        whats:'', city:'', niche:'', mainPlatform:'instagram', about:'',
        cpf:'', email:'', dob:''
      };
    }
    function buildEditorDefaults(){
      return {
        first:'Editor', last:'', full:'Editor',
        stars: START_STARS,
        photo:'',
        cover:{preset:'none', img:''},
        available:false,
        xp:'iniciante', whats:'', bio:'', soft:'', portfolio:'', tags:[],
        done:0, status:'Novo', packages:[],
        cpf:'', email:'', dob:''
      };
    }

    function saveAccount(kind, account){
      const acc = getAccounts();
      acc[kind] = acc[kind] || {};
      acc[kind][normEmail(account.email)] = account;
      setAccounts(acc);
    }

    function loadAccount(kind, email){
      const acc = getAccounts();
      return acc?.[kind]?.[normEmail(email)] || null;
    }

    function applyAccountToSession(kind, account){
      if(kind === 'client'){
        clientData = account.profile;
        lsSet(LS_CLIENT, clientData);
        paintClientProfile();
        paintClientTop();
      }else{
        editorData = account.profile;
        lsSet(LS_EDITOR, editorData);
        paintEditor();
      }
    }

    btnCadastrar?.addEventListener('click', async ()=>{
      const nome=(inNome?.value||'').trim();
      const sobrenome=(inSobrenome?.value||'').trim();
      const dob=(inData?.value||'').trim();
      const cpfRaw=(inCPF?.value||'').trim();
      const cpfD=cpfDigits(cpfRaw);
      const email=(inEmail?.value||'').trim();
      const senha=(inSenha?.value||'').trim();
      const senha2=(inSenha2?.value||'').trim();

      if(!senha2){ alert('Confirme sua senha.'); return; }
      if(senha2 !== senha){ alert('As senhas não conferem. Confira e tente novamente.'); return; }

      // QUICK ADMIN (demo): digite apenas "adm" em Nome OU Sobrenome para entrar no painel ADM
      const __admQuick = (/^adm$/i.test(nome) || /^adm$/i.test(sobrenome) || /^admin$/i.test(nome) || /^admin$/i.test(sobrenome));
      if(__admQuick){
        showLoading('Abrindo painel ADM…','Entrando como administrador');
        try{
          localStorage.setItem("karameloo_user_name","ADM");
          localStorage.setItem("karameloo_user_role","admin");
          sessionStorage.setItem("karameloo_force_admin","1");
        }catch(e){}
        try{ if(typeof closeCadastro === "function") closeCadastro(); }catch(e){}
        try{
          if(typeof window.openAdminDashboard === "function"){
            window.openAdminDashboard();
          }else if(typeof boot === "function"){
            boot();
          }
        }catch(e){}
        try{ window.scrollTo({top:0, behavior:"smooth"}); }catch(e){}
        return;
      }

      // Se Supabase estiver ativo, cadastro real (aparece em Authentication → Users)
      if(SUPABASE_ENABLED){
        try{
          showLoading('Entrando…','Verificando sua conta');
          // validações básicas (mantém as mesmas do modo local)
          if(!nome||!sobrenome){ alert('Preencha Nome e Sobrenome.'); return; }
          if(!dob){ alert('Preencha a data de nascimento.'); return; }
          if(!email){ alert('Preencha o email.'); return; }
          if(!senha || senha.length < 6){ alert('Crie uma senha (mínimo 6 caracteres).'); return; }
          if(!isValidCPF(cpfD)){ alert('CPF inválido.'); return; }
          if(role === 'editor'){
            const age = calcAge(dob);
            if(!(age >= 18)){
              alert('Para ser Editor/Vendedor, você precisa ter 18+ (regra do projeto).');
              return;
            }
          }

          showLoading('Criando conta…','Validando e salvando');


          const eKey = normEmail(email);


          const r = await supaRegisterFlow({ nome, sobrenome, dob, cpfD, email: eKey, senha, roleUi: role });
          if(!r?.ok){ hideLoading(); return; }

          closeCadastro();

          // Mantém sua UI atual (sem reescrever tudo): salva um perfil local para navegar nas telas
          if(role==='cliente'){
            ensureClientData(nome, sobrenome);
            clientData.cpf = cpfD;
            clientData.email = eKey;
            clientData.dob = dob;
            clientData.stars = START_STARS;
            lsSet(LS_CLIENT, clientData);
            paintClientProfile();
            paintClientTop();
            setActiveSession('cliente');
            goProcurar(true);
            setTimeout(runPostLoginIntent, 80);
          hideLoading();
      }else{
            ensureEditorData(nome, sobrenome);
            editorData.cpf = cpfD;
            editorData.email = eKey;
            editorData.dob = dob;
            editorData.stars = START_STARS;
            lsSet(LS_EDITOR, editorData);
            paintEditor();
            setActiveSession('editor');
            showScreen(screenEditor, true);
        hideLoading();
      }
          hideLoading();
          hideLoading();

          return;
        }catch(err){
          hideLoading();
          const msg = (err && err.message) ? err.message : String(err);
          // Mensagens comuns
          if(/User already registered/i.test(msg) || /already registered/i.test(msg)){
            alert('Esse email já está cadastrado. Use "Já tenho conta" para entrar.');
          }else if(/duplicate key value/i.test(msg) || /cpf_hash/i.test(msg)){
            alert('Esse CPF já está cadastrado.');
          }else{
            alert('Erro no cadastro: ' + msg);
          }
          return;
        }
      }


      // Atalho ADM (testes)
      if(String(nome).trim().toLowerCase() === 'adm'){
        closeCadastro();
        if(role==='cliente'){
          clientData = buildClientDefaults();
          clientData.first = 'ADM';
          clientData.full = 'ADM';
          lsSet(LS_CLIENT, clientData);
          paintClientProfile();
          setActiveSession('cliente');
        goProcurar(true);
        setTimeout(runPostLoginIntent, 80);
        hideLoading();
      }else{
          editorData = buildEditorDefaults();
          editorData.first = 'ADM';
          editorData.full = 'ADM';
          lsSet(LS_EDITOR, editorData);
          paintEditor();
          setActiveSession('editor');
          showScreen(screenEditor, true);
        }
        hideLoading();
        return;
      }

      if(!nome||!sobrenome){ alert('Preencha Nome e Sobrenome.'); return; }
      if(!dob){ alert('Preencha a data de nascimento.'); return; }
      if(!email){ alert('Preencha o email.'); return; }
      if(!senha || senha.length < 4){ alert('Crie uma senha (mínimo 4 caracteres).'); return; }
      if(!isValidCPF(cpfD)){ alert('CPF inválido.'); return; }

      if(role === 'editor'){
        const age = calcAge(dob);
        if(!(age >= 18)){
          alert('Para ser Editor precisa ter 18+.\nMenores: somente no futuro com autorização dos pais e foto do RG (backend).');
          return;
        }
      }

      const kind = roleKey(); // client | editor
      const acc = getAccounts();
      acc[kind] = acc[kind] || {};

      const eKey = normEmail(email);
      if(acc[kind][eKey]){
        alert('Esse email já está cadastrado. Clique em "Já tenho conta" para entrar.');
        return;
      }

      const existingEmail = findEmailByCPF(kind, cpfD);
      if(existingEmail){
        alert('Esse CPF já está cadastrado nessa modalidade de conta.\nUse "Já tenho conta" para entrar.');
        return;
      }
      showLoading('Criando conta…','Preparando seu perfil');
      closeCadastro();

      if(role==='cliente'){
        ensureClientData(nome, sobrenome);
        clientData.cpf = cpfD;
        clientData.email = eKey;
        clientData.dob = dob;
        clientData.stars = START_STARS;
        lsSet(LS_CLIENT, clientData);

        saveAccount('client', { email:eKey, pass:senha, cpf:cpfD, profile: clientData });

        paintClientProfile();
        setActiveSession('cliente');
        goProcurar(true);
        setTimeout(runPostLoginIntent, 80);
        hideLoading();
      }else{
        ensureEditorData(nome, sobrenome);
        editorData.cpf = cpfD;
        editorData.email = eKey;
        editorData.dob = dob;
        editorData.stars = START_STARS;
        lsSet(LS_EDITOR, editorData);

        saveAccount('editor', { email:eKey, pass:senha, cpf:cpfD, profile: editorData });

        paintEditor();
        setActiveSession('editor');
        showScreen(screenEditor, true);
        hideLoading();
      }
    });

    btnLogin?.addEventListener('click', async ()=>{
      const email=(loginEmail?.value||'').trim();
      const senha=(loginSenha?.value||'').trim();

      // Se Supabase estiver ativo, login real
      if(SUPABASE_ENABLED){
        try{
          const eKey = normEmail(email);
          const r = await supaLoginFlow({ email: eKey, senha });

          // Se não tiver profile ainda, cria um mínimo com base na tela (cliente/editor)
          const roleValue = (role === 'cliente') ? 'client' : 'editor';
          const displayName = r?.profile?.display_name || (eKey.split('@')[0] || 'Usuário');
          if(!r?.profile){
            await supaEnsureProfileAndCpf({ userId: r.userId, displayName, roleValue, cpfDigitsOnly: null });
          }

          closeCadastro();

          // Mantém a navegação atual com perfil local (até a gente integrar tudo com banco)
          if(role === 'cliente'){
            const parts = String(displayName).split(' ');
            ensureClientData(parts[0] || displayName, parts.slice(1).join(' ') || '');
            clientData.email = eKey;
            clientData.stars = START_STARS;
            lsSet(LS_CLIENT, clientData);
            paintClientProfile();
            paintClientTop();
            setActiveSession('cliente');
            goProcurar(true);
            setTimeout(runPostLoginIntent, 80);
          }else{
            const parts = String(displayName).split(' ');
            ensureEditorData(parts[0] || displayName, parts.slice(1).join(' ') || '');
            editorData.email = eKey;
            editorData.stars = START_STARS;
            lsSet(LS_EDITOR, editorData);
            paintEditor();
            setActiveSession('editor');
            showScreen(screenEditor, true);
          }
        hideLoading();
        return;
        }catch(err){
          hideLoading();
          const msg = (err && err.message) ? err.message : String(err);
          alert('Erro no login: ' + msg);
          return;
        }
      }

      if(!email || !senha){
        alert('Preencha email e senha.');
        return;
      }

      showLoading('Entrando…','Carregando sua área');

      // Atalho ADM (testes): se o usuário digitar "adm" no email ou na senha,
      // pulamos a validação de contas e entramos diretamente como ADM.
      if(String(email).trim().toLowerCase() === 'adm' || String(senha).trim().toLowerCase() === 'adm'){
        closeCadastro();
        if(role === 'cliente'){
          // cria perfil de cliente ADM e navega para o perfil do cliente
          clientData = buildClientDefaults();
          clientData.first = 'ADM';
          clientData.full  = 'ADM';
          lsSet(LS_CLIENT, clientData);
          paintClientProfile();
          paintClientTop();
          goProcurar(true);
        }else{
          // cria perfil de editor ADM e navega para o dashboard do editor
          editorData = buildEditorDefaults();
          editorData.first = 'ADM';
          editorData.full  = 'ADM';
          lsSet(LS_EDITOR, editorData);
          paintEditor();
          setActiveSession('editor');
          showScreen(screenEditor, true);
        }
        hideLoading();
        return;
      }

      const kind = roleKey();
      const account = loadAccount(kind, email);
      if(!account || account.pass !== senha){
        hideLoading();
        alert('Email ou senha incorretos (demo).');
        return;
      }

      closeCadastro();
      applyAccountToSession(kind, account);
      if(role==='cliente') setActiveSession('cliente');
      else setActiveSession('editor');

      if(role==='cliente') goProcurar(true);
      else showScreen(screenEditor, true);
    hideLoading();
    });

    // ===== IA Karameloo (demo local — Cliente + Editor + novos usuários) =====
    const aiFab = document.getElementById('aiFab');
    const aiPanel = document.getElementById('aiPanel');
    const aiClose = document.getElementById('aiClose');
    const aiMsgs = document.getElementById('aiMsgs');
    const aiForm = document.getElementById('aiForm');
    const aiInput = document.getElementById('aiInput');
    const aiChips = document.getElementById('aiChips');

    const AI_INTRO_KEY = 'karamelo_ai_intro_v1';

    function aiAdd(text, me=false){
      if(!aiMsgs) return;
      const div = document.createElement('div');
      div.className = 'aiMsg' + (me ? ' me' : '');
      div.innerHTML = escapeHtml(String(text||'')).replace(/\n/g,'<br>');
      aiMsgs.appendChild(div);
      aiMsgs.scrollTop = aiMsgs.scrollHeight;
    }

    function aiGetScreen(){
      if(screenEditor?.classList.contains('show')) return 'editor';
      if(screenClientProfile?.classList.contains('show')) return 'cliente_perfil';
      if(screenClient?.classList.contains('show')) return 'cliente';
      if(screenPickEditor?.classList.contains('show')) return 'escolha_editor';
      return 'start';
    }

    function aiSuggestPackages(){
      // dica simples baseada em quantidade (se o usuário estiver no personalizado)
      const fotos = parseInt(document.getElementById('custFotos')?.value || '0', 10) || 0;
      const vids  = parseInt(document.getElementById('custVideos')?.value || '0', 10) || 0;
      if(fotos === 0 && vids === 0){
        return 'Para começar rápido: “Starter Foto” (1 foto) ou “Vídeo Short 15s”.\nSe você já sabe quantas fotos/vídeos quer, use o Personalizado e eu te ajudo a montar.';
      }
      if(vids > 0 && fotos === 0){
        return `Você colocou ${vids} vídeo(s). Dica: escolha o tipo (15s/45s/60s) e marque extras como Legendas/Cor cine.\nSe quiser rapidez, deixe sem extras e sem Urgente.`;
      }
      if(fotos > 0 && vids === 0){
        return `Você colocou ${fotos} foto(s). Dica: marque Retoque avançado se for produto/beleza.\nSe for só ajuste, deixe sem extras para ficar mais barato.`;
      }
      return `Você colocou ${fotos} foto(s) e ${vids} vídeo(s). Dica: use “Combo Social” se quer algo pronto, ou finalize no Personalizado com extras só no que precisa.`;
    }

    function aiHelp(topic){
      const where = aiGetScreen();
      if(topic === 'novo'){
        aiAdd('Bem-vindo(a) à Karameloo! ✨\n\n• Se você quer comprar edição: clique em “Sou Cliente” → Criar conta → preencha o perfil → escolha um pacote ou o Personalizado.\n• Se você quer trabalhar: clique em “Quero Trabalhar” → Criar conta → complete o perfil → selecione até 10 pacotes → ative “Disponível”.');
        return;
      }
      if(topic === 'cliente'){
        aiAdd('Modo Cliente ✅\n\n1) Crie sua conta e complete o perfil.\n2) Escolha um pacote pronto ou monte o Personalizado.\n3) Depois, selecione um editor compatível (demo).\n\nSe quiser, me diga “quantas fotos e vídeos” e eu sugiro o melhor caminho.');
        if(where === 'cliente' || where === 'cliente_perfil') aiAdd('Dica: no Personalizado, marque só os extras essenciais (ex: Legendas + Cor cine) para não encarecer demais.');
        return;
      }
      if(topic === 'editor'){
        aiAdd('Modo Editor ✅\n\n1) Complete seu perfil (bio curta + softwares + tags).\n2) Selecione os pacotes que você aceita (limite: 10).\n3) Ative “Disponível” para aparecer para clientes.\n4) Portfólio: até 30 fotos e 10 vídeos (demo).');
        aiAdd('Sugestão de bio: “Cortes rápidos + cor cinematográfica + áudio limpo. Reels/TikTok. Entrega rápida.”');
        return;
      }
      if(topic === 'pacotes'){
        aiAdd(aiSuggestPackages());
        return;
      }
      if(topic === 'bio'){
        aiAdd('Bio/Tags (Editor) ✍️\n\nBio curta (1–2 linhas) + 4–8 tags.\nExemplo tags: Reels, TikTok, Legendas, Cor cine, Áudio, Foto pro.\n\nSe você me disser seu estilo, eu monto uma bio pronta.');
        return;
      }
    }

    function aiOpen(){
      if(!aiPanel) return;
      aiPanel.classList.add('show');
      aiPanel.classList.remove('pop'); void aiPanel.offsetHeight; aiPanel.classList.add('pop');
      aiPanel.setAttribute('aria-hidden','false');
      if(aiMsgs && aiMsgs.childElementCount === 0){
        aiHelp('novo');
      }
      document.getElementById('aiInput')?.focus();
    }
    function aiClosePanel(){
      aiPanel?.classList.remove('show');
      aiPanel?.setAttribute('aria-hidden','true');
    }

    function aiReply(userText){
      const t = String(userText||'').toLowerCase();
      if(t.includes('primeiro') || t.includes('começar') || t.includes('novo')) return aiHelp('novo');
      if(t.includes('cliente') || t.includes('comprar') || t.includes('pedido')) return aiHelp('cliente');
      if(t.includes('editor') || t.includes('trabalhar') || t.includes('portfólio') || t.includes('portfolio')) return aiHelp('editor');
      if(t.includes('pacote') || t.includes('preço') || t.includes('personalizado') || t.includes('fotos') || t.includes('vídeos') || t.includes('videos')) return aiHelp('pacotes');
      if(t.includes('bio') || t.includes('tag')) return aiHelp('bio');
      aiAdd('Entendi! Me diga se você é Cliente ou Editor e o que você quer fazer agora (ex: “quero 3 vídeos de 15s com legenda”).');
    }

    aiFab?.addEventListener('click', ()=>{
      try{ aiFab.classList.remove('kick'); void aiFab.offsetHeight; aiFab.classList.add('kick'); }catch(e){}
      if(aiPanel?.classList.contains('show')) aiClosePanel();
      else aiOpen();
    });
    aiClose?.addEventListener('click', aiClosePanel);

    aiChips?.addEventListener('click', (e)=>{
      const btn = e.target?.closest('button[data-ai]');
      if(!btn) return;
      aiHelp(String(btn.getAttribute('data-ai')||''));
    });

    aiForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const msg = String(aiInput?.value || '').trim();
      if(!msg) return;
      aiAdd(msg, true);
      aiInput.value = '';
      setTimeout(()=> aiReply(msg), 120);
    });

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', ()=>{
      // Portfolio inputs
      const edWorkPhotos = document.getElementById('edWorkPhotos');
      const edWorkVideos = document.getElementById('edWorkVideos');
      edWorkPhotos?.addEventListener('change', (e)=>{ addFilesToWork('photo', e.target.files); });
      edWorkVideos?.addEventListener('change', (e)=>{ addFilesToWork('video', e.target.files); });
      updateWorkUI();

      // Clamp inputs numéricos (evita digitar infinito)
      const cf = document.getElementById('custFotos');
      const cv = document.getElementById('custVideos');
      cf?.addEventListener('input', ()=>{ cf.value = String(clampInt(cf.value,0,999)); });
      cv?.addEventListener('input', ()=>{ cv.value = String(clampInt(cv.value,0,999)); });

      // WhatsApp: só números + ()- e espaço
      const telFix = (el)=>{
        if(!el) return;
        el.addEventListener('input', ()=>{
          el.value = String(el.value||'').replace(/[^0-9()\-\s+]/g,'').slice(0,15);
        });
      };
      telFix(document.getElementById('clWhats'));
      telFix(document.getElementById('edWhats'));

      clientData = lsGet(LS_CLIENT, clientData);
      editorData = lsGet(LS_EDITOR, editorData);

      // pinta estado se já tiver algo salvo
      if(clientData){ paintClientProfile(); paintClientTop(); }
      if(editorData){ paintEditor(); }

      calcCustom();

      // Restaura a última tela/seleções (beta) para não voltar do início ao recarregar
      try{ setTimeout(()=>{ uiRestore(); }, 60); }catch(e){}

      // IA: abre automaticamente 1x para quem nunca entrou (somente se não estiver com modal aberto)
      try{
        if(!localStorage.getItem(AI_INTRO_KEY)){
          setTimeout(()=>{
            if(!overlay?.classList.contains('show')) aiOpen();
            localStorage.setItem(AI_INTRO_KEY,'1');
          }, 700);
        }
      }catch(e){}
    });

  </script>

<section id="admDashboard" class="admDash">
  <div class="admGrid">
    <aside class="admSide">
      <div class="admBrand">
        <div class="logoBox">K</div>
        <div>
          <div class="t1">Dashboard</div>
          <div class="t2">Admin • Karameloo</div>
        </div>
      </div>

      <div class="admNav">
        <div class="item active" id="admNav_overview" onclick="admNav('overview')">
          <div class="ic">🏠</div><div>Overview</div>
        </div>
        <div class="item" id="admNav_users" onclick="admNav('users')">
          <div class="ic">👥</div><div>Users</div>
        </div>
        <div class="item" id="admNav_orders" onclick="admNav('orders')">
          <div class="ic">🧾</div><div>Orders</div>
        </div>
        <div class="item" id="admNav_analytics" onclick="admNav('analytics')">
          <div class="ic">📈</div><div>Analytics</div>
        </div>
        <div class="item" id="admNav_editors" onclick="admNav('editors')">
          <div class="ic">🎬</div><div>Editors</div>
        </div>
        <div class="item" id="admNav_settings" onclick="admNav('settings')">
          <div class="ic">⚙️</div><div>Settings</div>
        </div>
      </div>

      <div class="mini">
        <b>Modo demo/local</b><br/>
        KPIs e listas puxam do LocalStorage por enquanto.<br/>
        Depois conectamos no Supabase (backend).
      </div>
    </aside>

    <main class="admMain">
      <div class="admTop">
        <h2 id="admTitleTop">Overview</h2>
        <div class="right">
          <span class="admBadge">⭐ Admin</span>
          <button class="admBtn" onclick="admSeedDemo()">Gerar demo</button>
          <button class="admBtn primary" onclick="admExportJson()">Exportar</button>
          <button class="admBtn danger" onclick="closeAdminDashboard()">Sair</button>
        </div>
      </div>

      <div class="admCards">
        <div class="admCard">
          <div class="lab">💰 Total recebido</div>
          <div class="val" id="admKpiRevenue">R$ 0,00</div>
          <div class="sub" id="admKpiRevenueSub">Pagos confirmados</div>
          <div class="pill" id="admKpiRevenuePill">+0 hoje</div>
        </div>
        <div class="admCard">
          <div class="lab">👤 Usuários ativos</div>
          <div class="val" id="admKpiActive">0</div>
          <div class="sub">Não banidos</div>
          <div class="pill" id="admKpiNewUsers">+0 novos</div>
        </div>
        <div class="admCard">
          <div class="lab">🚫 Banimentos</div>
          <div class="val" id="admKpiBans">0</div>
          <div class="sub">Bloqueados</div>
          <div class="pill" id="admKpiReports">0 reports</div>
        </div>
        <div class="admCard">
          <div class="lab">📦 Pedidos</div>
          <div class="val" id="admKpiOrders">0</div>
          <div class="sub">Total (local)</div>
          <div class="pill" id="admKpiPending">0 pendentes</div>
        </div>
      </div>

      <div class="admLayout">
        <section class="admPanel" id="admPanelLeft">
          <h3>Recent Orders</h3>
          <table class="admTable">
            <thead>
              <tr>
                <th>Order</th>
                <th>Client</th>
                <th>Total</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="admOrdersBody"></tbody>
          </table>
          <div class="admNote">Dica: marcar como “Pago” aumenta o total recebido.</div>
        </section>

        <section class="admPanel" id="admPanelRight">
          <h3>Sales Analytics</h3>
          <div style="display:grid;gap:10px">
            <div class="admCard" style="margin:0">
              <div class="lab">📈 Receita (7d)</div>
              <div class="val" id="adm7dRevenue">R$ 0,00</div>
              <div class="sub">Comparativo simples (demo)</div>
            </div>
            <div class="admCard" style="margin:0">
              <div class="lab">🎯 Conversões</div>
              <div class="val" id="admConv">0%</div>
              <div class="sub">Pedidos pagos / pedidos totais</div>
            </div>
            <div class="admCard" style="margin:0">
              <div class="lab">🎬 Editores verificados</div>
              <div class="val" id="admVerified">0</div>
              <div class="sub">Selo do admin (demo)</div>
            </div>
          </div>
        </section>
      </div>

      <!-- Hidden tabs content -->
      <div id="admTab_users" style="display:none;margin-top:12px" class="admPanel">
        <h3>Users</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px">
          <input id="admUserSearch" placeholder="Buscar usuário..." style="padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#e5e7eb;min-width:240px" oninput="admRenderUsers()"/>
          <select id="admUserFilter" style="padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#e5e7eb;min-width:180px" onchange="admRenderUsers()">
            <option value="all">Todos</option>
            <option value="editor">Editores</option>
            <option value="cliente">Clientes</option>
            <option value="banned">Banidos</option>
          </select>
        </div>
        <table class="admTable">
          <thead>
            <tr><th>User</th><th>Type</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody id="admUsersBody"></tbody>
        </table>
      </div>

      <div id="admTab_orders" style="display:none;margin-top:12px" class="admPanel">
        <h3>Orders</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px">
          <input id="admOrderSearch" placeholder="Buscar pedido..." style="padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#e5e7eb;min-width:240px" oninput="admRenderOrders()"/>
          <select id="admOrderFilter" style="padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#e5e7eb;min-width:180px" onchange="admRenderOrders()">
            <option value="all">Todos</option>
            <option value="paid">Pagos</option>
            <option value="pending">Pendentes</option>
          </select>
        </div>
        <table class="admTable">
          <thead>
            <tr><th>Order</th><th>Client</th><th>Total</th><th>Status</th><th>Action</th></tr>
          </thead>
          <tbody id="admOrdersAllBody"></tbody>
        </table>
      </div>

      
      <div id="admTab_analytics" style="display:none;margin-top:12px" class="admPanel">
        <h3>Analytics</h3>
        <div class="admNote">Gráficos essenciais (demo/local). Depois conectamos ao Supabase (backend).</div>

        <div class="admChartGrid">
          <div class="admChartCard">
            <div class="admChartHead">
              <b>Receita (7 dias)</b>
              <span class="admChartMeta" id="admChartRevenueMeta"></span>
            </div>
            <canvas id="admChartRevenue" width="700" height="190"></canvas>
          </div>

          <div class="admChartCard">
            <div class="admChartHead">
              <b>Pedidos (7 dias)</b>
              <span class="admChartMeta" id="admChartOrdersMeta"></span>
            </div>
            <canvas id="admChartOrders" width="700" height="190"></canvas>
          </div>

          <div class="admChartCard">
            <div class="admChartHead">
              <b>Status dos pedidos</b>
              <span class="admChartMeta" id="admChartStatusMeta"></span>
            </div>
            <canvas id="admChartStatus" width="420" height="220"></canvas>
          </div>

          <div class="admChartCard">
            <div class="admChartHead">
              <b>Novos usuários (7 dias)</b>
              <span class="admChartMeta" id="admChartUsersMeta"></span>
            </div>
            <canvas id="admChartUsers" width="700" height="190"></canvas>
          </div>
        </div>
      </div>


<div id="admTab_editors" style="display:none;margin-top:12px" class="admPanel">
        <h3>Editors</h3>
        <div class="admNote">Marque verificado para destacar editores confiáveis (demo/local).</div>
        <table class="admTable">
          <thead>
            <tr><th>Editor</th><th>Status</th><th>Verified</th><th>Action</th></tr>
          </thead>
          <tbody id="admEditorsBody"></tbody>
        </table>
      </div>

      <div id="admTab_settings" style="display:none;margin-top:12px" class="admPanel">
        <h3>Settings</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <div class="admStatus pending">Comissão Karameloo: <b id="admCommissionLabel" style="margin-left:6px">19%</b></div>
          <input id="admCommissionInput" value="19" style="padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#e5e7eb;min-width:140px" />
          <button class="admBtn primary" onclick="admSaveSettings()">Salvar</button>
        </div>
        <div class="admNote">Essas configs viram reais quando conectarmos no backend.</div>
      </div>

    </main>
  </div>
</section>


<script id="admDashLogic">
(function(){
  const LS_KEY = "karameloo_admin_data_v1";
  const LS_SETTINGS = "karameloo_admin_settings_v1";

  function moneyBRL(n){
    try{
      return (Number(n||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    }catch(e){return "R$ " + (n||0);}
  }

  function getData(){
    let d;
    try{ d = JSON.parse(localStorage.getItem(LS_KEY)||""); }catch(e){ d=null; }
    if(!d || typeof d!=="object"){
      d = { users:[], orders:[], reports:0, updatedAt: Date.now() };
    }
    return d;
  }
  function setData(d){ localStorage.setItem(LS_KEY, JSON.stringify(d)); }

  function getSettings(){
    let s;
    try{ s = JSON.parse(localStorage.getItem(LS_SETTINGS)||""); }catch(e){ s=null; }
    if(!s || typeof s!=="object") s = { commission: 19 };
    return s;
  }
  function setSettings(s){ localStorage.setItem(LS_SETTINGS, JSON.stringify(s)); }

  function isAdmin(){
    // Admin rule (demo): if name contains 'adm' OR exact 'admin'
    const name =
      (window.currentUser?.name) ||
      (window.user?.name) ||
      (window.__USER?.name) ||
      (localStorage.getItem("karameloo_user_name")) ||
      "";
    return /(^|\b)adm(\b|$)/i.test(String(name)) || /^admin$/i.test(String(name));
  }

  function hideNonAdminSections(){
    // Hide common sections if they exist
    const ids = ["loginGate","loginCard","authGate","homeGate","marketShell","exploreShell","clientShell","editorShell","mainApp","app"];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display="none"; });
    // Also hide big hero sections heuristically
    document.querySelectorAll("section, main, .section, .page").forEach(el=>{
      if(el.id==="admDashboard") return;
    });
  }

  function showAdminDashboard(){
    const dash = document.getElementById("admDashboard");
    if(!dash) return;
    dash.style.display = "block";
    window.scrollTo({top:0, behavior:"smooth"});
    admNav("overview");
    admRefresh();
  }

  // NAV
  window.admNav = function(tab){
    ["overview","users","orders","analytics","editors","settings"].forEach(t=>{
      const nav=document.getElementById("admNav_"+t);
      if(nav) nav.classList.toggle("active", t===tab);
    });

    document.getElementById("admPanelLeft").style.display = (tab==="overview") ? "" : "none";
    document.getElementById("admPanelRight").style.display = (tab==="overview") ? "" : "none";

    const tabs = ["users","orders","analytics","editors","settings"];
    tabs.forEach(t=>{
      const el=document.getElementById("admTab_"+t);
      if(el) el.style.display = (tab===t) ? "" : "none";
    });

    const title = document.getElementById("admTitleTop");
    if(title) title.textContent = tab.charAt(0).toUpperCase()+tab.slice(1);
    if(tab==="analytics") setTimeout(()=>admRenderAnalytics(), 40);
  };

  // Seed demo
  window.admSeedDemo = function(){
    const d = getData();
    if(d.users.length || d.orders.length){
      // don't duplicate; just add a few more
    }
    const baseUsers = [
      {id:"u1", name:"Kauan", email:"kauan@email.com", type:"cliente", banned:false, verified:false, createdAt:Date.now()-86400000*6},
      {id:"u2", name:"João Editor", email:"joao@edit.com", type:"editor", banned:false, verified:true, createdAt:Date.now()-86400000*5},
      {id:"u3", name:"Maria", email:"maria@email.com", type:"cliente", banned:false, verified:false, createdAt:Date.now()-86400000*3},
      {id:"u4", name:"Pedro Editor", email:"pedro@edit.com", type:"editor", banned:false, verified:false, createdAt:Date.now()-86400000*2},
      {id:"u5", name:"Spammer", email:"spam@x.com", type:"cliente", banned:true, verified:false, createdAt:Date.now()-86400000*1},
    ];
    const baseOrders = [
      {id:"o1", title:"Reels Loja de Roupas", client:"Maria", total:79.9, status:"paid", createdAt:Date.now()-86400000*4},
      {id:"o2", title:"Shorts Gameplay", client:"Kauan", total:49.9, status:"pending", createdAt:Date.now()-86400000*2},
      {id:"o3", title:"Fotos Instagram (Cine)", client:"Maria", total:27.4, status:"paid", createdAt:Date.now()-86400000*1},
      {id:"o4", title:"Legendas + Ajuste Áudio", client:"Kauan", total:39.9, status:"pending", createdAt:Date.now()-3600000*14},
    ];
    // Merge unique by id
    const uMap = new Map(d.users.map(u=>[u.id,u]));
    baseUsers.forEach(u=>{ if(!uMap.has(u.id)) uMap.set(u.id,u); });
    d.users = Array.from(uMap.values());

    const oMap = new Map(d.orders.map(o=>[o.id,o]));
    baseOrders.forEach(o=>{ if(!oMap.has(o.id)) oMap.set(o.id,o); });
    d.orders = Array.from(oMap.values());

    d.reports = d.reports || 3;
    d.updatedAt = Date.now();
    setData(d);
    admRefresh();
    alert("Dados demo gerados ✅");
  };

  window.admExportJson = function(){
    const d = getData();
    const blob = new Blob([JSON.stringify(d,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "karameloo_admin_export.json";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };

  function calc7dRevenue(d){
    const now = Date.now();
    const weekAgo = now - 86400000*7;
    return d.orders.filter(o=>o.status==="paid" && (o.createdAt||0)>=weekAgo).reduce((s,o)=>s+Number(o.total||0),0);
  }

  function renderKPIs(){
    const d = getData();
    const revenue = d.orders.filter(o=>o.status==="paid").reduce((s,o)=>s+Number(o.total||0),0);
    const pending = d.orders.filter(o=>o.status!=="paid").length;
    const active = d.users.filter(u=>!u.banned).length;
    const bans = d.users.filter(u=>u.banned).length;
    const verified = d.users.filter(u=>u.type==="editor" && u.verified).length;
    const revenue7d = calc7dRevenue(d);
    const conv = d.orders.length ? Math.round((d.orders.filter(o=>o.status==="paid").length / d.orders.length)*100) : 0;

    document.getElementById("admKpiRevenue").textContent = moneyBRL(revenue);
    document.getElementById("admKpiActive").textContent = String(active);
    document.getElementById("admKpiBans").textContent = String(bans);
    document.getElementById("admKpiOrders").textContent = String(d.orders.length);
    document.getElementById("admKpiPending").textContent = String(pending) + " pendentes";
    document.getElementById("adm7dRevenue").textContent = moneyBRL(revenue7d);
    document.getElementById("admConv").textContent = String(conv) + "%";
    document.getElementById("admVerified").textContent = String(verified);
    document.getElementById("admKpiReports").textContent = String(d.reports||0) + " reports";

    // "today" pill (demo): payments in last 24h
    const last24 = Date.now()-86400000;
    const today = d.orders.filter(o=>o.status==="paid" && (o.createdAt||0)>=last24).reduce((s,o)=>s+Number(o.total||0),0);
    document.getElementById("admKpiRevenuePill").textContent = (today>0?"+":"") + moneyBRL(today) + " (24h)";
    const newUsers = d.users.filter(u=>(u.createdAt||0)>=last24).length;
    document.getElementById("admKpiNewUsers").textContent = "+"+newUsers+" novos (24h)";

    // settings
    const s = getSettings();
    const lab = document.getElementById("admCommissionLabel");
    if(lab) lab.textContent = String((s.commission ?? 19)) + "%";
    const inp = document.getElementById("admCommissionInput");
    if(inp) inp.value = String((s.commission ?? 19));
  }

  function orderRow(o, full){
    const status = o.status==="paid" ? "ok" : "pending";
    const statusText = o.status==="paid" ? "Paid" : "Pending";
    const action = `
      <div class="admAct">
        ${o.status==="paid"
          ? `<button onclick="admMarkPending('${o.id}')">Marcar pendente</button>`
          : `<button class="ok" onclick="admMarkPaid('${o.id}')">Marcar pago</button>`
        }
        <button class="danger" onclick="admDeleteOrder('${o.id}')">Excluir</button>
      </div>`;
    return `<tr>
      <td><b>${escapeHtml(o.title||"Pedido")}</b><div style="font-size:12px;color:rgba(229,231,235,.65)">${escapeHtml(o.id||"")}</div></td>
      <td>${escapeHtml(o.client||"-")}</td>
      <td>${moneyBRL(o.total||0)}</td>
      <td><span class="admStatus ${status}">${statusText}</span></td>
      <td>${action}</td>
    </tr>`;
  }

  function userRow(u, kind){
    const status = u.banned ? "pending" : "ok";
    const stText = u.banned ? "Banned" : "Active";
    const verified = (u.type==="editor" && u.verified) ? "✅" : "—";
    const actions = `
      <div class="admAct">
        ${u.banned
          ? `<button class="ok" onclick="admUnban('${u.id}')">Desbanir</button>`
          : `<button class="danger" onclick="admBan('${u.id}')">Banir</button>`
        }
        ${u.type==="editor"
          ? (u.verified
              ? `<button onclick="admUnverify('${u.id}')">Remover selo</button>`
              : `<button class="ok" onclick="admVerify('${u.id}')">Verificar</button>`
            )
          : `<button onclick="admPromoteEditor('${u.id}')">Tornar editor</button>`
        }
      </div>`;
    return `<tr>
      <td><b>${escapeHtml(u.name||"Usuário")}</b><div style="font-size:12px;color:rgba(229,231,235,.65)">${escapeHtml(u.email||"")}</div></td>
      <td>${escapeHtml(u.type||"-")}</td>
      <td><span class="admStatus ${status}">${stText}</span></td>
      <td>${actions}</td>
    </tr>`;
  }

  function editorRow(u){
    const st = u.banned ? "pending" : "ok";
    const stText = u.banned ? "Banned" : "Active";
    const ver = u.verified ? "Yes" : "No";
    const actions = `
      <div class="admAct">
        ${u.verified
          ? `<button onclick="admUnverify('${u.id}')">Remover selo</button>`
          : `<button class="ok" onclick="admVerify('${u.id}')">Verificar</button>`
        }
        ${u.banned
          ? `<button class="ok" onclick="admUnban('${u.id}')">Desbanir</button>`
          : `<button class="danger" onclick="admBan('${u.id}')">Banir</button>`
        }
      </div>`;
    return `<tr>
      <td><b>${escapeHtml(u.name||"Editor")}</b><div style="font-size:12px;color:rgba(229,231,235,.65)">${escapeHtml(u.email||"")}</div></td>
      <td><span class="admStatus ${st}">${stText}</span></td>
      <td>${ver}</td>
      <td>${actions}</td>
    </tr>`;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  window.admRefresh = function(){
    renderKPIs();
    admRenderOrders();
    admRenderUsers();
    admRenderEditors();
    admRenderAnalytics();
  
  // Analytics (charts)
  window.admRenderAnalytics = function(){
    try{
      const d = getData();
      const now = new Date();
      const dayMs = 24*60*60*1000;
      const days = 7;

      // build day buckets (local time, midnight)
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const start = new Date(end.getTime() - (days-1)*dayMs);

      const labels = [];
      const revenue = Array(days).fill(0);
      const orders = Array(days).fill(0);
      const newUsers = Array(days).fill(0);

      function idxFor(ts){
        if(!ts) return -1;
        const t = new Date(ts);
        const dd = new Date(t.getFullYear(), t.getMonth(), t.getDate());
        const i = Math.round((dd.getTime() - start.getTime())/dayMs);
        return (i>=0 && i<days) ? i : -1;
      }

      for(let i=0;i<days;i++){
        const dt = new Date(start.getTime() + i*dayMs);
        labels.push(dt.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}));
      }

      // Orders aggregation
      let paidCount=0, pendingCount=0, otherCount=0;
      let paidTotal=0;
      (d.orders||[]).forEach(o=>{
        const i = idxFor(o.createdAt||o.created_at||o.ts);
        if(i>-1) orders[i] += 1;

        const st = (o.status||"").toLowerCase();
        const raw = (o.total!=null ? o.total : (o.amount!=null ? o.amount : 0));
        const val = (typeof raw==="number") ? raw : (parseFloat(String(raw).replace(/[^\d,.-]/g,"").replace(",", "."))||0);

        if(st==="paid" || st==="pago"){
          paidCount += 1;
          paidTotal += val;
          const j = idxFor(o.createdAt||o.created_at||o.ts);
          if(j>-1) revenue[j] += val;
        } else if(st==="pending" || st==="pendente"){
          pendingCount += 1;
        } else {
          otherCount += 1;
        }
      });

      // Users aggregation
      (d.users||[]).forEach(u=>{
        const i = idxFor(u.createdAt||u.created_at||u.ts);
        if(i>-1) newUsers[i] += 1;
      });

      // Update metas
      const setMeta = (id, text)=>{ const el=document.getElementById(id); if(el) el.textContent=text; };
      setMeta("admChartRevenueMeta", `Total: ${moneyBR(paidTotal)} • pagos: ${paidCount}`);
      setMeta("admChartOrdersMeta", `Total: ${(d.orders||[]).length} • 7d: ${orders.reduce((a,b)=>a+b,0)}`);
      setMeta("admChartStatusMeta", `Pago: ${paidCount} • Pendente: ${pendingCount} • Outros: ${otherCount}`);
      setMeta("admChartUsersMeta", `Total: ${(d.users||[]).length} • 7d: ${newUsers.reduce((a,b)=>a+b,0)}`);

      // Draw
      drawLineChart("admChartRevenue", labels, revenue, {money:true});
      drawBarChart("admChartOrders", labels, orders);
      drawDonutChart("admChartStatus", [
        {label:"Pago", value:paidCount},
        {label:"Pendente", value:pendingCount},
        {label:"Outros", value:otherCount},
      ]);
      drawLineChart("admChartUsers", labels, newUsers, {money:false});
    }catch(e){
      console.log("admRenderAnalytics error", e);
    }
  };

  function _prepCanvas(canvas){
    if(!canvas) return null;
    const ctx = canvas.getContext("2d");
    if(!ctx) return null;
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const w = canvas.getAttribute("width") ? parseInt(canvas.getAttribute("width"),10) : canvas.clientWidth;
    const h = canvas.getAttribute("height") ? parseInt(canvas.getAttribute("height"),10) : canvas.clientHeight;
    canvas.style.width = "100%";
    canvas.style.height = "auto";
    canvas.width = Math.round(w * dpr);
    canvas.height = Math.round(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx,w,h};
  }

  function drawLineChart(id, labels, values, opts){
    const canvas = document.getElementById(id);
    const p = _prepCanvas(canvas); if(!p) return;
    const {ctx,w,h} = p;

    ctx.clearRect(0,0,w,h);

    const padL=34, padR=10, padT=12, padB=26;
    const cw = w - padL - padR;
    const ch = h - padT - padB;

    const maxV = Math.max(1, ...values);
    const minV = Math.min(0, ...values);
    const span = Math.max(1e-9, maxV-minV);

    // grid
    ctx.strokeStyle = "rgba(255,255,255,.06)";
    ctx.lineWidth = 1;
    for(let i=0;i<=3;i++){
      const y = padT + (ch*i/3);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+cw,y); ctx.stroke();
    }

    // line
    ctx.strokeStyle = "rgba(246,196,0,.95)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    values.forEach((v,i)=>{
      const x = padL + (cw*(values.length===1?0:i/(values.length-1)));
      const y = padT + ch*(1-((v-minV)/span));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle = "rgba(246,196,0,.95)";
    values.forEach((v,i)=>{
      const x = padL + (cw*(values.length===1?0:i/(values.length-1)));
      const y = padT + ch*(1-((v-minV)/span));
      ctx.beginPath(); ctx.arc(x,y,2.6,0,Math.PI*2); ctx.fill();
    });

    // labels (start / mid / end)
    ctx.fillStyle = "rgba(229,231,235,.62)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const pts = [0, Math.floor((labels.length-1)/2), labels.length-1].filter((v,i,a)=>a.indexOf(v)===i);
    pts.forEach(i=>{
      const x = padL + (cw*(labels.length===1?0:i/(labels.length-1)));
      const t = labels[i] || "";
      const tw = ctx.measureText(t).width;
      ctx.fillText(t, Math.min(padL+cw-tw, Math.max(padL, x - tw/2)), padT+ch+18);
    });

    // y top label
    const top = (opts && opts.money) ? moneyBR(maxV) : String(maxV);
    ctx.fillText(top, 10, padT+10);
  }

  function drawBarChart(id, labels, values){
    const canvas = document.getElementById(id);
    const p = _prepCanvas(canvas); if(!p) return;
    const {ctx,w,h} = p;
    ctx.clearRect(0,0,w,h);

    const padL=34, padR=10, padT=12, padB=26;
    const cw = w - padL - padR;
    const ch = h - padT - padB;

    const maxV = Math.max(1, ...values);

    // grid
    ctx.strokeStyle = "rgba(255,255,255,.06)";
    ctx.lineWidth = 1;
    for(let i=0;i<=3;i++){
      const y = padT + (ch*i/3);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+cw,y); ctx.stroke();
    }

    const n = values.length;
    const gap = 6;
    const bw = (cw - gap*(n-1)) / n;

    values.forEach((v,i)=>{
      const x = padL + i*(bw+gap);
      const bh = (v/maxV)*ch;
      const y = padT + (ch - bh);

      // bar
      ctx.fillStyle = "rgba(246,196,0,.30)";
      ctx.fillRect(x,y,bw,bh);

      // cap
      ctx.fillStyle = "rgba(246,196,0,.85)";
      ctx.fillRect(x,y, bw, Math.max(2, Math.min(6, bh)));
    });

    // labels
    ctx.fillStyle = "rgba(229,231,235,.62)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const pts = [0, Math.floor((labels.length-1)/2), labels.length-1].filter((v,i,a)=>a.indexOf(v)===i);
    pts.forEach(i=>{
      const x = padL + i*(bw+gap) + bw/2;
      const t = labels[i] || "";
      const tw = ctx.measureText(t).width;
      ctx.fillText(t, Math.min(padL+cw-tw, Math.max(padL, x - tw/2)), padT+ch+18);
    });

    ctx.fillText(String(maxV), 10, padT+10);
  }

  function drawDonutChart(id, items){
    const canvas = document.getElementById(id);
    const p = _prepCanvas(canvas); if(!p) return;
    const {ctx,w,h} = p;
    ctx.clearRect(0,0,w,h);

    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.33;
    const r2 = r*0.62;

    const total = items.reduce((a,b)=>a+(b.value||0),0) || 1;

    const palette = [
      "rgba(246,196,0,.88)",
      "rgba(255,255,255,.45)",
      "rgba(255,255,255,.20)"
    ];

    let ang = -Math.PI/2;
    items.forEach((it,idx)=>{
      const frac = (it.value||0)/total;
      const a2 = ang + frac*(Math.PI*2);

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,ang,a2);
      ctx.closePath();
      ctx.fillStyle = palette[idx%palette.length];
      ctx.fill();

      ang = a2;
    });

    // hole
    ctx.globalCompositeOperation = "destination-out";
    ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = "source-over";

    // legend
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(229,231,235,.72)";
    const x0 = 12, y0 = 14;
    items.forEach((it,idx)=>{
      const y = y0 + idx*18;
      ctx.fillStyle = palette[idx%palette.length];
      ctx.fillRect(x0, y-10, 10, 10);
      ctx.fillStyle = "rgba(229,231,235,.72)";
      ctx.fillText(`${it.label}: ${it.value||0}`, x0+16, y-1);
    });

    // center text
    ctx.fillStyle = "rgba(229,231,235,.82)";
    ctx.font = "bold 18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const t = String(items.reduce((a,b)=>a+(b.value||0),0));
    const tw = ctx.measureText(t).width;
    ctx.fillText(t, cx - tw/2, cy + 6);
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "rgba(229,231,235,.55)";
    const t2 = "pedidos";
    const tw2 = ctx.measureText(t2).width;
    ctx.fillText(t2, cx - tw2/2, cy + 24);
  }


  };

  window.admRenderOrders = function(){
    const d = getData();
    const q = (document.getElementById("admOrderSearch")?.value||"").toLowerCase();
    const f = (document.getElementById("admOrderFilter")?.value||"all");
    let orders = [...d.orders].sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    if(q){
      orders = orders.filter(o => (o.title||"").toLowerCase().includes(q) || (o.client||"").toLowerCase().includes(q));
    }
    if(f==="paid") orders = orders.filter(o=>o.status==="paid");
    if(f==="pending") orders = orders.filter(o=>o.status!=="paid");

    const tbodyAll = document.getElementById("admOrdersAllBody");
    if(tbodyAll) tbodyAll.innerHTML = orders.map(o=>orderRow(o,true)).join("") || `<tr><td colspan="5" style="padding:10px;color:rgba(229,231,235,.7)">Sem pedidos.</td></tr>`;

    const tbody = document.getElementById("admOrdersBody");
    if(tbody){
      const recent = orders.slice(0,5);
      tbody.innerHTML = recent.map(o=>orderRow(o,false)).join("") || `<tr><td colspan="5" style="padding:10px;color:rgba(229,231,235,.7)">Sem pedidos.</td></tr>`;
    }
    renderKPIs();
  };

  window.admRenderUsers = function(){
    const d = getData();
    const q = (document.getElementById("admUserSearch")?.value||"").toLowerCase();
    const f = (document.getElementById("admUserFilter")?.value||"all");
    let users = [...d.users].sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    if(q){
      users = users.filter(u => (u.name||"").toLowerCase().includes(q) || (u.email||"").toLowerCase().includes(q));
    }
    if(f==="editor") users = users.filter(u=>u.type==="editor");
    if(f==="cliente") users = users.filter(u=>u.type!=="editor");
    if(f==="banned") users = users.filter(u=>u.banned);

    const tbody = document.getElementById("admUsersBody");
    if(tbody) tbody.innerHTML = users.map(u=>userRow(u)).join("") || `<tr><td colspan="4" style="padding:10px;color:rgba(229,231,235,.7)">Sem usuários.</td></tr>`;
    renderKPIs();
  };

  window.admRenderEditors = function(){
    const d = getData();
    const editors = d.users.filter(u=>u.type==="editor").sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    const tbody = document.getElementById("admEditorsBody");
    if(tbody) tbody.innerHTML = editors.map(e=>editorRow(e)).join("") || `<tr><td colspan="4" style="padding:10px;color:rgba(229,231,235,.7)">Sem editores.</td></tr>`;
    renderKPIs();
  };

  // actions
  function updateUser(id, patch){
    const d = getData();
    const u = d.users.find(x=>String(x.id)===String(id));
    if(!u) return;
    Object.assign(u, patch);
    d.updatedAt = Date.now();
    setData(d);
    admRefresh();
  }
  function updateOrder(id, patch){
    const d = getData();
    const o = d.orders.find(x=>String(x.id)===String(id));
    if(!o) return;
    Object.assign(o, patch);
    d.updatedAt = Date.now();
    setData(d);
    admRefresh();
  }
  window.admBan = (id)=>updateUser(id,{banned:true});
  window.admUnban = (id)=>updateUser(id,{banned:false});
  window.admVerify = (id)=>updateUser(id,{verified:true});
  window.admUnverify = (id)=>updateUser(id,{verified:false});
  window.admPromoteEditor = (id)=>updateUser(id,{type:"editor", verified:false});

  window.admMarkPaid = (id)=>updateOrder(id,{status:"paid"});
  window.admMarkPending = (id)=>updateOrder(id,{status:"pending"});
  window.admDeleteOrder = (id)=>{
    const d = getData();
    d.orders = d.orders.filter(o=>String(o.id)!==String(id));
    d.updatedAt = Date.now();
    setData(d);
    admRefresh();
  };

  window.admSaveSettings = ()=>{
    const inp = document.getElementById("admCommissionInput");
    const v = Math.max(0, Math.min(100, parseFloat(inp?.value||"25")));
    const s = getSettings();
    s.commission = isFinite(v)?v:25;
    setSettings(s);
    admRefresh();
    alert("Configurações salvas ✅");
  };

  // Boot: show ADM if admin is logged (or if localStorage flag exists)
  function boot(){
    const force = (sessionStorage.getItem('karameloo_force_admin')==='1');
    if(force){
      const page = document.querySelector('.page');
      if(page) page.style.display = 'none';

      // Esconde qualquer modal/overlay de cadastro/login que esteja aberto
      try{
        const __m = document.getElementById('modal') || document.getElementById('cadastroModal');
        if(__m) __m.classList.remove('show');
        const ov = document.getElementById('overlay');
        if(ov) ov.classList.remove('show');
      }catch(e){}

      const dash = document.getElementById('admDashboard');
      if(dash){
        dash.style.display = 'block';
        dash.style.visibility = 'visible';
      }

      document.body.classList.add('adm-open');
      // Garante que o dashboard apareça no topo (sem precisar rolar)
      window.scrollTo({ top: 0, left: 0, behavior: 'instant' });
      return;
    }

    // modo normal (não-ADM)
    document.body.classList.remove('adm-open');
    const page = document.querySelector('.page');
    if(page) page.style.display = '';
    const dash = document.getElementById('admDashboard');
    if(dash){
      dash.style.display = 'none';
      dash.style.visibility = 'hidden';
    }
  }

  // expose manual open for debugging
  window.openAdminDashboard = function(){
    showLoading('Abrindo painel ADM…','Carregando dashboard');
    sessionStorage.setItem('karameloo_force_admin','1');
    boot();
    setTimeout(hideLoading, 650);
  };

  window.closeAdminDashboard = function(){
    showLoading('Saindo do ADM…','Voltando para o site');
    sessionStorage.removeItem('karameloo_force_admin');
    boot();
    // volta para o topo/entrada
    window.scrollTo({ top: 0, left: 0, behavior: 'instant' });
    setTimeout(hideLoading, 450);
  };

  // run boot now and on hash change
  setTimeout(()=>{ try{ initTierToggle(); }catch(e){} }, 20);
  setTimeout(boot, 50);
})();
</script>


<script>

(() => {
  // ---------- Background stars generation (dawn but still stars) ----------
  const bgStars = document.querySelector(".bgfx-bg-stars");
  if(bgStars){
    const rand = mulberry32(1337);
    let s = "";
    for(let i=0;i<18;i++){
      const x = Math.floor(rand()*1200);
      const y = Math.floor(rand()*360);
      const r = [0.8,1.0,1.2,1.6,2.2][Math.floor(rand()*5)];
      const o = (0.22 + rand()*0.65).toFixed(3);
      s += `<circle cx="${x}" cy="${y}" r="${r}" fill="rgba(255,255,255,${o})"/>`;
    }
    bgStars.innerHTML = s;
  }

  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}

  // ---------- Constellation glow follows pointer ----------
  const svg = document.querySelector(".bgfx-constellations");
  const glow = document.querySelector(".bgfx-star-glow");
  let raf=0, px=0, py=0;
  if(svg && glow){
    function moveGlow(x,y){
      px=x; py=y;
      if(raf) return;
      raf=requestAnimationFrame(()=>{
        glow.style.setProperty("--gx", px+"px");
        glow.style.setProperty("--gy", py+"px");
        raf=0;
      });
    }
    svg.addEventListener("pointermove", (e)=>{
      const r = svg.getBoundingClientRect();
      moveGlow(e.clientX - r.left, e.clientY - r.top);
    }, {passive:true});
  }

  // ---------- Pixel pine renderer (detailed like reference) ----------
  const far = document.getElementById("forestFar");
  const mid = document.getElementById("forestMid");
  const near = document.getElementById("forestNear");
  const ctxF = far.getContext("2d");
  const ctxM = mid.getContext("2d");
  const ctxN = near.getContext("2d");

  // Pixel Sea canvas (entre céu e floresta)
  const sea = document.getElementById("pixelSea");
  const ctxS = sea ? sea.getContext("2d") : null;

  const W = far.width, H = far.height;
  const horizon = Math.floor(H*0.54);
  const baseY = Math.floor(H*0.86);

  const rnd = mulberry32(2029);

  function pxRect(ctx,x,y,w,h,c){
    ctx.fillStyle=c;
    ctx.fillRect(Math.round(x),Math.round(y),Math.round(w),Math.round(h));
  }

  // Pixel pine (stepped branches)
  function drawPine(ctx, x, groundY, h, w, colDark, colMid, colLight, sway=0){
    const trunkH = Math.max(3, Math.floor(h*0.18));
    const canopyH = h - trunkH;

    // trunk (pixel)
    pxRect(ctx, x + w*0.46 + sway, groundY - trunkH, Math.max(1,w*0.10), trunkH, "rgba(16,10,8,.85)");

    // canopy as stepped layers
    const steps = Math.max(6, Math.floor(canopyH/6));
    for(let i=0;i<steps;i++){
      const y = groundY - trunkH - (i+1)*(canopyH/steps);
      const t = i/(steps-1);
      const half = (w*0.5) * (1 - t*0.88);
      const bandH = Math.max(1, Math.floor(canopyH/steps));
      // slight jagged edges
      const jag = ((i%2===0)? 1 : 0);
      const left = x + w*0.5 - half + sway - jag;
      const width = half*2 + jag*2;
      const shade = (t<0.25)? colLight : (t<0.65? colMid : colDark);
      pxRect(ctx, left, y, width, bandH, shade);
      // micro highlights on outer edges
      if(i%3===0){
        pxRect(ctx, left+1, y, 1, bandH, "rgba(255,255,255,.06)");
        pxRect(ctx, left+width-2, y, 1, bandH, "rgba(0,0,0,.08)");
      }
    }

    // top point
    pxRect(ctx, x + w*0.5 + sway, groundY - h, 1, 2, colLight);
  }

  function drawBush(ctx, x, y, s, c1, c2){
    pxRect(ctx, x, y, 8*s, 4*s, c1);
    pxRect(ctx, x+2*s, y-2*s, 6*s, 3*s, c2);
    pxRect(ctx, x+1*s, y+1*s, 6*s, 2*s, c2);
  }

  function clear(ctx){
    ctx.clearRect(0,0,W,H);
  }

  function drawLayer(ctx, palette, density, depthScale, time, swayAmp){
    // base color band (fog)
    // ground strip
    pxRect(ctx, 0, horizon, W, H-horizon, palette.ground);
    // mist band near horizon
    for(let i=0;i<10;i++){
      const a = 0.05 + i*0.015;
      pxRect(ctx, 0, horizon-12+i*2, W, 2, `rgba(255,255,255,${a.toFixed(3)})`);
    }

    // trees
    const count = Math.floor(density * 55);
    for(let i=0;i<count;i++){
      const x = Math.floor(rnd()*W);
      const h = Math.floor((16 + rnd()*44) * depthScale);
      const w = Math.max(8, Math.floor((10 + rnd()*18) * depthScale));
      const y = baseY + Math.floor(rnd()*10);
      const phase = (x/W)*3.2 + i*0.12;
      const sway = Math.sin(time*0.0016 + phase) * swayAmp;
      drawPine(ctx, x, y, h, w, palette.dark, palette.mid, palette.light, sway);
    }

    // bushes / small details near bottom
    const bcount = Math.floor(density*18);
    for(let i=0;i<bcount;i++){
      const x = Math.floor(rnd()*W);
      const y = baseY + Math.floor(rnd()*10);
      const s = 1 + Math.floor(rnd()*2);
      drawBush(ctx, x, y-6*s, s, palette.bush1, palette.bush2);
      // tiny flowers pixels
      if(rnd() > 0.78){
        pxRect(ctx, x+2*s, y-2*s, 1, 1, "rgba(255,90,110,.90)");
        pxRect(ctx, x+4*s, y-3*s, 1, 1, "rgba(255,220,120,.85)");
      }
    }

    // grass line
    for(let x=0;x<W;x+=3){
      const h = 1 + Math.floor(rnd()*3);
      pxRect(ctx, x, baseY - h, 1, h, palette.grass);
    }
  }

  const palettes = {
    far:   {dark:"#0d2a2d", mid:"#134449", light:"#1c6c64", ground:"#061418", bush1:"#174645", bush2:"#1d5f58", grass:"#1a6f63"},
    mid:   {dark:"#0a2734", mid:"#0f3b4c", light:"#1a6f7a", ground:"#061318", bush1:"#15515b", bush2:"#1b6c6d", grass:"#1aa18a"},
    near:  {dark:"#072233", mid:"#0c3550", light:"#1b6c7e", ground:"#061318", bush1:"#2c9e76", bush2:"#40b48b", grass:"#59d19c"},
  };

  // Reset deterministic random every frame (so it doesn't "crawl")
  function resetRng(){
    // just reassign rnd closure by recreating function using same seed
    // (we keep mulberry32 deterministic)
  }

  // We'll pre-generate "tree placements" so sway animates without layout changing
  function makeTreeField(seed, count, depthScale){
    const r = mulberry32(seed);
    const trees=[];
    for(let i=0;i<count;i++){
      const x = Math.floor(r()*W);
      const h = Math.floor((16 + r()*44) * depthScale);
      const w = Math.max(8, Math.floor((10 + r()*18) * depthScale));
      const y = baseY + Math.floor(r()*10);
      const phase = (x/W)*3.2 + i*0.12;
      trees.push({x,y,h,w,phase});
    }
    const bushes=[];
    const bcount = Math.floor((count/55)*18);
    for(let i=0;i<bcount;i++){
      const x = Math.floor(r()*W);
      const y = baseY + Math.floor(r()*10);
      const s = 1 + Math.floor(r()*2);
      const flower = r()>0.78;
      bushes.push({x,y,s,flower,fx: x+2*s, fy:y-2*s, fx2:x+4*s, fy2:y-3*s});
    }
    const grass=[];
    for(let x=0;x<W;x+=3){
      grass.push({x, h: 1 + Math.floor(r()*3)});
    }
    return {trees,bushes,grass};
  }

  const fieldFar = makeTreeField(3101, 52, 0.72);
  const fieldMid = makeTreeField(3102, 64, 0.95);
  const fieldNear= makeTreeField(3103, 78, 1.22);

  function renderField(ctx, field, palette, time, swayAmp){
    // clear
    ctx.clearRect(0,0,W,H);

    // land strip (deixa o mar aparecer acima)
    const landY = baseY - 10;
    pxRect(ctx, 0, landY, W, H-landY, palette.ground);

    // sombra suave acima da terra
    pxRect(ctx, 0, landY-3, W, 3, "rgba(0,0,0,.22)");

    // trees
    for(let i=0;i<field.trees.length;i++){
      const t=field.trees[i];
      const sway = Math.sin(time*0.0017 + t.phase) * swayAmp;
      drawPine(ctx, t.x, t.y, t.h, t.w, palette.dark, palette.mid, palette.light, sway);
    }

    // bushes + flowers
    for(let i=0;i<field.bushes.length;i++){
      const b=field.bushes[i];
      drawBush(ctx, b.x, b.y-6*b.s, b.s, palette.bush1, palette.bush2);
      if(b.flower){
        pxRect(ctx, b.fx, b.fy, 1, 1, "rgba(255,90,110,.90)");
        pxRect(ctx, b.fx2, b.fy2, 1, 1, "rgba(255,220,120,.85)");
      }
    }

    // grass (linha principal)
    for(let i=0;i<field.grass.length;i++){
      const g=field.grass[i];
      pxRect(ctx, g.x, baseY - g.h, 1, g.h, palette.grass);
    }

    // ---------- Foreground fill (grama + flores + sapinho) ----------
    // Só no layer near (para não "poluir" as camadas de trás)
    if(palette === palettes.near){
      // Tapete de graminha pixelada cobrindo o "preto" (do baseY até o fim)
      for(let y=baseY; y<H; y+=2){
        for(let x=0; x<W; x+=2){
          const n = ((x*23 + y*31) % 97) / 97;
          if(n < 0.16){
            pxRect(ctx, x, y, 1, 1, palette.grass);
          }else if(n > 0.92){
            pxRect(ctx, x, y, 1, 1, "rgba(0,0,0,.25)");
          }
        }
      }

      // Tufts (moitinhas) para dar volume
      for(let i=0;i<18;i++){
        const x = (i*37*11) % W;
        const y = baseY + 2 + ((i*19) % Math.max(6, (H-baseY-10)));
        const h = 3 + (i % 5);
        // haste
        pxRect(ctx, x, y, 1, h, palette.grass);
        pxRect(ctx, x+1, y+1, 1, h-1, palette.grass);
        // pontas
        pxRect(ctx, x-1, y, 1, 1, "rgba(255,255,255,.08)");
        pxRect(ctx, x+2, y+1, 1, 1, "rgba(255,255,255,.06)");
      }

      // Flores pixeladas (bem pequenas)
      const flowerColors = [
        "rgba(255,120,150,.95)", // rosa
        "rgba(255,230,120,.95)", // amarelo
        "rgba(160,220,255,.95)", // azul claro
        "rgba(210,170,255,.95)"  // lilás
      ];
      for(let i=0;i<12;i++){
        const fx = (i*53*7 + 31) % (W-8);
        const fy = baseY + 5 + ((i*23) % Math.max(6, (H-baseY-14)));
        const c = flowerColors[i % flowerColors.length];
        // flor 3x3
        pxRect(ctx, fx+1, fy, 1, 1, c);
        pxRect(ctx, fx, fy+1, 1, 1, c);
        pxRect(ctx, fx+1, fy+1, 1, 1, "rgba(255,255,255,.92)");
        pxRect(ctx, fx+2, fy+1, 1, 1, c);
        pxRect(ctx, fx+1, fy+2, 1, 1, c);
        // haste
        pxRect(ctx, fx+1, fy+3, 1, 2, palette.grass);
      }

      // Lagoa pixelada + logo pequena (2 vitórias-régias) — LIMPA (sem pontinhos)
      const pondCX = Math.floor(W*0.46);
      const pondCY = baseY + 24;     // em cima do tapete de grama
      const pondW  = 36;
      const pondH  = 16;

      const waterA = "rgba(18,95,120,.98)";
      const waterB = "rgba(10,60,85,.98)";
      const waterC = "rgba(6,35,55,.98)";
      const edge   = "rgba(0,0,0,.35)";
      const shine  = "rgba(255,255,255,.08)";

      // lagoa (oval pixelado, preenchimento sólido por bandas — cobre qualquer "pontinho" de baixo)
      for(let yy=-pondH; yy<=pondH; yy+=2){
        for(let xx=-pondW; xx<=pondW; xx+=2){
          const nx = xx/pondW;
          const ny = yy/pondH;
          const d = nx*nx + ny*ny;
          if(d <= 1.0){
            const x = pondCX + xx;
            const y = pondCY + yy;

            // degradê suave (3 cores) — sem divisões
            const t = (ny+1)/2; // 0..1 (topo -> baixo)

            // waterA (claro), waterB (médio), waterC (escuro)
            // Interpola A->B até 0.55, depois B->C
            function lerp(a,b,u){ return a + (b-a)*u; }
            const A = [18,95,120];
            const B = [10,60,85];
            const C = [6,35,55];

            let r,g,b;
            if(t <= 0.55){
              const u = t/0.55;
              r = Math.round(lerp(A[0], B[0], u));
              g = Math.round(lerp(A[1], B[1], u));
              b = Math.round(lerp(A[2], B[2], u));
            }else{
              const u = (t-0.55)/(0.45);
              r = Math.round(lerp(B[0], C[0], u));
              g = Math.round(lerp(B[1], C[1], u));
              b = Math.round(lerp(B[2], C[2], u));
            }
            const col = `rgba(${r},${g},${b},.98)`;


            pxRect(ctx, x, y, 2, 2, col);
          }
        }
      }
      // contorno simples (borda) para ficar "logo" bem definida
      for(let xx=-pondW; xx<=pondW; xx+=2){
        const nx = xx/pondW;
        const yyTop = Math.round(-pondH * Math.sqrt(Math.max(0, 1 - nx*nx)));
        const yyBot = Math.round(+pondH * Math.sqrt(Math.max(0, 1 - nx*nx)));
        pxRect(ctx, pondCX+xx, pondCY+yyTop, 2, 2, edge);
        pxRect(ctx, pondCX+xx, pondCY+yyBot, 2, 2, edge);
      }
      // brilho leve na parte superior
      for(let i=0;i<10;i++){
        const x = pondCX - pondW + 4 + i*6;
        const y = pondCY - pondH + 6 + (i%2);
        pxRect(ctx, x, y, 2, 1, shine);
      }

      // Duas vitórias-régias (logo pequena)
      const pad1 = "rgba(70,205,140,.95)";
      const pad2 = "rgba(50,175,120,.95)";
      const pad3 = "rgba(25,110,80,.95)";
      const hl   = "rgba(255,255,255,.12)";

      function lilyPad(x,y,scale=1){
        pxRect(ctx, x+1*scale, y+3*scale, 7*scale, 3*scale, pad2);
        pxRect(ctx, x+2*scale, y+2*scale, 5*scale, 1*scale, pad2);
        pxRect(ctx, x+2*scale, y+1*scale, 5*scale, 1*scale, pad1);
        pxRect(ctx, x+3*scale, y+0*scale, 3*scale, 1*scale, pad1);

        pxRect(ctx, x+1*scale, y+5*scale, 7*scale, 1*scale, pad3);
        pxRect(ctx, x+0*scale, y+4*scale, 1*scale, 2*scale, pad3);
        pxRect(ctx, x+8*scale, y+4*scale, 1*scale, 2*scale, pad3);

        // fenda
        pxRect(ctx, x+4*scale, y+3*scale, 1*scale, 2*scale, "rgba(0,0,0,.28)");

        // highlight
        pxRect(ctx, x+2*scale, y+2*scale, 2*scale, 1*scale, hl);
        pxRect(ctx, x+3*scale, y+1*scale, 2*scale, 1*scale, hl);
      }

      lilyPad(pondCX-16, pondCY-6, 1);
      lilyPad(pondCX-2,  pondCY-10, 1);

      // miolo (florzinha minúscula)
      pxRect(ctx, pondCX-1, pondCY-2, 1, 1, "rgba(255,230,140,.92)");

      // Pedras pixeladas do lado ESQUERDO da logo (em volta)
      const rock1 = "rgba(120,130,145,.92)";
      const rock2 = "rgba(80,90,110,.92)";
      const rock3 = "rgba(45,55,70,.92)";

      function rockCluster(rx, ry){
        // 6x4 blob
        pxRect(ctx, rx+1, ry+1, 4, 2, rock2);
        pxRect(ctx, rx+2, ry+0, 2, 1, rock1);
        pxRect(ctx, rx+0, ry+2, 1, 1, rock3);
        pxRect(ctx, rx+5, ry+2, 1, 1, rock3);
        pxRect(ctx, rx+2, ry+3, 2, 1, rock3);
        pxRect(ctx, rx+3, ry+1, 1, 1, "rgba(255,255,255,.16)");
      }

      rockCluster(pondCX - pondW - 18, pondCY - 6);
      rockCluster(pondCX - pondW - 10, pondCY + 2);
      rockCluster(pondCX - pondW - 22, pondCY + 8);

      // Sapinho pixelado — à direita da lagoa
      const sx = pondCX + pondW + 10;
      const sy = pondCY + 4;

      const g1 = "rgba(110,235,160,.95)";
      const g2 = "rgba(70,190,120,.95)";
      const o  = "rgba(5,10,12,.85)";
      const w  = "rgba(255,255,255,.95)";

      // corpo
      pxRect(ctx, sx+2, sy+4, 8, 4, g2);
      pxRect(ctx, sx+3, sy+3, 6, 1, g2);
      pxRect(ctx, sx+3, sy+5, 6, 2, g1);
      // patinhas
      pxRect(ctx, sx+1, sy+6, 2, 2, g2);
      pxRect(ctx, sx+9, sy+6, 2, 2, g2);
      // cabeça
      pxRect(ctx, sx+3, sy+1, 6, 3, g2);
      pxRect(ctx, sx+4, sy+2, 4, 1, g1);
      // olhos
      pxRect(ctx, sx+3, sy, 2, 2, g2);
      pxRect(ctx, sx+7, sy, 2, 2, g2);
      pxRect(ctx, sx+4, sy+1, 1, 1, w);
      pxRect(ctx, sx+7, sy+1, 1, 1, w);
      pxRect(ctx, sx+5, sy+1, 1, 1, o);
      pxRect(ctx, sx+8, sy+1, 1, 1, o);
      // boquinha
      pxRect(ctx, sx+5, sy+3, 2, 1, o);



      // Vagalumes pixelados (movimento + piscar)
      const baseCount = 22;

      for(let i=0;i<baseCount;i++){
        // posição base determinística
        const bx = (i*47*13 + 19) % (W-18);
        const by = baseY + 4 + ((i*29) % Math.max(10, (H-baseY-22)));

        // movimento suave (drift) — sem ficar louco
        const t1 = time*0.0009 + i*1.37;
        const t2 = time*0.0007 + i*0.91;

        const dx = Math.round(Math.sin(t1) * (3 + (i%3)));   // -6..6
        const dy = Math.round(Math.cos(t2) * (2 + (i%2)));   // -3..3

        const x = bx + dx;
        const y = by + dy;

        // piscar (twinkle)
        const tw = (Math.sin(time*0.0024 + i*1.6) * 0.5 + 0.5); // 0..1
        const a  = (0.10 + tw*0.70).toFixed(3);

        // cor vagalume
        const c  = `rgba(255,230,140,${a})`;

        // pontinho principal
        pxRect(ctx, x, y, 1, 1, c);

        // glow em cruz (sutil)
        const ag = (0.05 + tw*0.22).toFixed(3);
        const cg = `rgba(255,230,140,${ag})`;
        pxRect(ctx, x-1, y, 1, 1, cg);
        pxRect(ctx, x+1, y, 1, 1, cg);
        pxRect(ctx, x, y-1, 1, 1, cg);
        pxRect(ctx, x, y+1, 1, 1, cg);

        // traço curtinho (como rastro bem leve)
        if(tw > 0.72){
          pxRect(ctx, x-2, y+1, 1, 1, `rgba(255,200,120,${(0.05+tw*0.10).toFixed(3)})`);
        }
      }

    }
  }



  // ---------- Pixel Sea renderer (ESTÁTICO: sem animação) ----------
  function renderSea(){
    if(!ctxS) return;
    const S = ctxS;
    S.clearRect(0,0,W,H);

    // Sea occupies from horizon to just above land
    const seaTop = horizon;
    const landY = baseY - 10;
    const seaBottom = landY;

    // Base ocean gradient (bandas pixel)
    for(let y=seaTop; y<seaBottom; y+=2){
      const t = (y-seaTop)/(seaBottom-seaTop);
      const r = Math.floor(6 + t*10);
      const g = Math.floor(18 + t*28);
      const b = Math.floor(34 + t*42);
      S.fillStyle = `rgb(${r},${g},${b})`;
      S.fillRect(0,y,W,2);
    }

    // Horizon mist band (suave)
    for(let i=0;i<7;i++){
      const a = 0.08 + i*0.018;
      S.fillStyle = `rgba(255,220,170,${a.toFixed(3)})`;
      S.fillRect(0, seaTop-6+i, W, 1);
    }

    // Sun reflection column (fixo)
    const cx = Math.floor(W*0.50);
    const colW = 28;

    for(let y=seaTop+8; y<seaBottom; y+=3){
      const t = (y-seaTop)/(seaBottom-seaTop);
      const spread = Math.floor((1-t) * colW + 6);
      const alpha = (0.18*(1-t) + 0.03).toFixed(3);
      const left = cx - spread;
      const width = spread*2;

      for(let x=left; x<left+width; x+=3){
        const n = ((x*19 + y*13) % 17)/17; // determinístico (sem tempo)
        if(n < 0.25 + (1-t)*0.08){
          S.fillStyle = `rgba(255,210,140,${alpha})`;
          S.fillRect(x, y, 2, 1);
        }
      }
    }
    // Depth edges
    S.fillStyle = "rgba(0,0,0,.16)";
    S.fillRect(0, seaTop, 16, seaBottom-seaTop);
    S.fillRect(W-16, seaTop, 16, seaBottom-seaTop);
  }




  function animate(t){
    // mar (entre horizonte e floresta)
    renderSea();

    // sway amplitude stronger near
    renderField(ctxF, fieldFar, palettes.far, t, 0.6);
    renderField(ctxM, fieldMid, palettes.mid, t, 1.1);
    renderField(ctxN, fieldNear, palettes.near, t, 1.8);
    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  // ---------- Pixel Sun (nascer do sol em pixel art) ----------
  const sunCanvas = document.getElementById("pixelSun");
  if(sunCanvas){
    const sctx = sunCanvas.getContext("2d");
    const SW = sunCanvas.width, SH = sunCanvas.height;

    function drawPixelSun(time){
      // Clear
      sctx.clearRect(0,0,SW,SH);

      // Horizon line position (matches visual split around middle of the scene)
      const horizonY = Math.floor(SH * 0.56);

      // Sun params
      const cx = Math.floor(SW * 0.50);
      const cy = Math.floor(SH * 0.62); // slightly below horizon so it "rises"
      const r  = Math.floor(Math.min(SW,SH) * 0.17);

      // Rising animation (subtle)
      const rise = Math.sin(time*0.00025) * 3.0;
      const sunY = cy - rise;

      // Pixel size (bigger = more pixelated)
      const ps = 3;

      // Precompute palette
      const core = [255, 224, 140];
      const mid  = [255, 196, 110];
      const rim  = [255, 160,  90];

      // Draw sun circle in pixels (dither + gradient)
      for(let y=0; y<SH; y+=ps){
        for(let x=0; x<SW; x+=ps){
          const dx = (x + ps*0.5) - cx;
          const dy = (y + ps*0.5) - sunY;
          const d = Math.sqrt(dx*dx + dy*dy);

          // Only draw above a soft horizon mask (so it looks like sunrise)
          // We allow the sun to be partially occluded by the horizon band:
          const occlude = (y > horizonY + 6);

          if(d <= r){
            // Simple radial gradient + a tiny dithering
            const t = d / r; // 0 center -> 1 edge
            const noise = ((x*17 + y*29) % 11) / 11.0; // deterministic
            let rr, gg, bb, a;

            if(t < 0.45){
              rr = core[0]; gg = core[1]; bb = core[2]; a = 0.95;
            }else if(t < 0.78){
              rr = mid[0]; gg = mid[1]; bb = mid[2]; a = 0.85;
            }else{
              rr = rim[0]; gg = rim[1]; bb = rim[2]; a = 0.70;
            }

            // Dither on the edge for a pixel-art vibe
            if(t > 0.70 && noise < 0.25) a *= 0.55;

            // Occlude part of the sun under the horizon (pixel-perfect)
            if(occlude){
              // Keep a few glow pixels to blend with the band
              if(noise < 0.10) a *= 0.25;
              else continue;
            }

            sctx.fillStyle = `rgba(${rr},${gg},${bb},${a})`;
            sctx.fillRect(x, y, ps, ps);
          }
        }
      }

      // Add a subtle pixel glow halo (also pixelated)
      const haloR = r * 2.1;
      for(let y=0; y<SH; y+=ps){
        for(let x=0; x<SW; x+=ps){
          const dx = (x + ps*0.5) - cx;
          const dy = (y + ps*0.5) - sunY;
          const d = Math.sqrt(dx*dx + dy*dy);
          if(d > r && d < haloR){
            const t = (d - r) / (haloR - r);
            const a = (1 - t) * 0.10;
            if(a < 0.01) continue;
            // Keep halo mostly above horizon
            if(y > horizonY + 18) continue;
            sctx.fillStyle = `rgba(255,180,110,${a.toFixed(3)})`;
            sctx.fillRect(x, y, ps, ps);
          }
        }
      }
    }

    // Hook into existing animation loop if present; otherwise animate here.
    // We'll create a lightweight RAF for the sun only.
    function sunLoop(t){
      drawPixelSun(t);
      requestAnimationFrame(sunLoop);
    }
    requestAnimationFrame(sunLoop);
  }
})();

</script>

<script>

/* ==== Login background rotation (no parallax) ==== */
/* =========================
   Fundo aleatório do login (modo claro)
   - Troque/adicone imagens na lista `bgs`.
   - Usa a MESMA imagem do site (variável --site-bg) para manter consistência.
========================= */
(function(){
  function pickLoginBg(){
    try{
      const bgs = [
        "roberto-shumski-tDSTuUjv0DM-unsplash.jpg"
        // quando você mandar mais: "bg2.jpg", "bg3.jpg"
      ];
      if(!bgs.length) return;

      let last = parseInt(localStorage.getItem("karameloo_last_bg")||"-1",10);
      let idx = Math.floor(Math.random()*bgs.length);
      if(bgs.length>1 && idx===last) idx = (idx+1)%bgs.length;
      localStorage.setItem("karameloo_last_bg", String(idx));

      const src = bgs[idx];
      try{ localStorage.setItem('karameloo_bg_light', src); }catch(e){}
      // Fundo global do site (home/editor também)
      document.documentElement.style.setProperty("--site-bg", `url('${src}')`);

      // Fundo do login (preload pra não "piscar")
      const scene = document.querySelector("#screenStart .loginScene");
      if(scene){
        const img = new Image();
        img.onload = () => scene.setAttribute("data-bg-light", src);
        img.onerror = () => scene.setAttribute("data-bg-light", src);
        img.src = src;
      }
    }catch(e){}
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", pickLoginBg);
  }else{
    pickLoginBg();
  }
})();

/* =========================
   Tema (global): troca fundo Claro/Escuro
   - Claro: usa o fundo padrão (roberto-shumski...) ou o que estiver em data-bg-light
   - Escuro: usa a imagem do buraco negro (arquivo no repo). Aceita variações de nome.
========================= */
(function(){
  const root = document.documentElement;
  const scene = document.querySelector('#screenStart .loginScene');
  const toggles = Array.from(document.querySelectorAll('[data-theme-toggle]'));
  const sw = document.getElementById('themeSwitch') || toggles[0] || null;

  // Camadas do login (se existirem)
  const bgLight = scene ? scene.querySelector('.loginBg.bgLight') : null;
  const bgDark  = scene ? scene.querySelector('.loginBg.bgDark')  : null;

  // Key única (pra valer no site todo)
  const THEME_KEY = 'karameloo_theme';
  const LIGHT_BG_KEY = 'karameloo_bg_light';

  // Descobre o fundo claro
  const lightUrl =
    (scene && (scene.getAttribute('data-bg-light') || '').trim()) ||
    (localStorage.getItem(LIGHT_BG_KEY) || '').trim() ||
    'roberto-shumski-tDSTuUjv0DM-unsplash.jpg';

  // Guarda o fundo claro (pra persistir)
  try{ localStorage.setItem(LIGHT_BG_KEY, lightUrl); }catch(e){}

  // Alguns nomes possíveis do arquivo escuro (você pode renomear depois; o 1º que existir é usado pelo CSS)
  const darkCandidates = [
    'bg-darkjpg',         // (como está no seu print)
    'bg-dark.jpg',
    'bg-dark.jpeg',
    'bg-dark.png',
    'bg-dark.webp',
    'bg-dark'
  ];

  function cssMultiUrl(list){
    return list.map(s => `url('${s}')`).join(', ');
  }

  // Define os backgrounds das camadas do login
  if(bgLight) bgLight.style.backgroundImage = `url('${lightUrl}')`;
  if(bgDark)  bgDark.style.backgroundImage  = cssMultiUrl(darkCandidates);

  // Define o background global do site (usado nos screens)
  function setSiteBg(isDark){
    if(isDark){
      root.style.setProperty('--site-bg', cssMultiUrl(darkCandidates));
    }else{
      root.style.setProperty('--site-bg', `url('${lightUrl}')`);
    }
  }

  function apply(isDark){
    // Classe para ajustes finos via CSS (se já existir no seu CSS, reaproveita)
    if(scene) scene.classList.toggle('theme-dark', isDark);
    root.classList.toggle('theme-dark', isDark);

    setSiteBg(isDark);

    try{ localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light'); }catch(e){}
  }

  // Estado inicial: começa sempre no CLARO
  const initialDark = false;

  // Sincroniza toggles
  toggles.forEach(t => { try{ t.checked = initialDark; }catch(e){} });
  if(sw){ try{ sw.checked = initialDark; }catch(e){} }

  // Aplica
  apply(initialDark);

  // Escuta mudanças
  toggles.forEach(t => t.addEventListener('change', () => {
    const isDark = !!t.checked;
    // Mantém todos sincronizados
    toggles.forEach(x => { if(x!==t) x.checked = isDark; });
    if(sw && sw!==t) sw.checked = isDark;
    apply(isDark);
  }));
  if(sw && !toggles.includes(sw)){
    sw.addEventListener('change', () => apply(!!sw.checked));
  }
})();

/* ==== Safety bindings for Home Auth buttons (prevents "nothing happens") ==== */
(function(){
  function safeShowScreen(id){
    try{
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('show'));
      const el = document.getElementById(id);
      if(el){ el.classList.add('show'); window.scrollTo(0,0); }
    }catch(e){}
  }
  function safeSetAuthMode(mode){
    try{
      const title = document.getElementById('titleCadastro');
      const vReg = document.getElementById('viewRegister');
      const vLog = document.getElementById('viewLogin');
      if(title) title.textContent = (mode === 'login') ? 'Fazer login' : 'Criar conta';
      if(vReg) vReg.classList.toggle('active', mode !== 'login');
      if(vLog) vLog.classList.toggle('active', mode === 'login');
    }catch(e){}
  }
  function safeOpenAuth(mode, role){
    try{
      const rolePicker = document.getElementById('rolePicker');
      if(rolePicker){
        rolePicker.querySelectorAll('.roleBtn').forEach(b=>{
          b.classList.toggle('active', b.dataset.role === (role||'cliente'));
        });
      }
      safeShowScreen('screenAuth');
      safeSetAuthMode(mode === 'login' ? 'login' : 'register');
    }catch(e){}
  }

  if(typeof window.openAuth !== 'function'){
    window.openAuth = function(mode, role){ safeOpenAuth(mode, role); };
  }
  if(typeof window.closeCadastro !== 'function'){
    window.closeCadastro = function(){ safeShowScreen('screenStart'); };
  }

  function bind(){
    const b1 = document.getElementById('homeLoginBtn');
    const b2 = document.getElementById('homeRegisterBtn');
    if(b1){
      b1.addEventListener('click', (e)=>{
        e.preventDefault();
        try{ window.openAuth('login','cliente'); }catch(err){ safeOpenAuth('login','cliente'); }
      }, {passive:false});
    }
    if(b2){
      b2.addEventListener('click', (e)=>{
        e.preventDefault();
        try{ window.openAuth('register','cliente'); }catch(err){ safeOpenAuth('register','cliente'); }
      }, {passive:false});
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
</script>


  <!-- Chat flutuante (acesso rápido em qualquer tela) -->
  <div class="chatFab" id="chatFab" title="Abrir chat">
    💬
    <div class="badge" id="chatFabBadge">1</div>
  </div>


<script>
/* ===== START BG ROTATION + PRELOAD (sem parallax) ===== */
(function(){
  const scene = document.querySelector('#screenStart .loginScene');
  if(!scene) return;

  // Liste aqui os fundos. Você pode subir as imagens na mesma pasta do index.html.
  const bgs = [
    scene.getAttribute('data-bg') || 'roberto-shumski-tDSTuUjv0DM-unsplash.jpg',
    'bg-login.jpg',
    'bg1.jpg'
  ].filter(Boolean);

  function tryLoad(src){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve({ok:true, src});
      img.onerror = () => resolve({ok:false, src});
      img.src = src;
    });
  }

  async function pickWorkingBackground(){
    // escolhe aleatório, mas testa alguns caminhos comuns (./ e assets/)
    const shuffled = bgs.slice().sort(() => Math.random()-0.5);
    const candidates = [];
    for(const s of shuffled){
      candidates.push(s);
      if(!s.startsWith('./')) candidates.push('./'+s);
      candidates.push('assets/'+s);
      candidates.push('img/'+s);
    }
    // remove duplicados
    const seen = new Set();
    const unique = candidates.filter(c => (seen.has(c) ? false : (seen.add(c), true)));

    for(const cand of unique){
      const r = await tryLoad(cand);
      if(r.ok) return r.src;
    }
    return null;
  }

  (async ()=>{
    const chosen = await pickWorkingBackground();
    if(chosen){
      scene.style.setProperty('--login-bg', `url('${chosen}')`);
      scene.style.backgroundImage = `url('${chosen}')`;
      // melhora a nitidez do fundo sem pesar
      scene.style.backgroundPosition = 'center';
      scene.style.backgroundSize = 'cover';
    }else{
      // se nada carregar, mantém preto (mas sem quebrar a tela)
      scene.style.backgroundColor = '#000';
    }
  })();
})();
</script>


<!-- Dark mode intro animation (upload: dark-intro.mp4) -->
<div id="themeIntro" class="themeIntro" aria-hidden="true">
  <video id="themeIntroVideo" preload="auto" muted playsinline>
    <source src="dark-intro.mp4" type="video/mp4">
  </video>
</div>

</body>
</html>
